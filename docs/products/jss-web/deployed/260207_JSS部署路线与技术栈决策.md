# JSS 部署路线与技术栈决策记录

> **文档类型：** 技术决策 + 部署策略  
> **关联文档：** 260204079_Phase1执行计划.md, 260207_SnapEvidence相机模块技术规格.md  
> **创建时间：** 2026-02-07  
> **决策人：** CEO + CPO  
> **执行优先级：** 🔴 P0 - 立即执行

---

## 📋 核心决策摘要

### 战略决策（3个关键点）

1. **复用LedgerSnap基础架构** - 不重新发明轮子
2. **使用成熟SaaS模板起步** - Vercel Supabase Starter
3. **订阅计费延后到发布前** - 专注核心功能验证

### 部署路线

```
localhost:3001 → dev.jobsitesnap.com → jobsitesnap.com
    ↓                ↓                      ↓
  壳子验收         真实环境              生产发布
```

---

## 🎯 决策1：复用LedgerSnap架构（最重要）

### CEO原话：
> "我们之前在开发ledgersnap的时候已经做了一套，现在直接沿用过来就好了，只不过UI用活力橙"

### CPO评估：✅ 非常正确的决定

**理由：**

#### 1. Auth/Env/Deploy是最容易出阴间bug的部分

**LedgerSnap已经踩过的坑：**
- Supabase Auth redirect
- local / dev / prod env配置
- Vercel部署路径
- cookie / session刷新
- 多tab同步

👉 **这些坑不值得在JSS再踩一遍**

---

#### 2. JSS的差异在"现场使用感"，不在底层

**JSS的真正价值：**
- ✅ 连拍不卡
- ✅ 离线不丢
- ✅ Job不错归

**不是：**
- ❌ 再发明一套登录系统
- ❌ 再设计一套dashboard框架

👉 **底座统一，产品才可控**

---

#### 3. 统一Infra，未来产品像"一家人"

**当你以后有：**
- LedgerSnap
- Jobsite Snap
- SnapPocket

**如果它们：**
- auth一样
- session行为一样
- env模式一样

**那你以后做：**
- SSO（单点登录）
- cross-app deep link（跨应用跳转）
- account / billing统一

**会轻松10倍。**

---

### 可复用模块清单

| 模块 | 复用程度 | 是否可改 |
|------|---------|---------|
| **Auth系统** | 100%复用 | 🚫 禁止改动 |
| **Session管理** | 100%复用 | 🚫 禁止改动 |
| **Route Guard** | 100%复用 | 🚫 禁止改动 |
| **Dashboard Layout** | 100%复用 | ⚠️ 只换颜色 |
| **Env结构** | 100%复用 | 🚫 禁止改动 |
| **多Tab同步** | 100%复用 | 🚫 禁止改动 |

---

### 禁止改动清单（给CTO的铁律）

**以下部分绝对不要"手痒改动"：**

```typescript
// ❌ 禁止改动区域
/lib/auth/*           // Auth逻辑
/middleware.ts        // 路由守卫
/app/api/auth/*       // Auth API
.env.local.example    // 环境变量结构

// ✅ 允许修改区域
/app/theme.ts         // 主题配置
/components/ui/*      // UI组件样式
/app/(routes)/*       // 业务路由
```

---

## 🎨 UI策略：只换活力橙

### 正确做法（Token化主题）

```typescript
// theme.ts
export const theme = {
  brand: {
    primary: '#FF7A00',    // 活力橙
    secondary: '#...',
    accent: '#...'
  },
  // 其他保持不变
}
```

### ❌ 错误做法（复制CSS）

```css
/* ❌ 不要这样做 */
ledgersnap.css
jobsitesnap.css
snappocket.css

/* 3个月后你会后悔 */
```

---

### 最小改动方案

**明确告诉CTO/前端：**

```
✅ Auth / layout / dashboard结构全部复用LedgerSnap
✅ 只换brand color（活力橙）
✅ 不改spacing、不改组件结构
✅ PWA / SnapEvidence在新route下独立做
```

**改动范围：**
1. `theme.ts` - 设置 `brand.primary = 活力橙`
2. Button / active / focus - 使用新token
3. Logo / favicon - 如果已有就换

**不改动：**
- ❌ spacing（边距）
- ❌ grid（栅格）
- ❌ 组件层级
- ❌ 任何layout逻辑

---

## 🚀 决策2：使用Vercel Supabase Starter

### 背景

**CEO问：**
> "现在市面上有没有开源的，成熟的，好看的一整套saas模板，（包括landing, sign up, login logout, dashboard, session......）我们可以直接拿来用的。省的重新发明轮子。"

### CPO推荐：Vercel Supabase Starter

**理由：**

#### ✅ 第一梯队（最推荐）

**技术栈完美匹配：**
- Next.js App Router ✅
- Supabase Auth / Session ✅
- shadcn/ui (Radix + Tailwind) ✅
- Dashboard / Auth / Protected routes齐全 ✅

**优点：**
1. **无缝对接** - 你们LedgerSnap已经用Supabase
2. **UI干净** - 不花哨，但非常SaaS
3. **可控性强** - shadcn是"复制组件到项目"，不被框死
4. **可维护** - 未来深度定制完全扛得住

**缺点：**
- Landing page偏简（但Phase 1根本不需要营销landing）

---

### 为什么不选其他模板

#### ❌ "Landing很炫的SaaS模板"
（Gumroad / ThemeForest上90%）

**问题：**
- landing漂亮，dashboard粗糙
- auth是demo级
- 一改就散架
- 不适合长期产品

👉 **你是做工具，不是卖故事**

---

#### ❌ 全家桶mega模板
（CRM / ERP那种）

**问题：**
- 功能太多
- mental load太重
- 会拖慢JSS Phase 1

---

### 选模板的原则（CPO观点）

**你现在选的不是UI，而是：**
> 未来2-3年你们所有产品的"应用骨架"

**模板必须满足：**
- ✅ Auth / Session是一等公民
- ✅ 路由保护是默认能力
- ✅ 样式是token化的（方便换色）
- ✅ 不和具体业务强耦合

---

## 📦 推荐方案：抽象Internal Template

### 最佳实践

```
internal-saas-template/
├── auth/
├── session/
├── layout/
├── middleware/
└── theme/

JSS 项目
├── (复用) internal-saas-template
├── (新增) app/(snap)/
└── (定制) theme.orange.ts

SnapPocket 项目
├── (复用) internal-saas-template
├── (新增) app/(pocket)/
└── (定制) theme.purple.ts
```

**这是SaaS公司会干的事，不是demo玩家。**

---

## 🏗 部署推进顺序

### Phase A：Local（localhost:3001）

**目标：** 确保应用壳子 + 认证 + 基础路由没问题

**必须一次性过的验收清单：**

```
✅ Sign up（邮箱/密码或magic link）
✅ Login
✅ Logout
✅ Dashboard的auth guard（未登录必跳转）
✅ Session刷新（F5刷新不掉登录）
✅ 多tab（A tab logout，B tab立刻失效/刷新）
```

**额外加：最低限度PWA验收**
```
✅ 能install（Add to Home Screen）
✅ 断网时dashboard至少能打开壳子（offline fallback页面也行）
✅ Service Worker不要把auth API缓存坏（别cache /auth/*, /rest/*）
```

**⚠️ 这一步不谈拍照、不谈上传，只谈"系统能活着"。**

---

### Phase B：Dev（dev.jobsitesnap.com）

**目标：** 验证域名、env、CORS、cookie、redirect URL都连得上

**必须一次性过：**

```
✅ dev域名下login/signup正常
✅ Supabase Auth Redirect URLs配对（不会跳回localhost）
✅ dev环境变量齐全（NEXT_PUBLIC_*、Supabase keys、R2 buckets）
✅ R2写入dev bucket（哪怕只是测试上传endpoint）
```

**关键检查点：**
- Redirect URL / cookie / CORS正确
- env完整（dev supabase + dev buckets）
- dev域名下全流程通过

👉 **只要dev过了，说明"部署路径"通了**

---

### Phase C：Production（jobsitesnap.com）

**目标：** 验证"同一套代码在prod env没暗坑"

**必须一次性过：**

```
✅ prod域名下login/signup正常
✅ prod的redirect URL正确
✅ prod不会读到dev的bucket / dev的supabase project
✅ 基础监控/日志至少能看（Vercel logs / Supabase logs）
```

---

## 📝 Definition of Done（DoD）

### Local DoD

```
[x] signup/login/logout OK
[x] refresh不掉session
[x] route guard OK
[x] 多tab session同步 OK
[x] PWA能install
[x] 断网不崩溃
```

---

### Dev DoD

```
[x] redirect URL / cookie / CORS OK
[x] env完整（dev supabase + dev buckets）
[x] dev域名下全流程 OK
[x] 不跳回localhost
```

---

### Prod DoD

```
[x] prod redirect URLs OK
[x] prod不串dev（bucket + supabase）
[x] logs可追踪
[x] 监控就位
```

---

## 🎯 决策3：订阅计费延后到发布前

### CEO提问：
> "订阅计费可以等开发基本完成，发布之前再加上，对吗？"

### CPO结论：✅ 对，而且这是非常成熟、非常专业的判断

---

### 为什么现在"先不做计费"是对的？

#### 1. 计费系统 = 高风险、低学习价值

**当前阶段更重要的：**
- Auth / PWA / 离线 / 上传状态机
- 这些都比计费重要

**计费早做只会：**
- ❌ 拖慢节奏
- ❌ 引入edge case（退款、试用、升级、降级）
- ❌ 影响测试（没人愿意绑卡）

👉 **现在做计费，不会验证任何核心假设**

---

#### 2. 你们现在的目标不是"能不能收钱"

**而是验证：**
- ✅ 能不能连续拍照不卡？
- ✅ 能不能离线不丢？
- ✅ 能不能Job不错归？

**这是付费意愿的真正来源。**

---

#### 3. 晚一点加计费，反而更干净

**你已经选了正确模板路线：**
- Supabase / Next / shadcn

**计费是一个独立模块：**
- ✅ 不会影响SnapEvidence的状态机
- ✅ 不会影响数据模型（最多多一个`subscription_status`）

👉 **晚加不会返工**

---

### 正确的节奏

#### Phase 1（现在 → 内测）

```
❌ 不做订阅
❌ 不绑卡
✅ 所有用户 = Free / Trial

目标：功能跑通 + 工地验证
```

---

#### Phase 1.5（内测稳定后）

```
✅ UI上预留但不启用计费入口
   例如：Settings → Billing (Coming soon)

开始：
- 定价讨论
- feature gating设计
```

---

#### Phase 2（发布前）

```
✅ 接Stripe
✅ 加订阅（Monthly / Annual）
✅ Feature gate（比如上传量 / Job数）
✅ 试用 → 转付费
```

**这一阶段再做，反而是"精准实现"。**

---

### ⚠️ 但要提前预留一个字段

**虽然现在不做计费，但必须预留：**

```typescript
// user表
user.plan = 'free' | 'trial' | 'pro'

// 或
account.subscription_status = 'inactive' | 'trial' | 'active'
```

**先不用，但别以后改schema。**

---

## 🎬 48小时执行清单

### ✅ 第1天：复用LedgerSnap壳子

**让CTO/前端原样复制或共享：**
- Auth（Sign up / Login / Logout）
- Session / Route Guard
- Dashboard Layout
- local → dev → prod的env结构

**明确：**
> 不要动逻辑，只换品牌色。

---

### 🎨 第1天：切Jobsite Snap品牌色

**只做三件事：**
1. 设一个 `brand.primary = 活力橙`
2. Button / active / focus用这个token
3. Logo / favicon（如果已有就换）

**不要：**
- ❌ 改spacing
- ❌ 改grid
- ❌ 改组件层级

---

### 🌐 第1-2天：Local验收

**验收标准：**
```
能signup/login
刷新不掉登录
dashboard正常
PWA能install（哪怕最基础）
```

**过了再推dev。**

---

### 🚀 第2天：推Dev

**重点只看：**
- redirect URL对不对
- env用的是dev supabase / dev buckets
- 不跳回localhost

---

### 🧪 第2天：留空SnapEvidence路由

**预留落点：**
```typescript
/jobs/[jobId]/snap
```

**先是placeholder页面也没关系**  
这是给Phase 1拍照逻辑预留"落点"。

---

## 💬 给CTO的一句话指令

```
我们不在JSS重做基础系统
直接沿用LedgerSnap的auth / layout / env
目标是48小时内local → dev → prod跑通
SnapEvidence后面在新route独立推进
```

---

## 🎯 核心战略总结

### CEO+CPO共同判断

**"底层一模一样，外观一眼能认，体验现场为王。"**

**这个决策已经是：**
> 一个经历过真刀真枪SaaS的创始人判断

---

### 三个"省"

1. **省时间** - 不重造auth/session轮子
2. **省风险** - 已踩过的坑不再踩
3. **省精力** - 80%投入在真正有价值的地方

---

### 三个"狠"

1. **狠心复用** - 不因为"想改"就改
2. **狠抓核心** - 只做连拍/离线/归属
3. **狠守边界** - 订阅延后，不动摇

---

## 📊 这条路线的"隐藏收益"

### 1. 快速迭代

**dev/prod推起来会非常顺**
- 部署路径熟悉
- 环境配置成熟
- Auth流程稳定

---

### 2. 问题定位清晰

**出问题时能马上判断：**
- 是infra问题？（已经熟）
- 还是SnapEvidence新逻辑？

---

### 3. 团队专注度高

**CTO和工程团队不会分心在：**
- ❌ "该不该重写auth"
- ❌ "env结构要不要改"
- ❌ "能不能换个UI框架"

**而是100%聚焦：**
- ✅ 拍照怎么不卡
- ✅ 离线怎么不丢
- ✅ 上传怎么可靠

---

## 🚧 风险防范

### 风险1：团队"手痒"想改底层

**症状：**
- "我觉得auth可以优化一下"
- "dashboard layout可以重构"
- "env结构不够优雅"

**应对：**
```
CPO必须说NO

理由：Phase 1的成功标准不是"代码优雅"
而是"功能稳定 + 用户验证"
```

---

### 风险2：UI改动范围蔓延

**症状：**
- "既然改颜色，不如顺便..."
- "spacing可以稍微调一下"
- "组件层级其实可以..."

**应对：**
```
只改primary color
其他一律禁止

理由：每多改一处，上线风险+10%
```

---

### 风险3：订阅压力提前

**症状：**
- 投资人问："什么时候能收费？"
- 团队问："要不要加个付费墙？"

**应对：**
```
计费是放大器，不是发动机
发动机没稳，放大器只会放大噪音

Phase 1目标：功能验证 + 用户依赖
不是收入验证
```

---

## 📌 下一步行动

### 立即执行（48小时内）

- [ ] **CTO：** 拉Vercel Supabase Starter
- [ ] **前端：** 复用LedgerSnap auth/session
- [ ] **设计：** 定义活力橙color token
- [ ] **全员：** Local环境跑通DoD
- [ ] **全员：** 推Dev环境验证

---

### 本周完成（7天内）

- [ ] **Local/Dev/Prod三环境全部通过**
- [ ] **预留SnapEvidence空路由**
- [ ] **开始SnapEvidence Camera开发**

---

### Phase 1里程碑前

- [ ] **SnapEvidence核心功能完成**
- [ ] **内测用户验证**
- [ ] **准备订阅计费设计**

---

## 💬 CPO最后的话

### 给CEO的肯定

**你这次的几个判断：**

1. 复用LedgerSnap架构
2. 选用成熟模板
3. 订阅计费延后
4. 只换UI颜色

**每一个都是：**
> 非常成熟、非常专业、非常有执行力的创始人决策

**这不是"将就"，这是"克制"。**  
**克制，是你这个产品最大的优势。**

---

### 给CTO的提醒

**Phase 1的成功定义：**

```
不是：代码最优雅
不是：架构最先进
不是：UI最好看

而是：
✅ 工地师傅愿意天天用
✅ 离线不丢照片
✅ 连拍不卡顿
✅ Job不错归
```

**一切以此为准。**

---

**文档版本：** v1.0  
**创建人：** CPO  
**审核人：** CEO  
**执行人：** CTO + 全团队  
**生效日期：** 2026-02-07

---

复用得当 + 克制执行 = Phase 1成功的唯一路径！🚀

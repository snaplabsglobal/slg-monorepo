# JSS Job地址标准化 - 完整规范（三件套）

> **文档类型：** 基础设施规范 + 实施清单 + 演进路线  
> **适用产品：** JobSite Snap（JSS）  
> **适用阶段：** MVP（Magic Import已启用）  
> **文档目的：** 保证Job的地址是"机器可用、长期可信"的基础设施  
> **创建时间：** 2026-02-08  
> **优先级：** 🔥 P0 - 不可妥协的地基  

---

## 📋 目录

```
Part 1: MVP技术与产品规范
Part 2: 前后端实现TODO清单
Part 3: 为什么必须强约束地址（内部共识）
Part 4: v1.1安全增强路线（不踩雷版）
```

---

# Part 1: MVP技术与产品规范

## 一、为什么Job地址必须标准化（结论先行）

### 地址不是文字，是地理锚点

**在JSS中，Job地址是一个"Geo Anchor"**

```
这个锚点将被用于：
✓ Magic Import（照片距离筛选）
✓ Job去重
✓ 地图/周边功能
✓ 未来的智能提示（非MVP）
```

**如果地址不标准化：**
```
❌ 以上所有功能都会不稳定
❌ 数据污染无法修复
❌ Bug无法定位
```

---

## 二、MVP的唯一允许方案（不讨论）

### ✅ Google Places Autocomplete

```
地址输入必须通过Autocomplete选择
禁止free text保存为Job地址
禁止自己解析字符串地址
```

**行业标准：**
```
CompanyCam    ✓
Procore       ✓
Uber          ✓
Airbnb        ✓

→ 全部使用这一套
```

---

## 三、Job地址的创建与编辑规则（产品级）

### 3.1 Job创建时（强制）

**地址输入框 = Autocomplete**

**用户必须：**
```
✓ 从下拉列表中点选一个地址
```

**不允许：**
```
❌ 直接回车保存
❌ 复制粘贴后不选择
```

**UI强制文案（逐字）：**
```
Please select an address from the list.
```

---

### 3.2 Job编辑时（允许但受限）

**允许用户修改地址**

**修改行为必须：**
```
✓ 重新走Autocomplete
✓ 重新获取lat/lng/place_id
```

---

## 四、Job地址的数据模型（技术硬规范）

### 必须保存的字段（MVP不可少）

```typescript
job.address_text        // 用户可读（formatted address）
job.place_id            // Google place_id（不可变主键）
job.lat                 // number
job.lng                 // number
```

---

### 字段说明（非常重要）

#### place_id

```
✓ 是Job地址的真正唯一标识

用于：
- Job去重
- 后续地图/API对齐
```

---

#### lat / lng

```
✓ 作为所有距离计算的唯一可信坐标
```

---

## 五、禁止行为（必须写进Code Review）

**以下任何行为视为违反MVP规范：**

```
❌ 允许用户随便输入地址字符串
❌ 保存地址但没有lat/lng
❌ 后端用Geocoding API"猜"地址
❌ Magic Import在Job没坐标时仍可用
```

---

## 六、与Magic Import的强绑定规则

### 6.1 前置条件（硬约束）

```
Job没有标准地址 → Magic Import不可用
```

**UI行为：**
```
Import photos按钮 → disabled

显示文案：
"Add a job address to import photos."
```

---

### 6.2 技术依赖关系（CTO必知）

**Magic Import的距离计算：**
```
distance(photo_gps, job_lat_lng) <= R
```

**如果job_lat_lng不可信：**
```
→ Import会错
→ 用户会不信任系统
→ Bug无法修复（数据已污染）
```

---

## 七、MVP不解决的问题（明确列出）

**以下内容不是MVP范围：**

```
❌ 地址模糊匹配
❌ 单位号/楼层号解析
❌ 同一地址多个Job的智能区分
❌ 手绘地址/自定义坐标
```

**👉 这些只在真实用户需求明确后才讨论**

---

## 八、验收清单（PR Review必查）

**Reviewer必须逐条确认：**

```
☐ Job创建页面使用Autocomplete
☐ 无法保存free text地址
☐ 保存时必有place_id/lat/lng
☐ Job没地址时Import被禁用
☐ Magic Import未尝试fallback/guess地址
```

**任一未满足 → PR不通过**

---

## 九、MVP冻结声明（非常重要）

```
Job地址标准化是JSS的基础设施，不是体验选项。
```

**一旦MVP上线：**

```
❌ 不允许为了"方便用户"放宽约束
❌ 不允许为了"少一步操作"绕过Autocomplete
```

**宁可多一步点击，也不要一个不可信的地址。**

---

# Part 2: 前后端实现TODO清单

## 目标

```
让地址成为"不可污染的数据基础设施"
```

---

## A. 前端TODO（必须）

### A1. Job创建/编辑页

```
☐ 地址输入框只能使用Google Places Autocomplete

☐ 禁止free text提交

☐ 用户必须从下拉列表点选

☐ 未点选地址：
  - 禁止保存
  - 显示文案：
    "Please select an address from the list."
```

---

### A2. 地址选择后的处理

```
☐ 从Places API获取：
  - place_id
  - formatted_address
  - geometry.location.lat
  - geometry.location.lng

☐ 将以上字段写入表单state

☐ 提交前校验：
  - 任一字段缺失 → 阻止提交
```

---

### A3. Job Details页面

```
☐ 如果Job没有lat/lng：
  - Import photos按钮 → disabled
  - 提示：
    "Add a job address to import photos."
```

---

## B. 后端TODO（必须）

### B1. API校验（双保险）

```
☐ Job Create/Update API：
  - 校验place_id, lat, lng
  - 任一缺失 → 400错误

☐ 禁止后端"自动补地址"或Geocoding fallback
```

---

### B2. 数据库约束（MVP级）

**不上复杂constraint，但要有明确约定**

```
☐ job.place_id 不允许空字符串

☐ job.lat/lng 必须是number

☐ 日志记录：
  - 谁、什么时候改了地址
```

---

## C. Magic Import强依赖

```
☐ Import Preview API：
  - 开始前校验Job是否有lat/lng
  - 没有 → 直接返回不可用状态

☐ 不允许Import逻辑内再尝试"猜地址"
```

---

## 实施顺序建议

```
1. 前端A1 + A2（地址输入强制）
2. 后端B1（API校验）
3. 前端A3（Import入口校验）
4. 后端C（Import强依赖）
5. 后端B2（数据库约束）
```

**预计时间：1-2天**

---

# Part 3: 为什么必须强约束Job地址（内部共识）

> **目标受众：** CTO / 团队 / 未来新人  
> **目的：** 统一内部判断标准，不是说服用户  

---

## 1️⃣ 地址在JSS里不是"描述"，而是"坐标"

### 在JSS中，地址不是为了好看

**而是为了：**
```
✓ 照片距离计算
✓ Job去重
✓ 地图定位
✓ 后续任何智能
```

**一条没有坐标的Job：**
```
= "未来不可升级的死Job"
```

---

## 2️⃣ "先随便存，之后再补"的想法是错的

### 现实中一旦发生：

```
Job创建时地址是脏的
  ↓
后续再补lat/lng
  ↓
会导致：
  - 已导入照片全部错位
  - Magic Import结果不可复现
  - Bug无法修（数据历史已污染）
```

**👉 地址这件事，错一次就毁一串功能**

---

## 3️⃣ 为什么不能"为了用户方便"放宽？

### 因为你现在的用户是：

```
- contractor
- builder
- inspector-facing
```

### 他们真正需要的是：

```
✓ 稳定、可信、可复用的工地数据
```

### 不是：

```
❌ 少点一次
❌ 快3秒
```

---

## 4️⃣ 行业事实（不是我们拍脑袋）

```
CompanyCam：强制标准地址
Procore：强制标准地址
ArcSite：强制标准地址
Uber / Airbnb：强制标准地址
```

**这是行业共识，不是产品个性**

---

## 5️⃣ 内部裁决原则（以后所有争论用）

### 你可以直接引用这句话：

```
如果一个功能依赖"地理位置"，
那它的前置条件就必须是"可信坐标"，
而不是"用户输入的字符串"。
```

---

## 常见反对意见及回应

### 反对："这样用户体验不好"

**回应：**
```
contractor需要的是"可信的数据"
不是"少点一次"

地址污染后的体验更差：
- Import错误
- 照片丢失
- 无法修复
```

---

### 反对："我们可以后台自动修复"

**回应：**
```
历史数据一旦污染，无法修复

已导入的照片、已创建的关联
全部会错位

这不是"修复脏数据"的问题
这是"防止产生脏数据"的问题
```

---

### 反对："CompanyCam也没这么严格"

**回应：**
```
CompanyCam就是这么严格的

他们所有Job必须有标准地址
他们所有Import必须基于GPS距离

这是行业标准
```

---

# Part 4: v1.1安全增强路线（不踩雷版）

> **注意：** 这是路线图，不是待办清单  
> **条件：** 只有在MVP跑顺、真实用户反馈明确后才做  

---

## v1.1 可以安全做的（低风险）

### 1️⃣ 地址编辑历史

**记录：**
```
- 原地址
- 新地址
- 修改人
- 修改时间
```

**目的：**
```
防止"悄悄改地址导致历史数据乱掉"
```

---

### 2️⃣ 同一地址多Job提示（不自动合并）

**当用户创建Job时：**
```
检测place_id是否已存在
  ↓
提示：
"You already have jobs at this address."
```

**注意：**
```
❌ 不自动合并
❌ 不阻止创建
```

---

### 3️⃣ Import半径高级选项（可选）

**默认仍是固定半径**

**高级用户可选：**
```
- 50m
- 100m
- 200m
```

**必须明确标注：**
```
"Larger radius may include photos 
 from nearby sites."
```

---

## v2 才能讨论的（现在不碰）

```
❌ 自动区分同一地址不同unit
❌ 楼层/unit智能解析
❌ 手绘坐标/自定义点
❌ 地址模糊匹配/猜测
```

**这些一旦做早了，100%翻车**

---

## 演进原则

### 增强，但不放松

```
v1.1可以做：
✓ 更好的提示
✓ 更多的选项
✓ 更丰富的历史

v1.1不能做：
❌ 放宽地址约束
❌ 允许free text
❌ 自动猜测坐标
```

---

### 数据质量永远优先

```
宁可少一个功能
也不要一个脏数据源

脏数据 = 定时炸弹
```

---

# 附录：快速参考

## 关键技术点速查

### Google Places Autocomplete配置

```javascript
// 基础配置
const autocompleteOptions = {
  types: ['address'],
  componentRestrictions: {
    country: ['ca', 'us']  // 限制国家
  }
}

// 获取结果
place.place_id              // 必须
place.formatted_address     // 必须
place.geometry.location.lat() // 必须
place.geometry.location.lng() // 必须
```

---

### 数据库Schema参考

```sql
-- jobs表必须字段
ALTER TABLE jobs
  ADD COLUMN place_id VARCHAR(255),
  ADD COLUMN address_text TEXT,
  ADD COLUMN lat DECIMAL(10, 8),
  ADD COLUMN lng DECIMAL(11, 8);

-- 索引
CREATE INDEX idx_jobs_place_id 
  ON jobs(place_id);
  
CREATE INDEX idx_jobs_lat_lng 
  ON jobs(lat, lng);
```

---

### API校验示例

```typescript
// Job Create/Update API
function validateJobAddress(data: any) {
  if (!data.place_id || 
      !data.lat || 
      !data.lng) {
    throw new Error(
      'Job must have valid address with coordinates'
    )
  }
  
  if (typeof data.lat !== 'number' || 
      typeof data.lng !== 'number') {
    throw new Error(
      'Coordinates must be numbers'
    )
  }
  
  return true
}
```

---

## 常见问题FAQ

### Q1: 用户说地址太长，能不能简化？

**A:**
```
不能简化存储的地址
但可以在UI上显示简化版本

存储：formatted_address（完整）
显示：street + city（简化）
```

---

### Q2: 老Job没有坐标怎么办？

**A:**
```
两个选择：
1. 强制用户补充地址（推荐）
2. 禁用Import功能直到补充

不允许：
❌ 后台自动猜测
❌ 放宽校验
```

---

### Q3: 用户在没有网络的地方创建Job？

**A:**
```
MVP阶段：
不支持离线创建Job

v1.1可以考虑：
- 离线模式暂存
- 有网时完成Autocomplete
- 完成前不允许Import
```

---

### Q4: 地址API有配额限制怎么办？

**A:**
```
Google Places Autocomplete：
- 前端调用，用户触发
- 不是批量后台调用
- 正常使用不会超配额

如果真超了：
- 说明用户量足够大
- 这是好事，不是坏事
```

---

## 决策树

### 遇到地址相关需求时

```
用户提出地址相关需求
  ↓
需求是否需要地理坐标？
  ├─ 是 → 必须基于place_id/lat/lng
  └─ 否 → 可以用address_text展示
  
是否需要修改地址约束？
  ├─ 是 → 拒绝，引用本文档
  └─ 否 → 可以讨论实现
  
是否需要猜测/模糊匹配？
  ├─ 是 → 推迟到v2，记录需求
  └─ 否 → 可以在现有框架内实现
```

---

## 最终CPO定锚

### 给你自己 & 团队

```
我们宁可Job少一点，
也不要一个"以后所有智能都用不了"的Job。
```

---

### 给CTO

```
地址不是体验层功能，
地址是系统可信度的地基。

地基一旦松了，
后面所有"聪明功能"都会塌。
```

---

### 给未来的自己

```
当有人说"这个约束太严格了"
翻开这份文档

当有人说"可以后台自动修复"
翻开这份文档

当有人说"CompanyCam没这么做"
翻开这份文档

然后说：
"这是我们的产品基础设施规范，
 不是可选项。"
```

---

## 验收检查表（最终版）

### MVP上线前必查

```
☐ Job创建使用Autocomplete
☐ 无法保存free text地址
☐ 所有新Job有place_id/lat/lng
☐ Job无地址时Import disabled
☐ Import不尝试猜测地址
☐ API有双重校验
☐ 团队理解为什么这么做
```

---

### 每次Code Review必查

```
☐ 没有绕过Autocomplete的代码
☐ 没有"自动补地址"的逻辑
☐ 没有"fallback到模糊匹配"
☐ 文档更新（如有变更）
```

---

### 每月数据质量检查

```
☐ 检查place_id缺失的Job数量
☐ 检查lat/lng为null的Job数量
☐ 检查地址编辑日志
☐ 用户反馈中的地址问题
```

---

**文档版本：** v1.0  
**创建人：** CPO  
**审核人：** CTO  
**执行人：** 前后端团队  
**生效日期：** 立即生效  
**下次审核：** MVP上线后3个月  

---

**地址是地基，地基不能松！** 🎯

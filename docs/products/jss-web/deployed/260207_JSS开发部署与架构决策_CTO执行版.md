# JSS 开发部署与架构决策文档

> **文档类型：** 技术架构 + 部署策略  
> **创建时间：** 2026-02-07  
> **优先级：** 🔴 P0 - 立即执行  
> **决策人：** CEO + CPO  
> **执行人：** CTO

---

## 📋 执行摘要（30秒版）

**核心决策：**
1. ✅ 复用LedgerSnap的完整架构（Auth/Session/Dashboard）
2. ✅ 只换UI为"活力橙"（不改底层）
3. ✅ 使用Vercel Supabase Starter作为模板
4. ✅ 订阅计费推迟到发布前1-2周
5. ✅ 推进路线：localhost:3001 → dev → production

**时间线：**
- 48小时内：local环境跑通
- 1周内：dev环境部署完成
- 2周内：production环境ready

---

## 🎯 战略判断：为什么复用LedgerSnap架构

### 决策背景

**CEO提问：** "我们先在localhost:3001把基本功能部署好，然后试推dev和production，你觉得怎样？"

**CPO判断：** 非常对，而且是Phase 1最稳的推进方式。

---

### 核心原因（三大理由）

#### 1️⃣ Auth/Env/Deploy是最容易出阴间Bug的部分

**LedgerSnap已经踩过的坑：**
- Supabase Auth redirect
- local / dev / prod env配置
- Vercel部署路径
- Cookie / Session刷新
- 多Tab同步

**结论：** 这些坑不值得在JSS再踩一遍

**复用 = 把不确定性降到最低**

---

#### 2️⃣ JSS的差异在"现场使用感"，不在底层

**JSS的价值在于：**
- 连拍不卡
- 离线不丢
- Job不错归

**而不是：**
- 再发明一套登录系统
- 再设计一套Dashboard框架

**结论：** 底座统一，产品才可控

---

#### 3️⃣ 统一Infra，未来产品之间才"像一家人"

**当你以后有：**
- LedgerSnap
- Jobsite Snap
- SnapPocket

**如果它们：**
- Auth一样
- Session行为一样
- Env模式一样

**那你以后做：**
- SSO（单点登录）
- Cross-app deep link
- Account / Billing统一

**会轻松10倍**

---

## 🧱 架构决策清单

### ✅ 完全复用（不可修改）

| 模块 | 来源 | 说明 |
|------|------|------|
| **Auth系统** | LedgerSnap | Sign up / Login / Logout / Session |
| **Route Guard** | LedgerSnap | 未登录自动跳转 |
| **Session管理** | LedgerSnap | 刷新不掉登录、多Tab同步 |
| **Dashboard Layout** | LedgerSnap | Sidebar + Header结构 |
| **Env配置模式** | LedgerSnap | local / dev / prod三环境 |
| **Supabase连接** | LedgerSnap | Auth + Database配置 |
| **Vercel部署** | LedgerSnap | 部署流程和配置 |

**关键指令（给CTO）：**
```
不要动逻辑，只换品牌色。
```

---

### 🎨 只改UI（活力橙）

**允许修改的3件事：**

1. **主题色Token：**
```javascript
// theme.ts
export const theme = {
  brand: {
    primary: '#FF7A00', // 活力橙
  }
}
```

2. **Logo / Favicon：**
- JSS专属logo
- 活力橙配色

3. **Button / Active / Focus状态：**
- 使用新的brand.primary token

---

**🚫 禁止修改：**
- ❌ Spacing（边距）
- ❌ Grid布局
- ❌ 组件层级
- ❌ 任何底层逻辑

**反面案例警告：**
```javascript
// ❌ 不要复制一套CSS
ledgersnap.css
jobsitesnap.css

// ✅ 应该用token切换
theme.brand.primary = '#FF7A00'
```

**原因：** 3个月后你会后悔

---

### 🆕 新增功能（独立开发）

**在新路由下独立实现：**

| 功能 | 路由 | 说明 |
|------|------|------|
| **SnapEvidence相机** | `/jobs/[jobId]/snap` | 拍照功能 |
| **Job Photos时间线** | `/jobs/[jobId]/photos` | 照片浏览 |
| **Job管理** | `/jobs` | Job列表 |

**原则：** PWA / SnapEvidence在新route下独立推进，不污染现有代码

---

## 📦 技术选型：Vercel Supabase Starter

### 为什么选这个模板？

**方案对比：**

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **Vercel Supabase Starter** | 与现有栈100%匹配<br>Auth已跑通<br>shadcn/ui干净 | Landing简单（但不需要） | ⭐⭐⭐⭐⭐ |
| Next.js SaaS Starter | 功能更全（含Stripe） | 有安全漏洞需修复<br>过于复杂 | ⭐⭐⭐ |
| 炫酷Landing模板 | 好看 | Dashboard粗糙<br>改就散架 | ⭐ |

---

### Vercel Supabase Starter核心优势

**技术栈匹配度100%：**
- ✅ Next.js App Router
- ✅ Supabase Auth（cookie-based）
- ✅ shadcn/ui（Radix + Tailwind）
- ✅ Dashboard骨架完整
- ✅ Protected routes开箱即用

**你们已经在用Supabase：**
- 无缝迁移
- Auth配置可直接复用
- 不需要学新东西

**UI优势：**
- 不花哨，但非常SaaS、非常干净
- shadcn是"复制组件到你项目里"，不会被框死
- 未来深改（JSS / SnapPocket）完全扛得住

---

### 不选其他方案的原因

**❌ Next.js SaaS Starter（带Stripe的）：**
- 问题：Vercel模板页有安全警告（CVE-2025-55182）
- 问题：Phase 1根本不需要订阅计费
- 问题：会带来不必要的复杂度

**❌ 全功能CRM/ERP模板：**
- 功能太多
- Mental load太重
- 会拖慢Phase 1

**❌ 炫酷营销型模板：**
- Landing漂亮，但Dashboard粗糙
- Auth是Demo级
- 一改就散架
- 不适合长期产品

---

## 🚀 部署推进路线（Local → Dev → Prod）

### 阶段0：准备工作（立即执行）

**Step 1：获取模板**
```bash
# 使用Vercel Supabase Starter
npx create-next-app@latest jobsite-snap \
  --example https://github.com/vercel/next.js/tree/canary/examples/with-supabase
```

**Step 2：对齐LedgerSnap配置**
- 复制Auth逻辑
- 复制Session管理
- 复制Env结构

**Step 3：换成活力橙**
```javascript
// app/theme.ts
export const colors = {
  brand: {
    primary: '#FF7A00',    // 活力橙
    hover: '#E66D00',      // 深一点
    light: '#FFA040',      // 浅一点
  }
}
```

---

### 阶段1：Local（localhost:3001）- 壳子验收

**目标：** 确保基础骨架、Supabase Auth、路由守卫没问题

**必须一次性通过的8项：**

#### ✅ 1. Sign Up（邮箱/密码）
```
测试：
1. 填写邮箱/密码
2. 提交注册
3. 检查Supabase Auth Dashboard

验收：
✅ 用户创建成功
✅ 收到验证邮件（如果启用）
✅ 自动登录或跳转登录页
```

---

#### ✅ 2. Login
```
测试：
1. 使用已注册账号登录
2. 检查Session

验收：
✅ 登录成功
✅ 跳转到Dashboard
✅ Cookie正确设置
```

---

#### ✅ 3. Logout
```
测试：
1. 点击Logout
2. 尝试访问Dashboard

验收：
✅ Session清除
✅ 自动跳转登录页
✅ Cookie清除
```

---

#### ✅ 4. Dashboard的Auth Guard
```
测试：
1. 未登录状态访问 /dashboard

验收：
✅ 自动重定向到 /login
✅ 登录后返回Dashboard
```

---

#### ✅ 5. Session刷新（F5测试）
```
测试：
1. 登录后
2. 按F5刷新页面

验收：
✅ 不掉登录状态
✅ 仍在Dashboard
✅ 用户信息正确显示
```

---

#### ✅ 6. 多Tab同步
```
测试：
1. 打开Tab A并登录
2. 打开Tab B（同域名）
3. 在Tab A中Logout
4. 切换到Tab B

验收：
✅ Tab B立刻失效或刷新后失效
✅ 跳转到登录页
```

---

#### ✅ 7. PWA基础验收
```
测试：
1. 点击浏览器的"添加到主屏幕"
2. 从主屏幕打开
3. 断网后打开

验收：
✅ 能安装（Add to Home Screen）
✅ 打开时无浏览器地址栏
✅ 断网时至少能显示离线页面
```

---

#### ✅ 8. Service Worker不缓存Auth API
```
测试：
1. 登录后
2. 检查Network面板
3. Logout再Login

验收：
✅ /auth/* 请求不被缓存
✅ /api/* 请求实时
✅ 不出现"登录了但显示未登录"
```

---

**Local DoD（Definition of Done）：**
```
✅ signup/login/logout OK
✅ refresh不掉session
✅ route guard OK
✅ 多tab session同步 OK
✅ PWA能install
✅ Service Worker不缓存auth
```

---

### 阶段2：Dev（dev.jobsitesnap.com）- 真实环境验证

**目标：** 验证域名、env、CORS、cookie、redirect URL都连得上

**关键配置清单：**

#### 🔧 Supabase配置（dev）

**Site URL：**
```
https://dev.jobsitesnap.com
```

**Redirect URLs：**
```
https://dev.jobsitesnap.com/auth/callback
https://dev.jobsitesnap.com/auth/confirm
```

**⚠️ 常见错误：**
```
❌ 忘记改Redirect URLs → 一直跳回localhost
❌ Site URL还是localhost → Cookie domain不对
❌ CORS没配 → API请求被阻止
```

---

#### 🔐 环境变量（dev）

**Vercel环境变量配置：**
```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbG...
SUPABASE_SERVICE_ROLE_KEY=eyJhbG...

# R2 (dev bucket)
R2_ACCOUNT_ID=xxx
R2_ACCESS_KEY_ID=xxx
R2_SECRET_ACCESS_KEY=xxx
R2_BUCKET_NAME=jobsite-snap-dev

# 其他
NEXT_PUBLIC_APP_URL=https://dev.jobsitesnap.com
```

**🚨 关键检查：**
- ✅ 所有`NEXT_PUBLIC_*`变量都设置
- ✅ Dev使用dev bucket（不是prod）
- ✅ Supabase Project是dev项目

---

#### ✅ Dev环境必须通过的测试

**1. Redirect URL测试：**
```
测试：
1. 在dev.jobsitesnap.com注册/登录
2. 观察重定向行为

验收：
✅ 不跳回localhost
✅ 回调URL正确
✅ 登录后停留在dev域名
```

**2. Cookie Domain测试：**
```
测试：
1. 登录后检查Cookie
2. F5刷新

验收：
✅ Cookie domain是dev.jobsitesnap.com
✅ Session持久化
```

**3. CORS测试：**
```
测试：
1. API调用
2. Supabase请求
3. R2上传（如果有）

验收：
✅ 无CORS错误
✅ 请求正常通过
```

**4. R2写入测试：**
```
测试：
1. 创建测试上传endpoint
2. 上传一张测试图片
3. 检查dev bucket

验收：
✅ 图片出现在dev bucket
✅ 不出现在prod bucket
✅ URL可访问
```

---

**Dev DoD（Definition of Done）：**
```
✅ redirect URL / cookie / CORS OK
✅ env完整（dev supabase + dev buckets）
✅ dev域名下全流程OK
✅ 不串prod环境
```

---

### 阶段3：Production（jobsitesnap.com）- 最终验证

**目标：** 验证同一套代码在prod env没有暗坑

**关键检查清单：**

#### 🔧 Supabase配置（prod）

**Site URL：**
```
https://jobsitesnap.com
```

**Redirect URLs：**
```
https://jobsitesnap.com/auth/callback
https://jobsitesnap.com/auth/confirm
```

---

#### 🔐 环境变量（prod）

```bash
# Supabase (PROD project)
NEXT_PUBLIC_SUPABASE_URL=https://xxx-prod.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbG...（prod key）
SUPABASE_SERVICE_ROLE_KEY=eyJhbG...（prod key）

# R2 (PROD bucket)
R2_BUCKET_NAME=jobsite-snap-prod

# App
NEXT_PUBLIC_APP_URL=https://jobsitesnap.com
```

**🚨 绝对不能：**
- ❌ Prod用dev的Supabase
- ❌ Prod用dev的bucket
- ❌ 混用任何dev配置

---

#### ✅ Prod环境必须通过的测试

**1. 环境隔离测试：**
```
测试：
1. 在prod注册新用户
2. 检查Supabase prod Dashboard
3. 检查dev Dashboard

验收：
✅ 用户只在prod出现
✅ Dev没有这个用户
✅ 完全隔离
```

**2. 监控与日志：**
```
测试：
1. 访问Vercel Logs
2. 访问Supabase Logs
3. 触发一次错误

验收：
✅ 能看到实时日志
✅ 错误被记录
✅ 可追踪用户行为
```

**3. 全流程回归：**
```
测试：完整走一遍用户流程
1. Sign up
2. Login
3. 访问Dashboard
4. Logout
5. 再次Login

验收：
✅ 所有步骤流畅
✅ 无报错
✅ Session稳定
```

---

**Prod DoD（Definition of Done）：**
```
✅ prod redirect URLs OK
✅ prod不串dev（bucket + supabase）
✅ logs可追踪
✅ 全流程回归通过
```

---

## 💰 订阅计费策略（推迟到发布前）

### ✅ 为什么现在不做计费是对的

**CPO判断：** 这是一个非常成熟、非常专业的判断

---

#### 1️⃣ 计费系统 = 高风险、低学习价值

**在当前阶段：**
- Auth / PWA / 离线 / 上传状态机
- **👉 都比计费重要**

**计费早做只会：**
- 拖慢节奏
- 引入Edge Case（退款、试用、升级、降级）
- 影响测试（没人愿意绑卡）

**👉 现在做计费，不会验证任何核心假设**

---

#### 2️⃣ 你们现在的目标不是"能不能收钱"

**而是：**
- 能不能连续拍照不卡？
- 能不能离线不丢？
- 能不能Job不错归？

**这是付费意愿的真正来源**

---

#### 3️⃣ 晚一点加计费，反而更干净

**你已经选了正确的架构：**
- 计费是一个独立模块
- 不会影响SnapEvidence的状态机
- 不会影响数据模型（最多多一个subscription_status）

**👉 晚加不会返工**

---

### 📅 正确的计费时间线

**Phase 1（现在 → 内测）：**
```
❌ 不做订阅
❌ 不绑卡
✅ 所有用户 = Free / Trial

目标：功能跑通 + 工地验证
```

---

**Phase 1.5（内测稳定后）：**
```
✅ UI上预留但不启用计费入口

例如：
Settings → Billing（Coming soon）

开始：
- 定价讨论
- Feature gating设计
```

---

**Phase 2（发布前1-2周）：**
```
✅ 接入Stripe
✅ 添加订阅（Monthly / Annual）
✅ Feature gate（上传量 / Job数）
✅ 试用 → 转付费流程

这一阶段再做，反而是"精准实现"
```

---

### ⚠️ 唯一要提前做的事

**虽然现在不做计费，但必须预留字段：**

```typescript
// User或Account表
interface User {
  // ... 其他字段
  
  plan: 'free' | 'trial' | 'pro';
  // 或
  subscription_status: 'inactive' | 'trial' | 'active';
  
  trial_ends_at?: string;
  subscription_id?: string;
}
```

**原因：** 先不用，但别以后改Schema

---

### 💬 创始人级总结

> **计费是放大器，不是发动机。**  
> **发动机没稳，放大器只会放大噪音。**

**你现在的节奏：**
1. 先稳住产品
2. 再验证现场
3. 最后才收钱

**这是非常健康、非常专业的路线。**

---

## 📁 目录结构规范（禁止随意修改）

### ✅ 从LedgerSnap复用的结构（不可动）

```
jobsite-snap/
├── app/
│   ├── (auth)/              # 复用：Auth路由
│   │   ├── login/
│   │   ├── signup/
│   │   └── callback/
│   ├── (dashboard)/         # 复用：Dashboard布局
│   │   ├── layout.tsx       # ⚠️ 禁止修改
│   │   └── page.tsx
│   ├── middleware.ts        # 复用：Route guard
│   └── layout.tsx           # 复用：Root layout
├── components/
│   ├── auth/                # 复用：Auth组件
│   ├── dashboard/           # 复用：Dashboard组件
│   └── ui/                  # shadcn/ui组件
├── lib/
│   ├── supabase/            # 复用：Supabase客户端
│   │   ├── client.ts        # ⚠️ 禁止修改
│   │   └── server.ts        # ⚠️ 禁止修改
│   └── auth/                # 复用：Auth helpers
└── styles/
    └── theme.ts             # ✅ 可修改：只改colors
```

---

### 🆕 JSS新增的结构（独立开发）

```
jobsite-snap/
├── app/
│   ├── (dashboard)/
│   │   ├── jobs/            # 新增：Job管理
│   │   │   ├── page.tsx
│   │   │   └── [jobId]/
│   │   │       ├── photos/  # 新增：照片时间线
│   │   │       └── snap/    # 新增：SnapEvidence相机
│   │   └── settings/        # 扩展：JSS设置
├── components/
│   ├── jobs/                # 新增：Job组件
│   ├── photos/              # 新增：Photo组件
│   └── snap/                # 新增：相机组件
└── lib/
    ├── camera/              # 新增：相机逻辑
    ├── upload-queue/        # 新增：上传队列
    └── local-store/         # 新增：本地存储
```

---

### 🎨 Theme配置（唯一可改的地方）

```typescript
// styles/theme.ts

export const theme = {
  // ✅ 可以改：品牌色
  brand: {
    primary: '#FF7A00',      // 活力橙
    hover: '#E66D00',
    light: '#FFA040',
  },
  
  // ❌ 不要改：功能色
  semantic: {
    success: '#10B981',
    warning: '#F59E0B',
    error: '#EF4444',
    info: '#3B82F6',
  },
  
  // ❌ 不要改：中性色
  neutral: {
    // ... LedgerSnap的配置
  },
  
  // ❌ 不要改：间距
  spacing: {
    // ... 保持一致
  }
}
```

---

## 🎯 给CTO的执行清单（48小时内）

### Day 1：环境搭建（今天）

**上午：**
- [ ] 获取Vercel Supabase Starter模板
- [ ] 初始化Git仓库
- [ ] 配置本地环境变量

**下午：**
- [ ] 复制LedgerSnap的Auth逻辑
- [ ] 复制Session管理代码
- [ ] 修改Theme为活力橙
- [ ] 测试localhost:3001能启动

---

### Day 2：Local验收（明天）

**上午：**
- [ ] 跑通8项Local验收测试
- [ ] 修复发现的问题
- [ ] PWA基础验收

**下午：**
- [ ] 配置dev环境变量
- [ ] 准备dev域名
- [ ] 准备推送到Vercel

---

### Week 1：Dev部署（本周内）

- [ ] 推送到Vercel dev环境
- [ ] 配置dev.jobsitesnap.com域名
- [ ] 配置Supabase dev环境Redirect URLs
- [ ] 跑通Dev验收测试
- [ ] R2 dev bucket连接测试

---

### Week 2：Prod准备（下周）

- [ ] 配置prod环境变量
- [ ] 配置jobsitesnap.com域名
- [ ] 配置Supabase prod环境
- [ ] 跑通Prod验收测试
- [ ] 建立监控和日志

---

## 📊 成功指标

### 技术指标

| 指标 | 目标 | 验证方式 |
|------|------|---------|
| Local → Dev | 1周内 | Dev环境正常访问 |
| Dev → Prod | 2周内 | Prod环境正常访问 |
| Auth成功率 | 100% | 无登录失败 |
| Session稳定性 | 100% | 无掉线问题 |
| PWA安装率 | 可安装 | 能Add to Home Screen |

---

### 里程碑

| 时间 | 里程碑 | 验收标准 |
|------|--------|---------|
| **Day 1** | Local环境ready | 能启动，能改代码 |
| **Day 2** | Local验收通过 | 8项测试全过 |
| **Week 1** | Dev部署完成 | Dev环境正常使用 |
| **Week 2** | Prod环境ready | 可对外展示 |

---

## ⚠️ 风险与应对

### 风险1：Redirect URL配置错误

**症状：** 登录后一直跳回localhost

**应对：**
1. 检查Supabase Site URL
2. 检查Redirect URLs列表
3. 清除浏览器Cookie重试

---

### 风险2：环境变量混用

**症状：** Prod数据出现在Dev，或反之

**应对：**
1. 使用不同的Supabase Project
2. 使用不同的R2 Bucket
3. 命名规范：`xxx-dev`, `xxx-prod`

---

### 风险3：Service Worker缓存Auth API

**症状：** 登录了显示未登录，或相反

**应对：**
1. 在SW配置中排除`/auth/*`
2. 排除`/api/*`
3. 测试时使用Incognito模式

---

### 风险4：PWA缓存导致更新不生效

**症状：** 改了代码但手机看不到

**应对：**
1. 版本号机制
2. SW更新提示
3. 强制刷新机制

---

## 📞 支持与沟通

### CTO遇到问题的优先级

**P0（立即处理）：**
- Auth完全不工作
- 部署失败无法访问
- 数据丢失

**P1（当天处理）：**
- Session不稳定
- PWA无法安装
- 环境变量问题

**P2（本周处理）：**
- UI细节调整
- 性能优化
- 日志完善

---

### 汇报节点

**每天：**
- 完成了什么
- 遇到了什么问题
- 明天计划做什么

**每周：**
- DoD完成情况
- 风险和阻塞
- 需要的支持

---

## 💬 最终决策总结

### CPO给团队的三句话

1. **"底层一模一样，外观一眼能认，体验现场为王"**
   - 复用LedgerSnap = 稳定可靠
   - 换成活力橙 = 品牌识别
   - SnapEvidence = 差异化价值

2. **"不在基础系统上浪费时间"**
   - Auth/Session/Dashboard直接复用
   - 专注在真正有价值的地方
   - 计费推迟到发布前

3. **"48小时local → 1周dev → 2周prod"**
   - 节奏清晰
   - 风险可控
   - 稳步推进

---

### CEO的最终拍板

**这个架构决策我给满分。**

**原因：**
- ✅ 复用成熟方案（降低风险）
- ✅ 专注核心价值（SnapEvidence）
- ✅ 推进节奏清晰（可执行）
- ✅ 计费时机正确（不浪费精力）

---

**文档版本：** v1.0  
**创建人：** CPO  
**审核人：** CEO  
**执行人：** CTO  
**生效日期：** 2026-02-07  
**执行时限：** 48小时内启动，2周内完成

---

稳扎稳打，底座先通！🚀

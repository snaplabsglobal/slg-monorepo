# 会议纪要 - Eraser/Trim 工具设计

> **会议时间：** 2026-02-03  
> **会议类型：** 产品决策会议  
> **参与人员：** CPO、CDO  
> **优先级：** 🔴 P0 - Critical  
> **状态：** ✅ 已确定方案

---

## 📋 会议背景

### 核心问题

**用户疑问：**
> "线段相交时，要不要自动切断？"

**产品挑战：**
- 自动切断：可能误伤，用户失控
- 不切断：后续编辑困难

---

### 战略意义

**CPO明确指出：**
> "有没有'Trim / Erase with intent'是区分「玩具画图」和「施工画图」的关键。"

**产品定位跃迁：**
```
从：画图工具（magicplan级别）
到：施工级编辑器（AutoCAD/SketchUp级别）
```

---

## 🎯 核心决策：三层设计

### 第一层：默认行为（安全）

**✅ 默认原则：**
```
两条线相交 → 不自动切断
视觉上只是交叉
保持线段完整性
```

**理由：**
```
画线 = 增加几何
不应该自动修改已有几何
避免误伤用户意图
```

---

### 第二层：橡皮工具 E（明确修改）

**工具设计：**
```
E = Eraser（像SketchUp）
```

**行为规范：**

**E切换到橡皮模式**
```
工具状态明确
光标变为橡皮图标
```

**Hover到线段**
```
高亮可删除部分
如果有交点：只高亮hover的那一小段
如果无交点：高亮整段
```

**Click删除**
```
若线段被交叉 → 删除"交点到交点的那一小段"（Smart Trim）
若线段无交叉 → 删除整段
```

**关键原则：**
> "删除 = 明确意图，不是副作用"

---

### 第三层：Smart Trim（智能但可控）

**增强功能：**
```
✨ Smart Trim（可选但很值钱）
```

**触发方式：**
```
E + Click：删除最近交点到交点的段
或 T / X（Trim）工具（以后）
```

**行为逻辑：**
```
检测该线段上的所有 intersection points
将线段拆成：A ── I1 ── I2 ── B
只删除用户点击的那一段
其余段保留为独立segment
```

**关键规则：**
```
⚠️ 拆段发生在"删除时"，不是"画线时"
```

---

## 🏗️ 技术方案概要

### 一、数据模型

#### Segment结构

```typescript
type Segment = {
  id: string
  a: Pt
  b: Pt
  kind: 'wall' | 'line' | 'guide'
  locked?: boolean
}
```

**关键点：**
- 先不引入polyline
- 用"多segment"组合
- 支持被拆分

---

### 二、Eraser核心逻辑

#### Hover阶段

```typescript
找最近的segment
计算该segment上的所有交点
判定鼠标落在哪个"交点区间"
高亮对应的sub-segment或整段
```

---

#### Click阶段

```typescript
if (segment has intersections) {
  // 拆成多个sub-segments
  split into subSegments
  // 只删除hover的那一段
  delete hovered subSegment
} else {
  // 删除整段
  delete whole segment
}
```

---

### 三、Intersection计算

**复用现有：**
```
画线时已经在算intersection（snap用）
复用同一套算法
```

**函数签名：**
```typescript
function intersections(seg: Segment, others: Segment[]): Pt[]
```

---

## 📋 Jira Epic拆分

### Epic Key: PS-P0-EDIT-TRIM

**目标：** 让线条编辑行为"可控、可预期、像CAD"

---

### P0-301 — Eraser（E）工具基础

**Scope：**
- 新工具 ERASER
- 明确"删除是用户主动行为"

**实现要点：**
- E进入/退出Eraser
- Hover最近segment
- 不自动修改geometry

**DoD：**
- [ ] E切换工具成功
- [ ] Hover线段有明显反馈
- [ ] Click删除
- [ ] 可Undo/Redo

**验收：**
- 普通线段一键删除
- 可Undo/Redo

---

### P0-302 — Hover高亮最近可删Segment

**Scope：**
- Eraser模式下，hover高亮"将被删除的对象"

**实现要点：**
- 最近距离判定（px threshold）
- 高亮样式由segment.kind决定

**DoD：**
- [ ] hover高亮准确
- [ ] 不误选相邻线

**验收：**
- 放大/缩小时hover精度稳定

---

### P0-303 — Intersection计算与Segment拆分

**Scope：**
- 当被删segment有交点时，支持拆分

**实现要点：**
- 计算交点列表
- 按参数t排序
- 拆成子segments：A ── I1 ── I2 ── B

**DoD：**
- [ ] 拆分正确
- [ ] 原segment被替换
- [ ] 子segments独立存在

**验收：**
- 多交点情况不乱序

---

### P0-304 — Smart Trim：只删hover子段

**Scope：**
- Eraser点击时智能删除

**实现要点：**
- hover时确定sub-segment index
- 删除对应段，其余保留

**DoD：**
- [ ] 不误删其他段
- [ ] 逻辑稳定

**验收：**
- 十字交叉线删除中间段

---

### P0-305 — Guide/辅助线删除规则

**Scope：**
- Guide的删除行为与普通线区分

**实现要点：**
- Guide默认不可被E删除
- 或需按 Alt + E 才可删（二选一）

**DoD：**
- [ ] 不误删guide
- [ ] 行为一致

---

### P1-306 — 扩展：Trim Tool（未来）

**备注：**
- 非本Sprint
- 可独立工具 X / TRIM

---

## 🎨 Hover高亮视觉规则

### 核心原则

> "在你点下去之前，我就告诉你会删什么。"

---

### 1. Eraser模式下Hover规则

#### 普通线段（未拆）

```
线条高亮：红色
线宽：+20%
光标：🧽（橡皮图标）
```

---

#### 有交点的线段

```
仅高亮hover的那一小段
其他段保持正常颜色
```

**用户感知：**
> "我只会删这一段"

---

### 2. Hover到不可删除对象

#### Guide（辅助线）

**默认：**
```
低对比高亮（灰虚线）
Tooltip（0.6s）："Guide (not erasable)"
```

**或需要modifier：**
```
Tooltip："Hold Alt to erase guide"
```

---

### 3. Hover空白区域

```
不显示高亮
光标仍为橡皮（表示工具状态）
```

---

### 4. 删除确认（不弹窗）

```
Hover高亮 = 确认
Click即删
Undo一步回退
```

**关键：**
```
⚠️ 不弹确认框（会破坏流畅性）
```

---

## 📋 自动/不自动拆段白名单

### ❌ 永远不自动拆段（画线时）

| 场景 | 原因 |
|------|------|
| 画线相交 | 避免误伤 |
| guide穿过墙线 | guide是参考 |
| snap到endpoint | 仍不拆 |

**原则：**
> 画线 ≠ 编辑

---

### ✅ 只在"删除意图"下拆段

| 场景 | 是否拆 |
|------|--------|
| E删除有交点线 | ✅ |
| X / Trim工具 | ✅ |
| 批量删除 | ❌（需明确指向） |

---

### ❌ 永不拆的对象

| 对象 | 规则 |
|------|------|
| Guide | 默认不拆 |
| Dimension标注 | 不参与 |
| Locked对象 | 不参与 |

---

### ⚠️ 条件性拆段（以后）

| 场景 | 条件 |
|------|------|
| Delete中间段 | 必须hover明确 |
| 多交点密集 | 需要zoom > 某阈值 |

---

## ✅ 完成定义（DoD）

### 功能DoD

- [ ] **E进入橡皮工具**
  - E切换成功
  - 光标变橡皮

- [ ] **Hover明确高亮**
  - 将被删除的对象高亮
  - 有交点时只高亮子段

- [ ] **Click删除**
  - 删除hover的对象
  - 若有交点：只删子段
  - 若无交点：删整段

- [ ] **Undo/Redo**
  - 可回退删除操作
  - 可重做删除操作

---

### 安全规则DoD

- [ ] **画线相交不自动切断**
  - 默认保持连续
  - 不修改已有geometry

- [ ] **Guide默认不可删**
  - 普通E不能删guide
  - 需Alt + E（或完全禁止）

---

### 体验DoD

- [ ] **用户点之前能看懂会删哪段**
  - hover高亮明确
  - sub-segment区分清晰

- [ ] **删除不需要确认框**
  - hover = 确认
  - click = 执行
  - undo = 撤销

---

## 💬 CPO关键引用

### 关于产品定位

> "有没有'Trim / Erase with intent'是区分「玩具画图」和「施工画图」的关键。"

### 关于产品跃迁

> "这一步直接把 PlanSnap 从'画图工具'推进到'施工级编辑器'。"

### 关于设计原则

> "画线 = 增加，橡皮 = 删除。不允许画线时自动修改旧线。你们坚持这个原则，产品会越来越像CAD。"

### 关于用户体验

> "在你点下去之前，我就告诉你会删什么。"

---

## 📊 与现有功能的关系

### 与Tape工具的关系

**独立但协同：**
```
Tape（T）：生成guide
Eraser（E）：可删除guide（需Alt）
```

**工具切换：**
```
T → E → V 自然切换
不冲突
```

---

### 与Snap系统的关系

**复用Intersection计算：**
```
Snap时已经算intersection
Eraser复用同一套算法
```

---

### 与Undo系统的关系

**必须支持：**
```
删除 → Undo → 恢复
包括拆分的segments
```

---

## 🎓 设计理念

### AutoCAD/SketchUp对标

**共同点：**
1. 默认不自动切断
2. 明确的删除工具（E键）
3. Smart Trim智能切段
4. Hover预览

**差异点：**
```
PlanSnap：更简化，更聚焦
不做：复杂的Trim选项
```

---

### 用户心理模型

**清晰的工具职责：**
```
L（Line）：画线，增加
T（Tape）：辅助线
E（Eraser）：删除，减少
V（Select）：选择，移动
```

**不混淆：**
```
画线时不删除
删除时不画线
```

---

## 📋 行动项

### CTO立即执行（本周后半周）

**优先级：** 🔴 P0

**任务：**
- Day 1-2: P0-301, P0-302（基础Eraser）
- Day 3: P0-303, P0-304（Smart Trim）
- Day 4: P0-305, 测试回归

**参考文档：**
- 本会议纪要
- 完整技术方案（待创建）
- 快速执行清单（待创建）

---

### CDO配合工作

**本周完成：**
- [ ] 创建完整技术方案
- [ ] 创建快速执行清单
- [ ] 更新决策日志
- [ ] 更新文档索引

---

### CPO验收安排

**验收时间：** Day 4

**验收标准（4个问题）：**

1. **线条相交时，会不会"莫名其妙被切断"？**
   - 答案：不应该

2. **用E时，我在点之前，知不知道会删哪一段？**
   - 答案：必须知道

3. **删除中间段，会不会把整面墙删没？**
   - 答案：绝对不能

4. **我能不能放心大胆用Eraser？**
   - 答案：这是成败关键

---

## 🔗 相关文档

**本次会议产出：**
1. 本会议纪要
2. 完整技术方案（待创建）
3. 快速执行清单（待创建）

**相关历史文档：**
1. Tape工具和分数输入（DEC-005）
2. 角度锁定系统（DEC-003, DEC-004）
3. 单位系统（DEC-000）

---

## 🎯 总结

### 核心决策

**三层设计：**
1. **默认行为** - 画线相交不自动切断（安全）
2. **橡皮工具E** - 明确的删除意图
3. **Smart Trim** - 智能切段，只删hover的部分

---

### 产品意义

**从工具到编辑器：**
```
❌ magicplan：不会做这么细
❌ 大多数轻量工具：不敢碰
✅ AutoCAD/SketchUp/Revit：都是这个思路
```

**CPO评价：**
> "这一步直接把 PlanSnap 从'画图工具'推进到'施工级编辑器'。"

---

### 设计原则

**不变的铁律：**
```
画线 = 增加
橡皮 = 删除
画线时不自动修改已有几何
删除前必须明确告知用户
```

---

**会议记录人：** CDO  
**会议时间：** 2026-02-03  
**下次Review：** Day 4（Eraser功能验收）  
**状态：** ✅ 方案已确定，待执行

---

这个决策让PlanSnap从"画图工具"跨越到"施工级编辑器"，是产品定位的重要跃迁！🚀

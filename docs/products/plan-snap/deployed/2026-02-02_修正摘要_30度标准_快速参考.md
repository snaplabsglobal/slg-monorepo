# IsoSnap æŠ€æœ¯ä¿®æ­£æ‘˜è¦ - 30Â° æ ‡å‡†

> **ä¿®æ­£æ—¶é—´ï¼š** 2026-02-02  
> **ä¼˜å…ˆçº§ï¼š** ğŸ”´ Critical  
> **å½±å“ï¼š** Task B2 å¿…é¡»æŒ‰æ–°æ ‡å‡†å®ç°

---

## âš ï¸ å…³é”®å˜åŒ–ï¼ˆä¸€å¥è¯ï¼‰

**ä» 45Â° è§’åº¦æ”¹ä¸º 30Â° æ ‡å‡† isometricï¼ˆå·¥ç¨‹åˆ¶å›¾å›½é™…æ ‡å‡†ï¼‰**

---

## ğŸ“ è§’åº¦å¯¹æ¯”

### âŒ é”™è¯¯ï¼ˆæ—§è®¾è®¡ï¼‰

```
Vertical:    90Â° âœ“
Left-down:   45Â° âœ— (éæ ‡å‡†)
Right-down:  45Â° âœ— (éæ ‡å‡†)
```

### âœ… æ­£ç¡®ï¼ˆæ–°è®¾è®¡ï¼‰

```
Vertical:       90Â°  (æ­£ä¸Š/æ­£ä¸‹)
ISO Right:      30Â°  (å³ä¸Šæ–œ)
ISO Left:      150Â°  (å·¦ä¸Šæ–œ)
```

---

## ğŸ’» ä»£ç ä¿®æ­£ï¼ˆç›´æ¥å¯ç”¨ï¼‰

### 1. Direction æšä¸¾

```typescript
// ä¿®æ­£å‰
enum Direction {
  VERTICAL = 'vertical',
  LEFT_DOWN = 'left-down',    // âœ— 45Â°
  RIGHT_DOWN = 'right-down'   // âœ— 45Â°
}

// ä¿®æ­£å
enum Direction {
  VERTICAL = 'vertical',      // âœ“ 90Â°
  ISO_LEFT = 'iso-left',     // âœ“ 150Â°
  ISO_RIGHT = 'iso-right'    // âœ“ 30Â°
}
```

---

### 2. lockToDirection å‡½æ•°ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰

```typescript
export function lockToDirection(
  startX: number,
  startY: number,
  mouseX: number,
  mouseY: number
): { endX: number; endY: number; direction: Direction } {
  
  const dx = mouseX - startX;
  const dy = mouseY - startY;
  const distance = Math.sqrt(dx * dx + dy * dy);
  
  let angle = Math.atan2(dy, dx) * (180 / Math.PI);
  if (angle < 0) angle += 360;
  
  // åˆ¤æ–­æœ€æ¥è¿‘çš„æ–¹å‘
  if (angle >= 60 && angle < 120) {
    // Vertical (90Â°)
    return {
      endX: startX,
      endY: startY + distance,
      direction: Direction.VERTICAL
    };
  } else if (angle >= 120 && angle < 180) {
    // ISO Left (150Â°)
    const cos150 = Math.cos(150 * Math.PI / 180); // â‰ˆ -0.866
    const sin150 = Math.sin(150 * Math.PI / 180); // = 0.5
    return {
      endX: startX + distance * cos150,
      endY: startY + distance * sin150,
      direction: Direction.ISO_LEFT
    };
  } else {
    // ISO Right (30Â°)
    const cos30 = Math.cos(30 * Math.PI / 180); // â‰ˆ 0.866
    const sin30 = Math.sin(30 * Math.PI / 180); // = 0.5
    return {
      endX: startX + distance * cos30,
      endY: startY + distance * sin30,
      direction: Direction.ISO_RIGHT
    };
  }
}
```

---

### 3. Segment æ•°æ®æ¨¡å‹

```typescript
export interface Segment {
  id: string;
  fromNodeId: string;
  toNodeId: string;
  type: 'drain' | 'vent';
  diameter: '1-1/2"' | '2"' | '3"' | '4"';
  direction: 'vertical' | 'iso-left' | 'iso-right'; // ä¿®æ­£
}
```

---

## ğŸ“‹ CPO çš„å®Œæ•´è¦æ±‚

### 1. ä¸‰æ–¹å‘é”å®šï¼ˆ30Â° isometricï¼‰âœ…
```
Vertical (90Â°)
Isometric Left Axis (150Â° / -30Â°)
Isometric Right Axis (30Â°)
```

### 2. æ‹–åŠ¨æ—¶è‡ªåŠ¨å¸é™„ âœ…
```
å®æ—¶è®¡ç®—æœ€è¿‘çš„åˆæ³•æ–¹å‘
æ˜¾ç¤ºè™šçº¿é¢„è§ˆ
ä¸å…è®¸éæ ‡å‡†è§’åº¦
```

### 3. ç¦æ­¢ä»»ä½•éæ ‡å‡†è§’åº¦ âœ…
```
åªå…è®¸ï¼š90Â°, 30Â°, 150Â° (Â±1Â° å®¹å·®)
å…¶ä»–è§’åº¦ï¼šè‡ªåŠ¨ä¿®æ­£æˆ–æ‹’ç»
```

### 4. å¹³ç§»/æ‹‰ä¼¸ä¿æŒåŸè½´å‘ âœ…
```
æ‹–åŠ¨èŠ‚ç‚¹æ—¶
è¿æ¥çš„çº¿æ®µä¿æŒåŸæ–¹å‘
ä¸ä¼šå‡ºç°éæ ‡å‡†è§’åº¦
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ 30Â°ï¼Ÿ

### å·¥ç¨‹æ ‡å‡†
```
âœ… ISO 5456-3 å›½é™…æ ‡å‡†
âœ… ASME Y14.3 ç¾å›½æ ‡å‡†
âœ… BS 308 è‹±å›½æ ‡å‡†
âœ… Inspector è®¤å¯
âœ… ä¸“ä¸šå½¢è±¡
```

### 45Â° çš„é—®é¢˜
```
âŒ ä¸æ˜¯å·¥ç¨‹æ ‡å‡†
âŒ è§†è§‰æ•ˆæœå·®
âŒ Inspector ä¸è®¤å¯
âŒ çœ‹èµ·æ¥åƒç©å…·
âŒ äº§å“ä»·å€¼å¤§æ‰“æŠ˜æ‰£
```

---

## âœ… éªŒæ”¶æ ‡å‡†ï¼ˆ30Â° æ ‡å‡†ï¼‰

### å¿…é¡»é€šè¿‡çš„æµ‹è¯•

**1. è§’åº¦ç²¾åº¦æµ‹è¯•**
```
ç”»ä¸€æ¡ vertical çº¿ â†’ 90Â° Â±1Â°
ç”»ä¸€æ¡ ISO right çº¿ â†’ 30Â° Â±1Â°
ç”»ä¸€æ¡ ISO left çº¿ â†’ 150Â° Â±1Â°
```

**2. æ–¹å‘ä¿æŒæµ‹è¯•**
```
ç”»ä¸€æ¡ 30Â° çš„çº¿
æ‹–åŠ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹
éªŒè¯ï¼šä»ç„¶æ˜¯ 30Â° (è¯¯å·® < 1Â°)
```

**3. æ— éæ ‡å‡†è§’åº¦**
```
ç”»å¤šæ¡çº¿æ®µ
éªŒè¯ï¼šæ‰€æœ‰è§’åº¦éƒ½æ˜¯ 90Â°/30Â°/150Â°
éªŒè¯ï¼šconsole æ—  warning
```

---

## ğŸš¨ ç»™ CTO çš„å…³é”®æé†’

### è¿™ä¸æ˜¯æŠ€æœ¯é€‰æ‹©ï¼Œæ˜¯äº§å“å®šä½

```
IsoSnap æ˜¯"ä¸“ä¸šå·¥å…·"
â†’ å¿…é¡»ç¬¦åˆå·¥ç¨‹æ ‡å‡†
â†’ å¿…é¡»æ˜¯ 30Â° isometric
â†’ Inspector æ‰ä¼šè®¤å¯

å¦‚æœç”¨ 45Â°ï¼š
â†’ çœ‹èµ·æ¥åƒ"ç©å…·"
â†’ Inspector ä¼šè´¨ç–‘
â†’ äº§å“ä»·å€¼å¤§æ‰“æŠ˜æ‰£
```

---

## ğŸ“ éœ€è¦æ›´æ–°çš„æ–‡ä»¶

1. **/packages/iso-snap/src/types/index.ts**
   - Direction æšä¸¾
   - Segment æ¥å£

2. **/packages/iso-snap/src/utils/directionLock.ts**
   - lockToDirection å‡½æ•°ï¼ˆå®Œæ•´æ›¿æ¢ï¼‰

3. **/packages/iso-snap/src/canvas/IsoCanvas.ts**
   - handleMouseMove
   - createSegment
   - renderSegment

4. **Sprint 1 æŠ€æœ¯ä»»åŠ¡æ¸…å•**
   - Task B2 çš„å®ç°ä»£ç 
   - éªŒæ”¶æ ‡å‡†

---

## ğŸ“ è§†è§‰å‚è€ƒï¼ˆ30Â° isometricï¼‰

```
        â†‘ 
     90Â°|
        |
  â†–    |    â†—
150Â°   |   30Â°
       |
       â€¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
```

**ä¸‰ä¸ªæ ‡å‡†è½´ï¼š**
- Vertical: 90Â° (æ­£ä¸Š/æ­£ä¸‹)
- ISO Right: 30Â° (å³ä¸Šæ–œ)
- ISO Left: 150Â° (å·¦ä¸Šæ–œ)

**120Â° ç­‰é—´è·ï¼Œå¯¹ç§°æ€§å¥½ï¼Œç«‹ä½“æ„Ÿå¼º**

---

## â° å®æ–½æ—¶é—´

**ç«‹å³ä¿®æ­£ï¼ˆå¼€å‘ Task B2 ä¹‹å‰ï¼‰ï¼š**
- [ ] æ›´æ–° Direction æšä¸¾
- [ ] æ›´æ–° lockToDirection å‡½æ•°
- [ ] æ›´æ–°æ•°æ®æ¨¡å‹
- [ ] å†™å•å…ƒæµ‹è¯•éªŒè¯è§’åº¦

**é¢„è®¡æ—¶é—´ï¼š** 0.5å¤©ï¼ˆåœ¨åŸè®¡åˆ’ Task B2 çš„æ—¶é—´å†…ï¼‰

---

## ğŸ’¡ æ•°å­¦é€ŸæŸ¥è¡¨

### 30Â° isometric çš„ä¸‰è§’å‡½æ•°å€¼

```typescript
// 30Â°
cos(30Â°) = âˆš3/2 â‰ˆ 0.866
sin(30Â°) = 1/2 = 0.5

// 150Â° = 180Â° - 30Â°
cos(150Â°) = -âˆš3/2 â‰ˆ -0.866
sin(150Â°) = 1/2 = 0.5

// 90Â°
cos(90Â°) = 0
sin(90Â°) = 1
```

### å¿«é€Ÿè®¡ç®—

```typescript
// ISO Right (30Â°)
endX = startX + distance * 0.866
endY = startY + distance * 0.5

// ISO Left (150Â°)
endX = startX - distance * 0.866
endY = startY + distance * 0.5

// Vertical (90Â°)
endX = startX
endY = startY + distance
```

---

**ç‰ˆæœ¬ï¼š** v1.0  
**ä¿®æ­£æ—¶é—´ï¼š** 2026-02-02  
**çŠ¶æ€ï¼š** âœ… å·²ç¡®è®¤ï¼Œå¾…å®æ–½  

---

**CTOï¼Œè¿™æ˜¯å…³é”®ä¿®æ­£ï¼å¼€å‘ Task B2 ä¹‹å‰ï¼Œè¯·å…ˆå®æ–½è¿™ä¸ªä¿®æ­£ã€‚30Â° æ˜¯å·¥ç¨‹æ ‡å‡†ï¼Œå†³å®šäº† IsoSnap çš„ä¸“ä¸šæ€§ã€‚** ğŸ¯

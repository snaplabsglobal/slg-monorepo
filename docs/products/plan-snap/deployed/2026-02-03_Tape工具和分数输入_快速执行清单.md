# Tape工具和分数输入 - 快速执行清单

> **CTO 5分钟速查卡**  
> **预计工作量：** 5天  
> **优先级：** 🔴 P0 - Critical

---

## ⚡ 一句话目标

**添加两个"画图手感的地基"功能：**
1. **Tape Offset Guides** - SketchUp式平行辅助线
2. **Fraction Input** - 支持 12 1/8 输入，Space不是Esc

**CPO原话：**
> "比继续纠结角度锁更能立刻提升体验、也更容易验收。"

---

## 🎯 本次做什么

### ✅ Tape Offset Guides
```
T进入工具
任意点锁定参照线段
拖拽生成平行虚线（无限延伸）
输入距离（3" / 12 1/8" / 300mm）
Enter提交，Esc取消（不退出工具）
```

### ✅ Fraction Input
```
支持 12 1/8 输入
Typing时Space = 分隔符（不是Esc）
Esc只清buffer，不退出工具
光标附近显示输入
```

---

## ❌ 明确不做

```
不做"沿线测距 Tape measure"
不做"多guide锁定链式偏移"
不做"角度锁定"相关改动（本次冻结）
```

---

## 🔧 核心代码（Copy & Paste）

### 1. Tape状态机

```typescript
type TapeState =
  | { phase: 'IDLE' }
  | { phase: 'HOVER_SEGMENT'; segmentId: string; hoverPoint: Pt }
  | { phase: 'ARMED'; segmentId: string; anchor: Pt; u: Vec; n: Vec }
  | { phase: 'DRAGGING'; /* ... */ dMm: number; previewGuide: Guide }
  | { phase: 'TYPING'; /* ... */ typing: string; dMm?: number }
  | { phase: 'COMMITTED' }
```

---

### 2. Guide数据结构

```typescript
type Guide = {
  id: string
  kind: 'guide'
  p: Pt          // 偏移后的点
  dir: Vec       // 平行方向（单位向量）
  createdAt: number
  source: {
    segmentId: string
    anchor: Pt
    offsetMm: number
  }
}
```

---

### 3. onSegment投影

```typescript
function projectPointToSegment(mouse: Pt, A: Pt, B: Pt) {
  const AB = sub(B, A)
  const AM = sub(mouse, A)
  const lenAB2 = dot(AB, AB)
  let t = dot(AM, AB) / lenAB2
  t = clamp(t, 0, 1)
  return add(A, mul(AB, t))
}
```

---

### 4. 平行方向计算

```typescript
function computeDirections(A: Pt, B: Pt) {
  const AB = sub(B, A)
  const u = normalize(AB)        // 平行方向
  const n = { x: -u.y, y: u.x }  // 法线方向（逆时针90°）
  return { u, n }
}
```

---

### 5. offset距离计算

```typescript
function computeOffset(mouse: Pt, anchor: Pt, n: Vec) {
  const delta = sub(mouse, anchor)
  return dot(delta, n)  // 带符号的距离（mm）
}
```

---

### 6. Space行为修正

```typescript
function onKeyDown(e: KeyboardEvent) {
  if (inputState.mode === 'TYPING') {
    if (e.key === ' ') {
      appendToBuffer(' ')  // ✅ 输入字符
      e.preventDefault()
      return
    }
    if (e.key === 'Escape') {
      clearBuffer()  // ✅ 只清buffer
      setInputState({ mode: 'IDLE' })
      e.preventDefault()
      return
    }
  } else {  // IDLE
    if (e.key === 'Escape') {
      cancelCurrentOperation()  // ✅ 取消操作
    }
  }
}
```

---

### 7. 分数解析器

```typescript
function parseLengthToMM(input: string, defaultUnit: 'in' | 'mm'): number {
  // 支持：
  // - 12 1/8       → 12.125 in → 308.0 mm
  // - 9'6          → 114 in → 2895.6 mm
  // - 9'-6 3/16"   → 114.1875 in → 2900.36 mm
  // - 300mm        → 300 mm
  
  // 检测单位...
  // 解析feet+inch...
  // 解析分数...
  // 转换为mm...
  
  return valueMm
}
```

---

## 📋 5天计划

### Day 1: Tape基础

- [ ] Tape状态机
- [ ] onSegment投影
- [ ] HOVER → ARMED → DRAGGING

**验收：** T进入，hover显示，拖拽预览

---

### Day 2: Guide渲染

- [ ] Guide数据结构
- [ ] 平行方向计算
- [ ] 无限线渲染（视口裁剪）
- [ ] 虚线样式

**验收：** 虚线无限延伸，淡色显示

---

### Day 3: Tape完整

- [ ] Guide Layer
- [ ] Enter提交
- [ ] Esc取消逻辑
- [ ] Snap集成（onGuide）

**验收：** 完整Tape工具，可连续生成

---

### Day 4: 分数输入

- [ ] 输入状态机
- [ ] parseLengthToMM
- [ ] Space/Esc行为修正
- [ ] 工具集成

**验收：** 12 1/8 可输入，Space不取消

---

### Day 5: UI完善+回归

- [ ] Typing Overlay
- [ ] CSS样式
- [ ] Epic回归测试

**验收：** 所有DoD通过

---

## ✅ 验收清单（Epic级）

### Tape工具

- [ ] **T进入工具**
- [ ] **任意点锁定**（非端点/中点）
- [ ] **拖拽生成平行虚线**
- [ ] **输入距离生效**（3" / 12 1/8" / 300mm）
- [ ] **Enter提交guide**
- [ ] **Esc取消但不退出**
- [ ] **可连续生成**

---

### 分数输入

- [ ] **12 1/8不被Space取消**
- [ ] **各种格式都能解析**
  - 12 1/8 → 308.0mm
  - 9'6 → 2895.6mm
  - 9'-6 3/16" → 2900.36mm
  - 300mm → 300mm
- [ ] **Esc只清buffer**
- [ ] **光标附近可见输入**

---

### 回归

- [ ] **Zoom稳定**（guide不漂移）
- [ ] **斜线正确**（平行方向对）
- [ ] **性能**（快速拖拽不卡）

---

## 🚨 关键接线点（必须改）

### 1. 全局Key Routing

**文件：** `src/app/keydown-handler.ts`

**修改：**
```typescript
// 先判断输入状态
if (inputState.mode === 'TYPING') {
  if (e.key === ' ') return appendToBuffer(' ')
  if (e.key === 'Escape') return clearBuffer()
}
```

---

### 2. Tape工具新增

**文件：** `src/tools/tape-guide-tool.ts`（新建）

**实现：**
- 状态机
- onSegment投影
- 平行guide生成
- 数值输入集成

---

### 3. Guide Layer

**文件：** `src/store/guides-slice.ts`（新建）

**实现：**
- `guides: Guide[]`
- `addGuide() / removeGuide()`

---

### 4. Inference扩展

**文件：** `src/inference/infer-engine.ts`

**添加：**
- `inferOnGuide()`
- `inferGuideIntersection()`

---

## 🧪 快速测试用例

### TC-1: Tape基础
```
操作：T → hover线段 → 点击 → 拖拽
期望：预览虚线显示，平行于原线段
```

### TC-2: 数值输入
```
操作：锁定 → 输入"3" → Enter
期望：生成距离3"的guide
```

### TC-3: 分数输入
```
操作：锁定 → 输入"12 1/8" → Enter
期望：生成距离12.125"的guide
```

### TC-4: Space不取消
```
操作：输入"12" → Space → 输入"1/8"
期望：buffer = "12 1/8"，没有取消
```

### TC-5: Esc行为
```
操作：输入"123" → Esc
期望：buffer清空，工具不退出
```

### TC-6: 连续生成
```
操作：生成guide1 → Enter → 再生成guide2
期望：两个guide都存在，不互相干扰
```

---

## 📊 完整文案表

### Tape状态

| 阶段 | 显示 |
|------|------|
| HOVER | "On Segment" |
| ARMED | 锁定标记 |
| DRAGGING | 距离数字 + 预览虚线 |
| TYPING | 输入buffer |

---

### 输入格式

| 输入 | 解析结果 |
|------|---------|
| `12 1/8` | 308.0 mm |
| `1/8` | 3.175 mm |
| `9'6` | 2895.6 mm |
| `9'-6 3/16"` | 2900.36 mm |
| `300mm` | 300 mm |
| `2.3m` | 2300 mm |

---

## 🎨 Guide视觉样式

```css
Guide样式：
  - 颜色：rgba(100, 100, 255, 0.5)（淡蓝）
  - 线宽：0.5px
  - 样式：虚线 [4, 4]
  - 延伸：无限（渲染时裁剪到视口）
```

---

## 💬 CPO关键引用

### 关于优先级
> "这两项是'画图手感的地基'，比继续纠结角度锁更能立刻提升体验。"

### 关于Scope
> "本次只做两个P0，角度锁本次冻结不动。"

### 关于Space
> "Space只在IDLE才能当取消，在TYPING必须是输入字符。这条规则是核心。"

---

## 📞 有问题？

- 状态机 → 看完整文档第A.一节
- 算法 → 看完整文档第A.三节
- 输入 → 看完整文档第B节
- 测试 → 看完整文档测试用例章节

---

**开始干活！** 🚀

完整文档：`2026-02-03_技术方案_Tape工具和分数输入_CTO执行版.md`

# PlanSnap 决策日志

> **文档类型：** 决策日志  
> **维护者：** CDO  
> **最后更新：** 2026-02-03

---

## 📋 决策记录格式

每条决策记录包含：
- **决策编号** - 唯一标识
- **决策日期** - 做出决策的日期
- **决策类型** - 产品/技术/架构/流程
- **优先级** - P0/P1/P2/P3
- **决策内容** - 简明扼要的决策
- **背景** - 为什么需要这个决策
- **影响范围** - 影响哪些模块/人员
- **状态** - 已执行/执行中/已取消

---

## 2026-02-03

### DEC-007: 标注系统精度和交互改进 🔴 P0

**决策日期：** 2026-02-03  
**决策类型：** Bug修复 + 功能改进  
**决策者：** CEO  
**状态：** ✅ 已确定

---

#### 问题描述

**问题1：精度丢失**
```
实际画的：36-1/4"
标注显示：3' 或 3'-0"（分数丢失）
```

**问题2：交互简陋**
```
不能选择标注方向（上/下/左/右）
不能拖动偏移距离
```

**CEO明确要求：**
> "标注应该像 SketchUp 那样是可以选择方向和拉伸的。"

---

#### 决策内容

**精度修复：**
```
1. 确保数值来自世界坐标真实距离（mm）
2. 添加精度设置（1/2", 1/4", 1/8", 1/16"）
3. 正确的分数格式化函数
4. 默认精度：1/16"
```

**交互改进：**
```
1. 三段式交互：Pick A → Pick B → Place
2. 鼠标移动选择方向（上/下/左/右）
3. 放置后可拖动偏移
4. 可输入偏移值（复用分数输入）
5. 快捷键：F/X翻转方向（可选）
```

---

#### 技术要点

**数据来源（唯一真相）：**
```typescript
// ✅ 正确
const lenMm = distance(dim.a, dim.b)

// ❌ 错误
const lenMm = pixelDist * mmPerPixel  // 不从像素
const lenMm = gridCount * gridStepMm  // 不从grid
```

**格式化规则：**
```
内部存储：mm（double）
显示格式化：按precision四舍五入
36.25" 在1/16"精度 → "3'-0 1/4"" 或 "36 1/4""
```

**状态机：**
```
IDLE → PICK_A → PICK_B → PLACE → COMMITTED
Place阶段：鼠标移动选择方向+偏移
```

---

#### Jira Epic

**Epic Key：** PS-P0-DIMENSION-FIX

**Tickets：**
- P0-401: 标注精度修复（紧急）
- P0-402: 显示精度设置
- P0-403: 三段式交互
- P0-404: 拖动偏移标注线
- P0-405: 输入偏移值
- P1-406: 翻转和锁定（可选）

---

#### 执行计划

**工作量：** 2-3天

**Day 1：** 精度修复（紧急）  
**Day 2：** 三段式交互  
**Day 3：** 拖动和输入偏移

---

#### 影响范围

**修改文件：**
- `format-length.ts`（formatter修复）
- `dimension.ts`（数据来源检查）
- `dimension-tool.ts`（三段式状态机）
- `toolbar.tsx`（精度设置UI）

**复用组件：**
- `parseLengthToMM`（分数输入解析器）

---

#### 验收标准

**精度验收：**
- [ ] 36-1/4" 正确显示（不是3'）
- [ ] 精度可调（1/2", 1/4", 1/8", 1/16"）
- [ ] 缩放不影响数值

**交互验收：**
- [ ] 三段式流畅（Pick A → Pick B → Place）
- [ ] 方向可选（上/下/左/右）
- [ ] 可拖动偏移
- [ ] 可输入偏移值

---

#### 参考文档

- [会议纪要] `2026-02-03_会议纪要_标注系统精度和交互改进.md`
- [快速清单] `2026-02-03_标注系统改进_快速执行清单.md`

---

#### 关键引用

**CEO关于精度：**
> "标注的精度不对，应该按照实际尺寸。右侧我实际画的是36-1/4"不是3'。"

**CEO关于交互：**
> "这个标注应该像 SketchUp 那样是可以选择方向和拉伸的。"

---

### DEC-006: Eraser/Trim 工具设计 🔴 P0

**决策日期：** 2026-02-03  
**决策类型：** 产品设计决策  
**决策者：** CPO  
**状态：** ✅ 已确定

---

#### 决策内容

**核心策略：** 三层设计

**第一层：默认行为（安全）**
```
画线相交 → 不自动切断
视觉上只是交叉
保持线段完整性
```

**第二层：橡皮工具 E（明确修改）**
```
E = Eraser（像SketchUp）
Hover → 高亮可删部分
Click → 删除（整段或智能子段）
```

**第三层：Smart Trim（智能但可控）**
```
有交点 → 只删hover的那一段
无交点 → 删整段
拆段发生在"删除时"，不是"画线时"
```

---

#### 背景

**核心问题：**
> "线段相交时，要不要自动切断？"

**CPO明确指出：**
> "有没有'Trim / Erase with intent'是区分「玩具画图」和「施工画图」的关键。这一步直接把 PlanSnap 从'画图工具'推进到'施工级编辑器'。"

---

#### 设计原则

**铁律：**
```
画线 = 增加
橡皮 = 删除
画线时不自动修改已有几何
删除前必须明确告知用户
```

**用户体验：**
> "在你点下去之前，我就告诉你会删什么。"

---

#### 技术要点

**数据结构：**
```typescript
type Segment = {
  id: string
  a: Pt
  b: Pt
  kind: 'wall' | 'line' | 'guide'
  locked?: boolean
}
```

**核心逻辑：**
```
Hover：找最近segment + 确定sub-segment
Click：拆分（如有交点）+ 删除目标段
```

---

#### 自动/不自动拆段白名单

**❌ 永远不自动拆段（画线时）：**
- 画线相交
- guide穿过墙线
- snap到endpoint

**✅ 只在"删除意图"下拆段：**
- E删除有交点线 ✅
- X / Trim工具 ✅
- 批量删除 ❌

**❌ 永不拆的对象：**
- Guide（默认）
- Dimension标注
- Locked对象

---

#### Jira Epic

**Epic Key：** PS-P0-EDIT-TRIM

**Tickets：**
- P0-301: Eraser工具基础
- P0-302: Hover高亮
- P0-303: Intersection计算与拆分
- P0-304: Smart Trim
- P0-305: Guide删除规则
- P1-306: Trim Tool（未来）

---

#### 执行计划

**工作量：** 3-4天

**Day 1:** Eraser基础（E键、hover、整段删除）  
**Day 2:** Intersection和拆分  
**Day 3:** Smart Trim（子段删除）  
**Day 4:** 完善和测试

---

#### 影响范围

**新增组件：**
- EraserTool（新工具）
- Smart Trim算法

**修改文件：**
- ToolManager（工具注册）
- KeydownHandler（E键绑定）
- Intersection（复用现有）
- UndoManager（支持拆分操作）

---

#### CEO验收标准（4个问题）

1. **线条相交时，会不会"莫名其妙被切断"？**
   - 答案：不应该

2. **用E时，我在点之前，知不知道会删哪一段？**
   - 答案：必须知道

3. **删除中间段，会不会把整面墙删没？**
   - 答案：绝对不能

4. **我能不能放心大胆用Eraser？**
   - 答案：这是成败关键

---

#### 参考文档

- [会议纪要] `2026-02-03_会议纪要_Eraser和Trim工具设计.md`
- [技术方案] `2026-02-03_技术方案_Eraser和Trim_CTO执行版.md`
- [快速清单] `2026-02-03_Eraser和Trim_快速执行清单.md`

---

#### 关键引用

**CPO关于产品跃迁：**
> "这一步直接把 PlanSnap 从'画图工具'推进到'施工级编辑器'。"

**CPO关于产品判断：**
> "这一套'不自动切 + 明确Erase/Trim'决策：magicplan不会做这么细，大多数轻量工具不敢碰，AutoCAD / SketchUp / Revit都是这个思路。"

---

### DEC-005: Tape工具和分数输入优先级调整 🔴 P0

**决策日期：** 2026-02-03  
**决策类型：** 战略调整  
**决策者：** CPO  
**状态：** ✅ 已确定

---

#### 决策内容

**战略调整：**
```
优先实现 Tape工具 + 分数输入
角度锁定并行推进（已有完整方案）
```

**核心功能：**

**A. Tape Offset Guides**
```
T进入工具
任意点锁定参照线段
拖拽生成平行虚线（无限延伸）
输入距离（支持分数）
Enter提交，Esc取消（不退出工具）
```

**B. Fraction Input**
```
支持 12 1/8 英制分数输入
Typing时Space = 分隔符（不是Esc）
Esc只清buffer，不退出工具
光标附近显示输入
```

**明确不做：**
```
❌ 不做"沿线测距 Tape measure"
❌ 不做"多guide锁定链式偏移"
❌ 不做"角度锁定"相关改动（本次冻结）
```

---

#### 背景

**CPO明确指出：**
> "Tape 平行辅助线 + 分数输入/空格确实是'画图手感的地基'，比继续纠结角度锁更能立刻提升体验、也更容易验收。"

**原因：**
1. 角度锁定已有完整方案（DEC-003和DEC-004）
2. Tape和分数输入是基础能力，影响所有绘图场景
3. 更容易验收（功能明确，效果可见）
4. 直接对标SketchUp，用户熟悉度高

---

#### 技术要点

**Tape状态机：**
```
IDLE → HOVER_SEGMENT → ARMED → DRAGGING → TYPING → COMMITTED
任何状态 + Esc → 回到HOVER/IDLE（不退出工具）
```

**Guide数据结构：**
```typescript
type Guide = {
  id: string
  kind: 'guide'
  p: Pt          // 偏移后的点
  dir: Vec       // 平行方向
  source: {
    segmentId: string
    anchor: Pt
    offsetMm: number
  }
}
```

**Space行为关键规则：**
```
TYPING状态：Space = 分隔符
IDLE状态：Space = 可能的取消（可选）
```

---

#### 执行计划

**5天计划：**
- Day 1-2: Tape基础 + Guide渲染
- Day 3: Tape完整功能 + Snap集成
- Day 4: 分数输入系统
- Day 5: UI完善 + Epic回归

**工作量：** 5天

---

#### 影响范围

**新增组件：**
- TapeGuideTool（新工具）
- Guide Layer（独立layer）
- InputState（全局状态机）
- parseLengthToMM（统一解析器）

**修改文件：**
- 全局Key Routing（Space/Esc行为）
- Inference Engine（onGuide推断）
- Canvas渲染（无限线裁剪）

---

#### 参考文档

- [会议纪要] `2026-02-03_会议纪要_画图手感升级_Tape和分数输入.md`
- [技术方案] `2026-02-03_技术方案_Tape工具和分数输入_CTO执行版.md`
- [快速清单] `2026-02-03_Tape工具和分数输入_快速执行清单.md`

---

#### 关键引用

**CPO关于优先级：**
> "这两项是'画图手感的地基'，比继续纠结角度锁更能立刻提升体验、也更容易验收。"

**CPO关于Scope：**
> "本次只做两个P0，角度锁本次冻结不动。"

**CPO关于Space行为：**
> "Space只在IDLE才能当取消，在TYPING必须是输入字符。这条规则是核心。"

---

### DEC-004: 角度锁定UI/UX交互规范 🔴 P0

**决策日期：** 2026-02-03  
**决策类型：** UI/UX设计  
**决策者：** CPO  
**状态：** ✅ 已确定

---

#### 决策内容

**核心目标：**
```
让用户"感觉到"角度被锁死，而不只是"理论上正确"
```

**三个必须实现的组件：**
1. **光标附近角度提示** - 跟随鼠标，显示当前状态
2. **线条颜色变化** - 被控制的线看起来就不一样
3. **Shift增强提示** - Toast提示"ORTHO MODE"

**文案规范（必须原样）：**
```
FREE → 不显示
SNAP → "45°"（浅蓝）
ORTHO → "ORTHO 90°"（深蓝）
LOCKED → "LOCKED 30°"（最深蓝）
```

**线条样式：**
```
FREE → #333（深灰）
SNAP → #4A9EFF（浅蓝）
ORTHO → #2A7FFF（深蓝）
LOCKED → #1F5EFF（深蓝）+ 加粗15%
```

---

#### 背景

**问题：**
- 角度锁定算法已经正确
- 但用户"感觉不到"被锁定
- 缺少明确的视觉反馈

**CPO明确要求：**
> "算法已经通过，现在这不是'技术问题'，是'信任感问题'。我们需要把 Angle Lock 做到像 SketchUp 一样让人安心。"

---

#### 设计原则

**三条铁律：**
1. **状态必须"说话"** - 不靠感觉，不靠教程
2. **文字 > 图标** - 图标可以没有，但文字必须有
3. **短、硬、工程感** - 不要营销文案，只要工程语言

---

#### 影响范围

**新增组件：**
- `AngleHUD` - 光标提示组件
- `StatusBar` - 状态栏组件
- `deriveAngleHUD()` - HUD数据派生函数
- `getPreviewStrokeStyle()` - 线条样式函数

**修改文件：**
- Reducer（集成HUD派生）
- Canvas渲染（应用线条颜色）
- CSS样式文件（新增样式）

---

#### 验收标准

**CEO验收（最重要）：**
```
CEO（非CTO）测试：
1. 打开PlanSnap
2. 画3条线
3. 不看文档

问题：能明确感知什么时候线是"被控制的"吗？

✅ Yes → 通过
❌ "好像有，但不确定" → 返工
```

**录屏验收：**
```
如果用户在录屏里看不出来锁角 → 不通过
```

---

#### 执行计划

**立即执行（1.5天）：**
- [ ] 核心HUD组件（0.5天）
- [ ] 视觉反馈（0.5天）
- [ ] Shift增强+状态栏（0.5天）

---

#### 参考文档

- [UI规范] `2026-02-03_UI规范_角度锁定交互体验_CTO执行版.md`
- [快速清单] `2026-02-03_UI规范_角度锁定交互体验_快速清单.md`

---

#### 关键引用

**CPO关于设计原则：**
> "状态必须'说话'，不靠感觉，不靠教程，状态自己告诉用户。文字 > 图标。短、硬、工程感。"

**CPO关于Shift：**
> "Shift = 用户说了算，这是 CAD 的基本尊重。"

---

### DEC-003: 角度锁定系统架构修正 🔴 P0

**决策日期：** 2026-02-03  
**决策类型：** 技术架构  
**决策者：** CPO + CTO + CDO  
**状态：** ✅ 已执行

---

#### 决策内容

**核心决策：**
1. 角度锁定必须是"最终裁决者"，不是"建议"
2. 当 `isSnapped === true` 时，禁止任何后续逻辑修改 end point
3. Grid snap 在角度锁定期间完全禁用

**优先级顺序（最终版）：**
```
Typed Length → Explicit Lock → Shift Ortho → Inference → Smart Angle Snap → Free
```

**关键规则：**
- Shift 必须纯正交（只返回 0°/90°/180°/270°）
- 22.5° 不在默认角度集合（仅 Advanced 模式）
- Grid 永远不能破坏角度约束

---

#### 背景

**问题：**
- 用户反馈"角度并没有锁定"
- 画竖线时仍出现 89°/91° 偏移
- Shift 按下时不是纯正交

**根因分析：**
1. CDO文档优先级描述前后矛盾（30%责任）
2. CTO实现架构错位 - 角度锁定结果被后续逻辑覆盖（70%责任）

**关键发现：**
> "角度其实'算对了'，但在同一个 `inferDraw()` 里被后续的 inference / grid 逻辑'又改掉了'。"

---

#### 影响范围

**代码层面：**
- `inferDraw()` 函数
- `applyAngleSnap()` 函数
- Grid snap 逻辑
- POINTER_MOVE reducer

**文档层面：**
- `2026-02-03_技术方案_角度锁定系统_CTO执行版.md`（需修正）
- `2026-02-03_角度锁定系统_快速执行清单.md`（需修正）

**验收层面：**
- 画竖线必须自动吸附 90°
- Shift 只能画 0°/90°/180°/270°
- 不误吸 22.5°（默认模式）

---

#### 执行计划

**立即修复（2小时）：**
- [ ] `inferDraw()` 添加 `isSnapped` 判断
- [ ] Grid 条件改为 `!isSnapped && gridEnabled`
- [ ] 添加 Debug overlay

**后续重构（4小时）：**
- [ ] 迁移到 `computeFinalEnd()` 统一函数
- [ ] 重构 POINTER_MOVE reducer
- [ ] 添加单元测试

---

#### 参考文档

- [会议纪要] `2026-02-03_会议纪要_角度锁定问题诊断_紧急修复.md`
- [最小修复] `2026-02-03_代码_角度锁定最小修复补丁.md`
- [完整实现] `2026-02-03_代码_完整computeFinalEnd实现.ts`

---

#### 经验教训

**架构层面：**
- 约束系统必须有"最终裁决权"，不是"建议权"
- 同一帧不允许多处修改同一个值

**文档层面：**
- 优先级描述必须前后一致
- 代码示例必须经过验证
- 禁止项必须明确列出

**流程层面：**
- CDO 发布技术方案前，CTO Review 代码示例
- CTO 实现关键功能后，先自测 Debug overlay
- 涉及"优先级"的功能，必须配单元测试

---

## 2026-02-03 早期

### DEC-002: 角度集配置与22.5°处理 🟡 P1

**决策日期：** 2026-02-03  
**决策类型：** 产品设计  
**决策者：** CPO  
**状态：** ✅ 已确定

---

#### 决策内容

**默认角度集（architectural）：**
```
0° / 30° / 45° / 60° / 90°
```

**22.5° 处理：**
- ❌ 不在默认集合
- ✅ 仅在 Advanced 模式启用
- 理由：增加误吸附概率，降低画图手感

**容差设置：**
- ±3°（推荐值）
- 超过容差才算自由角度

---

#### 背景

**用户需求：**
> "能不能锁定线条角度，30,45,60,90，我最讨厌线条无规则乱画"

**CPO分析：**
- 22.5° 不是"建筑直觉角度"
- 默认加 22.5° 会增加误吸附
- AutoCAD / SketchUp 也不默认 22.5°

**CPO决策：**
> "22.5° 是'能力'，不是'默认权力'"

---

#### 影响范围

**角度集定义：**
```typescript
const ANGLE_SETS = {
  basic: { angles: [0, 90] },
  architectural: { angles: [0, 30, 45, 60, 90] },  // 默认
  advanced: { angles: [0, 22.5, 30, 45, 60, 90] }
}
```

**用户设置：**
- 默认：architectural
- 可选：basic / advanced
- 快捷键：A 键循环切换

---

#### 参考文档

- [产品讨论] 聊天记录（CPO关于22.5°的分析）
- [技术方案] `2026-02-03_技术方案_角度锁定系统_CTO执行版.md`

---

### DEC-001: 角度锁定优先级顺序 🔴 P0

**决策日期：** 2026-02-03  
**决策类型：** 技术架构  
**决策者：** CPO + CTO  
**状态：** ⚠️ 已修正（原版有误）

---

#### 决策内容（修正后）

**最终优先级顺序：**
```
1. Typed Length（用户明确输入长度）
2. Explicit Angle Lock（显式角度锁定）
3. Shift Ortho（强制正交）
4. Inference（parallel/perpendicular方向约束）
5. Smart Angle Snap（智能角度吸附）
6. Free（自由绘制）
```

**关键变更：**
- ✅ Shift 必须优先于 Smart Angle Snap
- ✅ Shift 必须纯正交（不调用通用 snapAngle）
- ❌ 原文档写的 Smart Snap > Shift 是错误的

---

#### 背景

**原版问题：**
- 文档一处写 "Shift > Smart Snap"
- 另一处写 "Smart Snap > Shift"
- CTO 按后者实现，导致 Shift 不纯正交

**修正理由：**
- AutoCAD / SketchUp 的 Shift 是最高优先级正交
- 用户按 Shift 就是明确要求 0°/90°
- 不能被 Smart Snap 的 30°/45°/60° 干扰

---

#### 影响范围

**代码修改：**
```typescript
// ❌ 错误（原版）
if (shift) {
  const { snappedAngle } = snapAngle(angle, 90)  // 会吸到非正交角
}

// ✅ 正确（修正后）
if (shift) {
  const theta = snapToOrtho(rawAngle)  // 只返回0/90/180/270
}
```

**验收标准：**
- 按 Shift 只能画 0°/90°/180°/270°
- Debug 显示 `source: shift`
- 不会被吸到 30°/45°/60°

---

#### 参考文档

- [会议纪要] `2026-02-03_会议纪要_角度锁定问题诊断_紧急修复.md`
- [原版文档] `2026-02-03_技术方案_角度锁定系统_CTO执行版.md`（待修正）

---

## 历史决策（早期）

### DEC-000: 单位系统架构（已完成）

**决策日期：** 2026-02-02  
**决策类型：** 技术架构  
**状态：** ✅ 已执行

详见：`2026-02-02_单位系统技术规范_CTO执行版.md`

---

## 📊 决策统计

**按状态：**
- ✅ 已执行：3 条
- ⚠️ 已修正：1 条
- 🚧 执行中：0 条

**按优先级：**
- 🔴 P0：2 条
- 🟡 P1：1 条
- 🟢 P2：0 条

**按类型：**
- 技术架构：3 条
- 产品设计：1 条

---

## 🔄 文档维护

**更新频率：**
- 重大决策：立即记录
- 小型决策：每周汇总

**Review频率：**
- 每月回顾一次决策日志
- 确保决策执行情况跟踪

**维护责任：**
- CDO：记录和维护
- CPO/CTO：Review和确认

---

**最后更新：** 2026-02-03  
**下次Review：** 2026-03-03

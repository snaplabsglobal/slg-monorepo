# è§’åº¦é”å®šé—®é¢˜ - æœ€å°ä¿®å¤è¡¥ä¸

> **æ‰§è¡Œæ—¶é—´ï¼š** ç«‹å³ï¼ˆ2å°æ—¶å†…å®Œæˆï¼‰  
> **ä¼˜å…ˆçº§ï¼š** ğŸ”´ P0 - Critical  
> **å·¥ä½œé‡ï¼š** 2å°æ—¶  
> **ç›®æ ‡ï¼š** è®©è§’åº¦é”å®šç«‹å³ç”Ÿæ•ˆ

---

## âš¡ ä¸€å¥è¯ä¿®å¤æ–¹æ¡ˆ

**é—®é¢˜ï¼š** è§’åº¦é”å®šç»“æœè¢«åç»­çš„inferenceå’Œgridè¦†ç›–  
**è§£å†³ï¼š** å½“ `isSnapped === true` æ—¶ï¼Œç¦æ­¢ä»»ä½•åç»­é€»è¾‘ä¿®æ”¹end point

---

## ğŸ”§ ä¿®æ”¹ç‚¹1ï¼šinferDraw() æ·»åŠ ç¡¬åˆ¤æ–­

### å½“å‰ä»£ç ä½ç½®

æ‰¾åˆ°ä½ çš„ `inferDraw()` å‡½æ•°ï¼Œå¤§æ¦‚åœ¨è¿™ä¸ªä½ç½®ï¼š

```typescript
inferDraw(start, mouse, draft, settings) {
  const angleResult = applyAngleSnap(...)
  const cx = angleResult.point.x
  const cy = angleResult.point.y
  
  const inf = this.infer(cx, cy, ...)  // âŒ è¿™é‡Œä¼šè¦†ç›–
  // ...
}
```

---

### ä¿®æ”¹ä¸º

```typescript
inferDraw(start, mouse, draft, settings) {
  // 1. å…ˆæ‰§è¡Œè§’åº¦é”å®š
  const angleResult = applyAngleSnap(
    start, 
    mouse, 
    {
      shiftPressed: draft.shiftOrtho ?? false,
      currentAngleLock: draft.explicitAngleDeg,
      tolerance: settings.angleToleranceDeg ?? 3
    }
  )
  
  // 2. âœ… å…³é”®ä¿®æ”¹ï¼šå¦‚æœè§’åº¦å·²é”å®šï¼Œç›´æ¥è¿”å›ï¼Œä¸å†å¤„ç†
  if (angleResult.isSnapped) {
    return {
      type: angleResult.mode,  // 'shift' | 'explicit' | 'smart'
      point: angleResult.point,
      angleDeg: angleResult.angleDeg,
      isSnapped: true,
      // ğŸ“Š æ·»åŠ debugä¿¡æ¯
      debug: {
        rawDeg: angleResult.debug?.rawDeg,
        snappedDeg: angleResult.angleDeg,
        source: angleResult.mode
      }
    }
  }
  
  // 3. è§’åº¦æœªé”å®šï¼Œæ‰æ‰§è¡Œå‡ ä½•æ¨æ–­
  const inf = this.infer(mouse.x, mouse.y, ...)
  
  // 4. è¿”å›æ¨æ–­ç»“æœ
  return inf
}
```

---

### å…³é”®ç‚¹

**âœ… æ·»åŠ çš„åˆ¤æ–­ï¼š**
```typescript
if (angleResult.isSnapped) {
  return {
    type: angleResult.mode,
    point: angleResult.point,  // ç›´æ¥è¿”å›é”è§’ç»“æœ
    // ...
  }
}
```

**ğŸš« ä¸å†æ‰§è¡Œçš„é€»è¾‘ï¼š**
- `this.infer(...)` - å‡ ä½•æ¨æ–­
- Grid snap - ç½‘æ ¼å¸é™„
- ä»»ä½•å…¶ä»–å¯èƒ½ä¿®æ”¹pointçš„æ“ä½œ

---

## ğŸ”§ ä¿®æ”¹ç‚¹2ï¼šGrid snapæ¡ä»¶ä¿®æ­£

### å½“å‰ä»£ç ä½ç½®

æ‰¾åˆ°Grid snapçš„æ‰§è¡Œä½ç½®ï¼Œå¯èƒ½ç±»ä¼¼ï¼š

```typescript
if (gridEnabled) {
  // æŠ•å½±åˆ°grid
  point = snapToGrid(point)
}
```

æˆ–ï¼š

```typescript
if (angleResult.isSnapped) {
  // æ²¿è§’åº¦æŠ•å½±åˆ°grid  âŒ è¿™ä¼šç ´åè§’åº¦
  point = projectToGrid(angleResult.point, angle)
}
```

---

### ä¿®æ”¹ä¸º

```typescript
// âœ… æ­£ç¡®ï¼šåªåœ¨è§’åº¦æœªé”å®šæ—¶æ‰å…è®¸Grid snap
if (!angleResult.isSnapped && gridEnabled) {
  point = snapToGrid(point)
}
```

**æˆ–è€…å®Œå…¨ç§»é™¤Grid snapåœ¨è§’åº¦é”å®šæ—¶çš„æ‰§è¡Œï¼š**

```typescript
// âŒ åˆ é™¤è¿™æ®µ
if (angleResult.isSnapped) {
  point = projectToGrid(angleResult.point, angle)
}
```

---

### å…³é”®è§„åˆ™

```
âœ… è§’åº¦é”å®š + Gridç¦ç”¨
âŒ è§’åº¦é”å®š + Gridå¯ç”¨ï¼ˆä¼šç ´åè§’åº¦ï¼‰
```

**è®°ä½ï¼š**
> "Gridæ°¸è¿œä¸èƒ½ç ´åè§’åº¦çº¦æŸ"

---

## ğŸ”§ ä¿®æ”¹ç‚¹3ï¼šæ·»åŠ Debug Overlay

### ç›®çš„

è®©ä½ ç«‹å³çœ‹åˆ°ï¼š
- è§’åº¦æ˜¯å¦çœŸçš„é”å®šäº†
- é”å®šæ¥æºæ˜¯ä»€ä¹ˆ
- æœ€ç»ˆè§’åº¦æ˜¯å¤šå°‘

---

### ä»£ç å®ç°

**åœ¨Canvasæ¸²æŸ“å±‚æ·»åŠ ï¼š**

```typescript
// åœ¨é¼ æ ‡å…‰æ ‡é™„è¿‘æ˜¾ç¤ºdebugä¿¡æ¯
function renderDebugOverlay(ctx: CanvasRenderingContext2D, debug: DebugInfo, mousePos: Vec2) {
  if (!debug) return
  
  const x = mousePos.x + 20
  const y = mousePos.y - 20
  
  // èƒŒæ™¯
  ctx.fillStyle = 'rgba(0, 0, 0, 0.8)'
  ctx.fillRect(x, y - 60, 150, 70)
  
  // æ–‡å­—
  ctx.fillStyle = '#fff'
  ctx.font = '12px monospace'
  ctx.fillText(`Raw: ${debug.rawDeg.toFixed(1)}Â°`, x + 5, y - 40)
  ctx.fillText(`Snap: ${debug.snappedDeg?.toFixed(1) ?? 'null'}Â°`, x + 5, y - 20)
  ctx.fillText(`Source: ${debug.source}`, x + 5, y)
  
  // å¦‚æœé”å®šäº†ï¼Œæ˜¾ç¤ºç»¿è‰²æ ‡è®°
  if (debug.snappedDeg !== null) {
    ctx.fillStyle = '#0f0'
    ctx.fillRect(x - 5, y - 60, 3, 70)
  }
}
```

---

### è°ƒç”¨ä½ç½®

åœ¨ `POINTER_MOVE` å¤„ç†ä¸­ï¼š

```typescript
case 'POINTER_MOVE': {
  const hover = infer(state, world)
  if (state.draft.start) {
    const result = this.inferDraw(state.draft.start, world, state.draft, state.settings)
    
    // âœ… æ·»åŠ debugä¿¡æ¯åˆ°state
    return { 
      ...state, 
      hover,
      draft: { 
        ...state.draft, 
        end: result.point 
      },
      debug: result.debug  // ä¼ é€’ç»™æ¸²æŸ“å±‚
    }
  }
  return { ...state, hover }
}
```

---

### éªŒæ”¶æ ‡å‡†

**çœ‹åˆ°è¿™ä¸ªå°±æ˜¯å¯¹çš„ï¼š**
```
Raw: 87.2Â°
Snap: 90.0Â°
Source: smart
```

**çœ‹åˆ°è¿™ä¸ªè¯´æ˜æœ‰é—®é¢˜ï¼š**
```
Raw: 87.2Â°
Snap: 90.0Â°
Source: smart

ä½†çº¿æ¡ä»ç„¶æ˜¯ 87.2Â° â†’ è¯´æ˜åç»­è¢«è¦†ç›–äº†
```

---

## âœ… éªŒæ”¶æ¸…å•ï¼ˆ3ä¸ªåœºæ™¯ï¼‰

### åœºæ™¯1ï¼šç”»ç«–çº¿è‡ªåŠ¨å¸é™„

**æ“ä½œï¼š**
1. ä» (0, 0) å¼€å§‹ç”»çº¿
2. é¼ æ ‡ç§»åŠ¨åˆ° (100, 2)ï¼ˆæ¥è¿‘å‚ç›´ä½†å¾®åï¼‰
3. è§‚å¯Ÿ

**æœŸæœ›ï¼š**
```
Debugæ˜¾ç¤ºï¼š
  Raw: 88.9Â°
  Snap: 90.0Â°
  Source: smart

çº¿æ¡ï¼šå®Œå…¨å‚ç›´ï¼ˆ90Â°ï¼‰
```

---

### åœºæ™¯2ï¼šShiftå¼ºåˆ¶æ­£äº¤

**æ“ä½œï¼š**
1. ä» (0, 0) å¼€å§‹ç”»çº¿
2. æŒ‰ä½Shift
3. é¼ æ ‡ç§»åŠ¨åˆ° (100, 50)ï¼ˆå¤§æ¦‚45Â°æ–¹å‘ï¼‰
4. è§‚å¯Ÿ

**æœŸæœ›ï¼š**
```
Debugæ˜¾ç¤ºï¼š
  Raw: 26.6Â°
  Snap: 0.0Â°ï¼ˆæˆ–90.0Â°ï¼Œå–æœ€è¿‘çš„ï¼‰
  Source: shift

çº¿æ¡ï¼šå®Œå…¨æ°´å¹³æˆ–å‚ç›´
```

**å…³é”®ï¼š**
- snappedDeg å¿…é¡»æ˜¯ 0/90/180/270
- ä¸èƒ½æ˜¯ 30/45/60

---

### åœºæ™¯3ï¼šä¸è¯¯å¸22.5Â°

**æ“ä½œï¼š**
1. ä» (0, 0) å¼€å§‹ç”»çº¿
2. ä¸æŒ‰Shift
3. é¼ æ ‡ç§»åŠ¨åˆ° (100, 41.4)ï¼ˆå¤§æ¦‚22.5Â°æ–¹å‘ï¼‰
4. è§‚å¯Ÿ

**æœŸæœ›ï¼š**
```
Debugæ˜¾ç¤ºï¼š
  Raw: 22.5Â°
  Snap: nullï¼ˆå› ä¸º22.5Â°ä¸åœ¨é»˜è®¤é›†åˆï¼‰
  Source: free

çº¿æ¡ï¼šè‡ªç”±è§’åº¦ï¼ˆ22.5Â°å·¦å³ï¼‰
```

**å¦‚æœçœ‹åˆ°Snapä¸æ˜¯nullï¼š**
- è¯´æ˜angleSeté…ç½®é”™è¯¯
- æˆ–å®¹å·®å¤ªå¤§

---

## ğŸš¨ å¸¸è§é™·é˜±æ£€æŸ¥

### é™·é˜±1ï¼šå¿˜è®°æ·»åŠ  `if (isSnapped)` åˆ¤æ–­

**ç—‡çŠ¶ï¼š**
- Debugæ˜¾ç¤º `Snap: 90Â°`
- ä½†çº¿æ¡ä»ç„¶æ˜¯ `87Â°`

**æ£€æŸ¥ï¼š**
```typescript
// âœ… æ­£ç¡®
if (angleResult.isSnapped) {
  return { point: angleResult.point, ... }
}

// âŒ é”™è¯¯ï¼šæ²¡æœ‰è¿™ä¸ªåˆ¤æ–­ï¼Œç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç 
const inf = this.infer(...)  // è¦†ç›–äº†angleResult
```

---

### é™·é˜±2ï¼šGridæ¡ä»¶æ²¡æ”¹

**ç—‡çŠ¶ï¼š**
- Shiftæ—¶çº¿æ¡ä¸ç›´
- Debugæ˜¾ç¤º `Snap: 90Â°`ï¼Œä½†çº¿æ¡æ˜¯ `89.8Â°`

**æ£€æŸ¥ï¼š**
```typescript
// âŒ é”™è¯¯
if (gridEnabled) {
  point = snapToGrid(point)  // ç ´åäº†è§’åº¦
}

// âœ… æ­£ç¡®
if (!angleResult.isSnapped && gridEnabled) {
  point = snapToGrid(point)
}
```

---

### é™·é˜±3ï¼šDebugä¿¡æ¯ä¼ é€’é”™è¯¯

**ç—‡çŠ¶ï¼š**
- Debug overlayä¸æ˜¾ç¤º
- æˆ–æ˜¾ç¤ºçš„æ˜¯æ—§æ•°æ®

**æ£€æŸ¥ï¼š**
```typescript
// âœ… ç¡®ä¿æ¯æ¬¡POINTER_MOVEéƒ½æ›´æ–°debug
return { 
  ...state, 
  debug: result.debug  // å¿…é¡»æœ‰è¿™è¡Œ
}

// âŒ å¦‚æœå¿˜è®°ä¼ é€’debug
return { ...state }  // debugä¸ºç©º
```

---

## ğŸ“Š ä¿®æ”¹å‰åå¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆé”™è¯¯æµç¨‹ï¼‰

```
1. applyAngleSnap() â†’ point1 (90Â°) âœ…
2. infer() â†’ point2 (87Â°) âŒ è¦†ç›–
3. snapToGrid() â†’ point3 (89Â°) âŒ å†æ¬¡è¦†ç›–
4. æœ€ç»ˆæ˜¾ç¤ºï¼š89Â° âŒ
```

---

### ä¿®æ”¹åï¼ˆæ­£ç¡®æµç¨‹ï¼‰

```
1. applyAngleSnap() â†’ point1 (90Â°) âœ…
2. if (isSnapped) â†’ ç›´æ¥return point1 âœ…
3. ä¸å†æ‰§è¡Œåç»­é€»è¾‘
4. æœ€ç»ˆæ˜¾ç¤ºï¼š90Â° âœ…
```

---

## â±ï¸ 2å°æ—¶æ‰§è¡Œè®¡åˆ’

### ç¬¬1å°æ—¶ï¼šä¿®æ”¹ä»£ç 

- [ ] 0-20åˆ†é’Ÿï¼šæ‰¾åˆ° `inferDraw()` æ·»åŠ  `isSnapped` åˆ¤æ–­
- [ ] 20-30åˆ†é’Ÿï¼šä¿®æ”¹Gridæ¡ä»¶
- [ ] 30-50åˆ†é’Ÿï¼šæ·»åŠ Debug overlay
- [ ] 50-60åˆ†é’Ÿï¼šç¼–è¯‘é€šè¿‡ï¼Œåˆæ­¥æµ‹è¯•

---

### ç¬¬2å°æ—¶ï¼šæµ‹è¯•éªŒæ”¶

- [ ] 60-80åˆ†é’Ÿï¼šæµ‹è¯•åœºæ™¯1ï¼ˆç”»ç«–çº¿ï¼‰
- [ ] 80-100åˆ†é’Ÿï¼šæµ‹è¯•åœºæ™¯2ï¼ˆShiftæ­£äº¤ï¼‰
- [ ] 100-115åˆ†é’Ÿï¼šæµ‹è¯•åœºæ™¯3ï¼ˆä¸è¯¯å¸22.5Â°ï¼‰
- [ ] 115-120åˆ†é’Ÿï¼šæˆªå›¾è®°å½•ï¼Œå‡†å¤‡æ¼”ç¤º

---

## ğŸ“¸ äº¤ä»˜ç‰©

### CTOæäº¤

1. **ä¿®æ”¹åçš„ä»£ç **
   - `inferDraw()` ä¿®æ”¹
   - Gridæ¡ä»¶ä¿®æ”¹
   - Debug overlayä»£ç 

2. **éªŒæ”¶æˆªå›¾**
   - åœºæ™¯1ï¼šç«–çº¿90Â°
   - åœºæ™¯2ï¼šShiftæ­£äº¤
   - åœºæ™¯3ï¼š22.5Â°è‡ªç”±

3. **Debugæˆªå›¾**
   - æ˜¾ç¤º `Raw`ã€`Snap`ã€`Source`
   - è¯æ˜é”å®šç”Ÿæ•ˆ

---

### æ¼”ç¤ºå‡†å¤‡

**å‡†å¤‡ä¸€ä¸ª1åˆ†é’Ÿæ¼”ç¤ºï¼š**
1. ç”»ç«–çº¿ â†’ è‡ªåŠ¨90Â°
2. æŒ‰Shift â†’ åªèƒ½0/90
3. Debugæ˜¾ç¤º â†’ æ¸…æ™°å¯è§

**ä¸€å¥è¯æ€»ç»“ï¼š**
> "è§’åº¦é”å®šç°åœ¨æ˜¯æœ€ç»ˆè£å†³è€…ï¼Œä¸å†è¢«è¦†ç›–"

---

## ğŸ’¬ å¦‚æœé‡åˆ°é—®é¢˜

### é—®é¢˜1ï¼šç¼–è¯‘æŠ¥é”™

**å¯èƒ½åŸå› ï¼š**
- `angleResult` ç±»å‹å®šä¹‰ç¼ºå°‘ `debug` å­—æ®µ
- `isSnapped` å­—æ®µä¸å­˜åœ¨

**è§£å†³ï¼š**
```typescript
// ç¡®ä¿ applyAngleSnap è¿”å›ç±»å‹åŒ…å«
interface AngleSnapResult {
  point: Vec2
  angleDeg: number
  isSnapped: boolean
  mode: 'shift' | 'explicit' | 'smart' | 'free'
  debug?: {
    rawDeg: number
    snappedDeg: number | null
  }
}
```

---

### é—®é¢˜2ï¼šDebugä¸æ˜¾ç¤º

**å¯èƒ½åŸå› ï¼š**
- Canvasæ¸²æŸ“å±‚æ²¡è°ƒç”¨ `renderDebugOverlay`
- Stateä¸­debugæ²¡ä¼ é€’

**è§£å†³ï¼š**
```typescript
// åœ¨Canvas renderæ–¹æ³•ä¸­
if (this.state.debug) {
  renderDebugOverlay(ctx, this.state.debug, mousePos)
}
```

---

### é—®é¢˜3ï¼šè¿˜æ˜¯æœ‰åç§»

**å¯èƒ½åŸå› ï¼š**
- è¿˜æœ‰å…¶ä»–åœ°æ–¹ä¿®æ”¹äº†end point
- Gridæ¡ä»¶åˆ¤æ–­ä½ç½®ä¸å¯¹

**æ£€æŸ¥æ–¹æ³•ï¼š**
1. æœç´¢ä»£ç ä¸­æ‰€æœ‰ `draft.end =` çš„ä½ç½®
2. ç¡®ä¿åªæœ‰ä¸€å¤„è®¾ç½®ï¼Œä¸”åœ¨ `isSnapped` åˆ¤æ–­ä¹‹å
3. æ·»åŠ console.logè·Ÿè¸ªend pointå˜åŒ–

---

## âœ… å®Œæˆä¿¡å·

**çœ‹åˆ°è¿™äº›å°±ç®—å®Œæˆï¼š**

âœ… åœºæ™¯1ï¼šç”»ç«–çº¿ï¼ŒDebugæ˜¾ç¤º `Snap: 90Â°`ï¼Œçº¿æ¡å®Œå…¨å‚ç›´  
âœ… åœºæ™¯2ï¼šShiftæ­£äº¤ï¼ŒDebugæ˜¾ç¤º `Source: shift`ï¼Œåªèƒ½0/90  
âœ… åœºæ™¯3ï¼š22.5Â°ï¼ŒDebugæ˜¾ç¤º `Snap: null`ï¼Œè‡ªç”±è§’åº¦

**ç„¶åï¼š**
1. æäº¤ä»£ç 
2. å‘æˆªå›¾ç»™CDO
3. å‡†å¤‡æ¼”ç¤ºç»™CPO

---

**é¢„è®¡å®Œæˆæ—¶é—´ï¼š** ä»Šå¤©ä¸‹åˆ  
**ä¸‹ä¸€æ­¥ï¼š** CPOéªŒæ”¶ â†’ CDOæ›´æ–°æ–‡æ¡£ â†’ CTOè¿›è¡Œå®Œæ•´é‡æ„

---

**Good luck! ğŸš€**

å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œç«‹å³æ‰¾CDOæˆ–CPOè®¨è®ºï¼Œä¸è¦å¡ä½ã€‚

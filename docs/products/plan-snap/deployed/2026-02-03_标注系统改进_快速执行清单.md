# 标注系统精度和交互改进 - 快速执行清单

> **CTO 5分钟速查卡**  
> **预计工作量：** 2-3天  
> **优先级：** 🔴 P0 - Critical（用户信任度）

---

## ⚡ 一句话问题

**36-1/4" 显示成 3'，不能选方向，不能拉伸**

**CEO要求：**
> "标注应该像 SketchUp 那样是可以选择方向和拉伸的。"

---

## 🎯 两个独立问题

### 问题1：精度丢失
```
36-1/4" = 36.25" = 3'-0 1/4"
但显示：3' 或 3'-0"（分数丢失）
```

**根因：**
- 四舍五入到整英寸
- 或从grid/pixel反算

---

### 问题2：交互简陋
```
不能选择标注方向（上/下/左/右）
不能拖动偏移距离
不像专业CAD
```

---

## 🔧 核心修复（Copy & Paste）

### 1. 正确的数据来源

```typescript
// ✅ 正确：从世界坐标
const lenMm = distance(dim.a, dim.b)
const text = formatLength(lenMm, unitSystem, precision)

// ❌ 错误：从像素
const lenMm = pixelDist * mmPerPixel

// ❌ 错误：从grid
const lenMm = gridCount * gridStepMm
```

**铁律：**
```
标注值永远来自：世界坐标真实距离（mm）
仅在UI层格式化成英制/公制
```

---

### 2. 格式化函数（完整）

```typescript
function formatLength(
  lenMm: number,
  unitSystem: 'imperial' | 'metric',
  precision: number  // 0.5 | 0.25 | 0.125 | 0.0625
): string {
  if (unitSystem === 'metric') {
    return `${Math.round(lenMm)}mm`
  }
  
  const totalInch = lenMm / 25.4
  const feet = Math.floor(totalInch / 12)
  const inch = totalInch % 12
  
  // 四舍五入到precision
  const roundedInch = Math.round(inch / precision) * precision
  
  const wholeInch = Math.floor(roundedInch)
  const fractionInch = roundedInch - wholeInch
  
  const fraction = formatFraction(fractionInch, precision)
  
  if (feet > 0) {
    return `${feet}'-${wholeInch}${fraction ? ' ' + fraction : ''}"`
  } else {
    return `${wholeInch}${fraction ? ' ' + fraction : ''}"`
  }
}

function formatFraction(decimal: number, precision: number): string {
  if (decimal < 0.001) return ''
  
  const numerator = Math.round(decimal / precision)
  const denominator = Math.round(1 / precision)
  
  // 简化分数
  const gcd = (a, b) => b ? gcd(b, a % b) : a
  const g = gcd(numerator, denominator)
  
  return `${numerator / g}/${denominator / g}`
}
```

---

### 3. 数据结构

```typescript
type Dimension = {
  id: string
  kind: 'dimension'
  
  a: Pt          // 世界坐标（mm）
  b: Pt          // 世界坐标（mm）
  offsetMm: number
  
  orientationMode: 'horizontal' | 'vertical' | 'aligned'
  textOverride?: string
}
```

---

### 4. 三段式状态机

```typescript
type DimensionToolState =
  | { phase: 'IDLE' }
  | { phase: 'PICK_A' }
  | { phase: 'PICK_B'; a: Pt }
  | { phase: 'PLACE'; a: Pt; b: Pt; previewOffset: number }
  | { phase: 'COMMITTED' }

// IDLE → (D键) → PICK_A
// PICK_A → (click) → PICK_B
// PICK_B → (click) → PLACE
// PLACE → (鼠标移动) → 选择方向+偏移
// PLACE → (click) → COMMITTED
```

---

## 📋 3天计划

### Day 1: 紧急修复（6小时）

**P0-401: 精度修复**
- [ ] 检查formatter逻辑
- [ ] 确保从world坐标计算
- [ ] 测试36-1/4"显示

**P0-402: 精度设置**
- [ ] 添加精度选择UI（1/2", 1/4", 1/8", 1/16"）
- [ ] formatLength改进
- [ ] 默认1/16"

**验收：** 36-1/4" 正确显示

---

### Day 2: 三段交互（6小时）

**P0-403: 三段式**
- [ ] DimensionTool状态机
- [ ] PICK_A, PICK_B, PLACE状态
- [ ] 鼠标移动选择方向
- [ ] 预览显示

**验收：** 选A、选B、移动鼠标看到方向切换

---

### Day 3: 拖动和输入（4-6小时）

**P0-404: 拖动偏移**
- [ ] 放置后可拖动标注线
- [ ] offsetMm更新
- [ ] 不改变A/B点

**P0-405: 输入偏移**
- [ ] 复用parseLengthToMM
- [ ] 输入6", 150mm等
- [ ] Enter确认

**验收：** 可拖动、可输入偏移

---

## ✅ 验收清单

### 精度验收（Day 1）

- [ ] **36-1/4" 正确显示**
  - 不是 "3'"
  - 不是 "3'-0""
  - 是 "3'-0 1/4"" 或 "36 1/4""

- [ ] **精度可调**
  - 1/2", 1/4", 1/8", 1/16" 可选
  - 改变精度实时更新

- [ ] **缩放不影响**
  - Zoom in/out
  - 标注数值不变

---

### 交互验收（Day 2-3）

- [ ] **三段式流畅**
  - Pick A → Pick B → Place
  - 鼠标移动看到预览

- [ ] **方向可选**
  - 上/下/左/右明确
  - 预览实时

- [ ] **可拖动偏移**
  - 拖动标注线
  - offsetMm改变
  - A/B点不变

- [ ] **可输入偏移**
  - 支持分数
  - Enter确认

---

## 🧪 快速测试用例

### TC-1: 精度显示
```
画36-1/4"的线 → 添加标注
期望：显示 "36 1/4"" 或 "3'-0 1/4""
```

### TC-2: 精度切换
```
标注显示"36 1/4"" → 切换到1/2"
期望：显示 "36 1/2"" 或 "3'"
```

### TC-3: 三段交互
```
D键 → 点A → 点B → 移动鼠标
期望：标注预览跟随鼠标，方向可切换
```

### TC-4: 拖动偏移
```
创建标注（偏移6"） → 拖动到12"
期望：偏移改变，测量长度不变
```

---

## 🚨 关键接线点

### 1. Formatter检查

**文件：** `src/utils/format-length.ts`

**必须修复：**
```typescript
// 检查是否有这样的错误
if (inchFraction < 0.5) return ... // ❌ 丢失分数

// 改为
const fraction = formatFraction(fractionInch, precision)
```

---

### 2. 数据来源检查

**文件：** `src/entities/dimension.ts`

**必须确保：**
```typescript
// ✅ 正确
const lenMm = distance(this.a, this.b)

// ❌ 错误（如果有这样的代码，删除）
const lenMm = this.pixelLength * mmPerPixel
```

---

### 3. 精度设置UI

**文件：** `src/ui/toolbar.tsx`（或类似）

**添加：**
```tsx
<select onChange={handlePrecisionChange}>
  <option value="0.5">1/2"</option>
  <option value="0.25">1/4"</option>
  <option value="0.125">1/8"</option>
  <option value="0.0625">1/16"</option>
</select>
```

---

### 4. 三段式工具

**文件：** `src/tools/dimension-tool.ts`

**实现：**
```typescript
class DimensionTool implements Tool {
  state: DimensionToolState = { phase: 'IDLE' }
  
  onPointerDown(world: Pt) {
    if (this.state.phase === 'PICK_A') {
      this.state = { phase: 'PICK_B', a: world }
    } else if (this.state.phase === 'PICK_B') {
      this.state = { phase: 'PLACE', a: this.state.a, b: world }
    } else if (this.state.phase === 'PLACE') {
      // 提交
      this.commitDimension()
    }
  }
  
  onPointerMove(world: Pt) {
    if (this.state.phase === 'PLACE') {
      // 计算偏移
      this.state.previewOffset = ...
    }
  }
}
```

---

## 💬 CEO关键引用

### 关于精度
> "标注的精度不对，应该按照实际尺寸。右侧我实际画的是36-1/4"不是3'。"

### 关于交互
> "这个标注应该像 SketchUp 那样是可以选择方向和拉伸的。"

---

## 📊 精度对照表

| 输入 | precision=1/16" | precision=1/8" | precision=1/4" |
|------|----------------|---------------|---------------|
| 36.25" | 36 1/4" | 36 1/4" | 36 1/4" |
| 36.1875" | 36 3/16" | 36 1/4" | 36 1/4" |
| 36.125" | 36 1/8" | 36 1/8" | 36" |
| 36.5" | 36 1/2" | 36 1/2" | 36 1/2" |

---

## 🎨 SketchUp式交互示意

```
Step 1: Pick A
  🔵 ← 点击A点

Step 2: Pick B
  🔵────────🔵 ← 点击B点

Step 3: Place（鼠标移动）
  
  标注在上侧：
         6"
    ┌────────┐
  🔵          🔵
  
  标注在下侧：
  🔵          🔵
    └────────┘
         6"
  
Step 4: Click确认放置
```

---

## 📞 有问题？

- formatter逻辑 → 看会议纪要 "格式化规则" 章节
- 三段式状态机 → 看会议纪要 "状态机设计" 章节
- 渲染算法 → 看会议纪要 "渲染逻辑" 章节

---

**开始修复！** 🚀

完整文档：`2026-02-03_会议纪要_标注系统精度和交互改进.md`

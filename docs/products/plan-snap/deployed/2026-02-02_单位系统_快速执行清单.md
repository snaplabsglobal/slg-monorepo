# 单位系统 - CTO 快速执行清单

> **优先级：** 🔴 Critical  
> **工作量：** 2-3天  
> **目标：** 架构封印，防止未来返工

---

## 🎯 核心决策（一句话）

> **底层数据统一用 mm，UI 层一键切换英制/公制。**

**为什么是 mm？** 工业级标准（AutoCAD, Revit, SketchUp 都这么做）

---

## ✅ 必须完成的6个任务

### Task 1: 单位宪法 🔴

**位置：** `docs/units.md`

**内容：**
```markdown
## Units Policy (Hard Rule)

- All geometry = millimeters (mm)
- No other unit in core/state/persistence
- UI units are view-layer only
- User input → parse to mm immediately
- Display rounding ≠ stored values
```

**验收：** [ ] 文档已创建，全员已读

---

### Task 2: 类型封印 🔴

**做法：** 使用语义类型

```typescript
// ❌ 错误
let width = 3000;

// ✅ 正确
type Millimeter = number;

interface Point {
  x: Millimeter;
  y: Millimeter;
}
```

**验收：** [ ] 所有几何类型使用 `Millimeter`

---

### Task 3: 单位换算集中 🔴

**做法：** 只能在一个地方

```typescript
// /packages/core/src/units/imperial.ts

export function inchToMm(inch: number): Millimeter {
  return inch * 25.4;
}

export function parseLengthToMM(input: string): Millimeter {
  // ...
}

export function formatImperial(mm: Millimeter): string {
  // 显示为 9'-6"
}
```

**验收：** [ ] 其他地方没有 `25.4` 或 `304.8`

---

### Task 4: 解耦检查 🔴

**确认三个模块独立：**

| 模块 | 单位 | 职责 |
|------|------|------|
| GeometryEngine | mm | 几何计算 |
| SnapManager | mm | 吸附逻辑 |
| GridRenderer | 视觉 | 显示参考 |

**验收：** [ ] Grid 不影响几何坐标

---

### Task 5: 测试地雷 🔴

**目的：** 防止架构污染

```typescript
it('geometry must not change when UI unit switches', () => {
  const line = drawLine("9'6\"");
  const before = getLineLengthMm(line);
  
  switchUnitSystem('metric');
  const after = getLineLengthMm(line);
  
  expect(after).toBeCloseTo(before, 5);
});
```

**验收：** [ ] 测试通过，在 CI 中运行

---

### Task 6: 代码清查 🟡

**查找问题：**

```bash
# 查找魔法数字
grep -r "25.4\|304.8" src/

# 查找可疑的单位变量
grep -ri "inch\|foot" src/

# 应该只在 units/ 目录出现
```

**验收：** [ ] 清查完成，问题已修复

---

## 📐 1/16" 精度要求

### 三层精度模型

```
[ Geometry ]  ← 连续 mm（不 round）
      ↑
[ Snap ]      ← 1/16" = 1.5875 mm
      ↑
[ Grid ]      ← 视觉参考（不影响几何）
```

**关键：** Grid ≠ 几何约束

---

## 📋 重要代码位置

**新增文件：**
```
/packages/core/src/
  ├── units/
  │   ├── imperial.ts         ⭐ 单位换算（唯一）
  │   ├── parseLengthToMM.ts
  │   └── formatLength.ts
  └── types/
      └── index.ts            + Millimeter 类型
```

**修改文件：**
```
/packages/core/src/
  ├── geometry/               + 使用 Millimeter 类型
  ├── snap/                   + 解耦 Grid
  └── grid/                   + 只做显示
```

---

## ⏰ 时间表（2-3天）

| 阶段 | 任务 | 时间 |
|------|------|------|
| Phase 1 | 文档和规范 | 0.5天 |
| Phase 2 | 核心实现 | 1天 |
| Phase 3 | 解耦和封印 | 1天 |
| Phase 4 | 集成测试 | 0.5天 |

---

## ✅ CEO 判断信号

**CEO 只需要问一句：**

> "我们现在有没有任何地方，用 inch/ft 作为中间计算单位?"

---

**合格答案：**
```
"没有。所有单位换算都在 units/ 目录，
所有几何都是 mm，
有类型系统保障，
有单元测试覆盖。"
```

**不合格答案：**
```
"应该没有吧，但我再看看"
→ 必须做这一步封印！
```

---

## 🎯 完成后的收益

```
✅ 英制/公制随便切换
✅ 1/16" / 1/8" 精度随便调
✅ ISO / takeoff / AI 全部复用
✅ 新人不敢乱写
✅ 面积/长度计算永远准确
```

---

## 🚨 不做的后果

```
❌ Takeoff 误差 1-2%
❌ ISO/平面图对不上
❌ 新人写 bug，难排查
❌ 用户不信任精度
❌ 半年后必定返工
```

---

## 💡 关键原则（牢记）

### CPO 的警告

> "这 2-3 天的工作，会为未来省下 2-3 个月的返工。"

### 技术宪法

> "All geometry = mm. No exceptions."

### 分层架构

> "UI 单位切换 = 纯视图层的事情"

---

**详细文档见：单位系统技术规范（完整版）**

# 会议纪要 - 标注系统精度和交互改进

> **会议时间：** 2026-02-03  
> **会议类型：** Bug修复 + 功能改进  
> **参与人员：** CEO、CDO  
> **优先级：** 🔴 P0 - Critical  
> **状态：** ✅ 方案已确定

---

## 📋 问题背景

### 用户反馈

**CEO发现的问题：**

**问题1：标注精度不对**
```
实际画的：36-1/4"
标注显示：3'-0" 或 3'
```

**问题2：交互不够专业**
```
不能选择标注方向（上/下/左/右）
不能拉伸偏移距离
```

**CEO明确要求：**
> "标注应该像 SketchUp 那样是可以选择方向和拉伸的。"

---

## 🎯 问题分析

### 问题1：为什么36-1/4"会变成3'-0"

**最常见根因（两种情况）：**

#### A. 显示精度四舍五入

```
36-1/4" = 36.25" = 3'-0 1/4"

如果精度设置为"整英寸"或"1/2英寸"：
→ 0.25" 被舍掉
→ 显示为 3'-0"（错误）
```

**可能的代码问题：**
```typescript
// ❌ 错误：四舍五入掉了分数
const formatter = (inch) => {
  if (inchFraction < 0.5) return Math.floor(inch) + '"'
  // 丢失了 1/4", 3/16" 等分数
}
```

---

#### B. 测量拿错单位

```
可能从错误的来源获取数值：
- 用了 grid step（格子步长）
- 用了 screen px（屏幕像素）
- 用了 Math.round() 的feet值
```

**错误示例：**
```typescript
// ❌ 错误：从像素反算
const lengthInch = pixelLength / viewScale

// ❌ 错误：从grid计算
const lengthInch = gridCount * gridStep
```

---

### ✅ 正确做法（强制规则）

**唯一真相来源：**
```
标注数值必须永远来自：
  世界坐标的真实几何距离（mm）
    ↓
  仅在UI层格式化成英制/公制
```

**绝对不能从：**
```
❌ 像素
❌ grid index
❌ 显示文本反算
```

---

### 问题2：标注交互不够专业

**当前问题：**
```
可能只是简单的"两点一线"
没有方向选择
没有偏移拉伸
不像专业CAD工具
```

---

## 🎯 解决方案

### 一、SketchUp式标注交互（三段式）

**心智模型：**
```
1. 选两点（或一条边）
2. 鼠标移动决定标注放在哪一侧（上/下/左/右）
3. 第三次点击把标注放下
4. 放下后能拖动标注线偏移（不改变测量点）
```

---

#### 状态机设计

**Dimension Tool 三段式：**

**Step 1: Pick A**
```
点击或吸附：
- 端点（endpoint）
- 交点（intersection）
- 引导线（guide）
- 任意点（onSegment）
```

**Step 2: Pick B**
```
点击第二个点
显示临时测量预览
```

**Step 3: Place**
```
鼠标移动选择：
- 方向（上/下/左/右）
- 偏移距离（offset）

Click确认放置
```

---

#### 放置后的操作

**拖动标注线：**
```
改变 offsetMm
不改变 A/B 测量点
```

**翻转方向：**
```
快捷键 F 或 X
翻转到另一侧（flip）
```

**锁定偏移方向：**
```
Shift：偏移方向锁定为"垂直于测量线"
防止乱飘
```

**输入偏移值：**
```
复用分数输入解析器
输入：6" / 150mm
Enter确认
```

---

### 二、显示精度设置（必须）

**为什么需要：**
```
施工级应用必须支持英制分数精度
用户需要能控制显示精度
```

---

#### 精度选项

**英制精度：**
```
1/2"  （0.5"）
1/4"  （0.25"）
1/8"  （0.125"）
1/16" （0.0625"）  ← 建议默认
```

**公制精度：**
```
1mm   （整毫米）
0.1mm （可选）
```

---

#### UI实现

**位置：**
```
右上角单位切换旁边
或设置面板
```

**示例：**
```
┌─────────────┐
│ Imperial ▼  │
│ 1/16" ▼     │
└─────────────┘
```

---

#### Formatter规则（强制）

**内部存储：**
```
mm（double或int）
```

**显示格式化：**
```
按precision rounding
36.25" 在1/16精度下必须显示为：
  - 3' 0 1/4"
  - 或 3'-0 1/4"
  - 或 36 1/4"（取决于格式偏好）
```

**关键：**
```
改precision只影响显示
不改变几何
不影响实际数值
```

---

### 三、标注数据结构

```typescript
type Dimension = {
  id: string
  kind: 'dimension'
  
  // 测量点（世界坐标，mm）
  a: Pt
  b: Pt
  
  // 偏移距离（mm）
  offsetMm: number
  
  // 方向模式
  orientationMode: 'horizontal' | 'vertical' | 'aligned'
  
  // 可选：文本覆盖
  textOverride?: string
  
  // 创建时间
  createdAt: number
}
```

**关键点：**
```
source-of-truth：a, b, offsetMm
渲染时动态计算所有其他内容
```

---

### 四、渲染算法

```typescript
/**
 * 渲染标注
 */
function renderDimension(dim: Dimension) {
  // 1. 计算方向向量
  const dir = normalize(sub(dim.b, dim.a))
  
  // 2. 计算法线向量（垂直方向）
  const normal = perp(dir)  // 根据鼠标决定正负
  
  // 3. 计算标注线位置
  const offset = normal.scale(dim.offsetMm)
  const dimLineStart = add(dim.a, offset)
  const dimLineEnd = add(dim.b, offset)
  
  // 4. 渲染标注线
  drawLine(dimLineStart, dimLineEnd)
  
  // 5. 渲染引线（extension lines）
  drawLine(dim.a, dimLineStart)  // 从A到标注线
  drawLine(dim.b, dimLineEnd)    // 从B到标注线
  
  // 6. 计算长度
  const lenMm = distance(dim.a, dim.b)
  
  // 7. 格式化文本
  const text = formatLength(lenMm, unitSystem, precision)
  
  // 8. 渲染文本（居中，避让）
  const textPos = lerp(dimLineStart, dimLineEnd, 0.5)
  drawText(text, textPos, { avoid: dimLineStart })
}
```

---

## 📋 Jira Epic拆分

### Epic Key: PS-P0-DIMENSION-FIX

**目标：** 修复标注精度问题 + 改进交互体验

---

### P0-401 — 标注精度修复（紧急）

**Scope：**
- 修复36-1/4"显示为3'的问题
- 确保数值来自真实几何距离

**实现要点：**
- 检查formatter逻辑
- 确保从world坐标计算
- 不从grid/pixel反算

**DoD：**
- [ ] 36-1/4" 正确显示
- [ ] 不同精度下显示正确
- [ ] 缩放不影响数值

**验收：**
- 画36-1/4"的线，标注显示正确
- 改变缩放，标注不变

---

### P0-402 — 显示精度设置

**Scope：**
- 添加精度选择UI
- 实现1/2", 1/4", 1/8", 1/16"精度

**实现要点：**
- UI组件（dropdown）
- formatLength函数改进
- 精度设置持久化

**DoD：**
- [ ] 精度选项可用
- [ ] 改变精度实时更新
- [ ] 默认1/16"

**验收：**
- 切换精度，所有标注更新
- 重新打开文件，精度保持

---

### P0-403 — 三段式交互（Pick A → Pick B → Place）

**Scope：**
- 实现SketchUp式三段交互
- 鼠标移动选择方向

**实现要点：**
- DimensionTool状态机
- 三个状态：PICK_A, PICK_B, PLACE
- 预览显示

**DoD：**
- [ ] 三段交互流畅
- [ ] 方向可选（上/下/左/右）
- [ ] 预览清晰

**验收：**
- 选A、选B、移动鼠标看到方向切换

---

### P0-404 — 拖动偏移标注线

**Scope：**
- 放置后可拖动标注线
- 改变offsetMm

**实现要点：**
- 拖动检测
- offsetMm更新
- 实时预览

**DoD：**
- [ ] 可拖动标注线
- [ ] 不改变A/B点
- [ ] 偏移数值正确

**验收：**
- 拖动标注线，偏移改变

---

### P0-405 — 输入偏移值

**Scope：**
- 支持输入偏移距离
- 复用分数输入解析器

**实现要点：**
- 复用parseLengthToMM
- 输入状态管理
- Enter确认

**DoD：**
- [ ] 可输入6", 150mm等
- [ ] Enter确认生效
- [ ] 分数输入支持

**验收：**
- 输入"6 1/2""，偏移正确

---

### P1-406 — 翻转和锁定（可选）

**Scope：**
- F/X键翻转方向
- Shift锁定偏移方向

**实现要点：**
- 快捷键绑定
- 方向翻转逻辑

**DoD：**
- [ ] F键翻转
- [ ] Shift锁定方向

---

## ✅ 完成定义（DoD）

### A. 精度DoD（必须）

- [ ] **真实距离测量**
  - 标注值来自world坐标
  - 不从grid/pixel计算

- [ ] **分数显示正确**
  - 36-1/4" 不会变成 3'
  - 1/16精度下正确显示

- [ ] **精度可调**
  - 支持1/2", 1/4", 1/8", 1/16"
  - 改变精度实时更新

---

### B. 交互DoD（必须）

- [ ] **三段式交互**
  - Pick A → Pick B → Place
  - 鼠标移动选择方向

- [ ] **可拖动偏移**
  - 放置后可拖动
  - 不改变测量点

- [ ] **输入偏移值**
  - 支持分数输入
  - Enter确认

---

### C. 视觉DoD

- [ ] **标注线清晰**
  - 引线（extension lines）自动
  - 文本不被压住

- [ ] **方向明确**
  - 上/下/左/右可区分
  - 预览实时显示

---

## 🧪 测试用例

### TC-D001: 精度显示
```
步骤：
1. 画36-1/4"的线
2. 添加标注

期望：
- 显示 "3'-0 1/4"" 或 "36 1/4""
- 不是 "3'" 或 "3'-0""
```

### TC-D002: 精度切换
```
步骤：
1. 标注显示 "36 1/4""
2. 切换精度到1/2"

期望：
- 显示 "36 1/2"" 或 "3'"
- 数值四舍五入
```

### TC-D003: 三段交互
```
步骤：
1. D进入Dimension工具
2. 点击A点
3. 点击B点
4. 移动鼠标（不点击）
5. 观察标注预览

期望：
- 标注线跟随鼠标
- 可以在上/下/左/右切换
```

### TC-D004: 拖动偏移
```
步骤：
1. 创建标注（偏移6"）
2. 拖动标注线到12"

期望：
- 偏移改变为12"
- A、B点不变
- 测量长度不变
```

---

## 💬 CEO关键引用

### 关于精度问题
> "标注的精度不对，应该按照实际尺寸。右侧我实际画的是36-1/4"不是3'。"

### 关于交互要求
> "这个标注应该像 SketchUp 那样是可以选择方向和拉伸的。"

---

## 🔧 关键实现点（避免再出bug）

### 1. 数据来源（唯一真相）

**正确：**
```typescript
// ✅ 从世界坐标计算
const lenMm = distance(dim.a, dim.b)
const text = formatLength(lenMm, unitSystem, precision)
```

**错误：**
```typescript
// ❌ 从像素计算
const lenMm = pixelDist * mmPerPixel

// ❌ 从grid计算
const lenMm = gridCount * gridStepMm

// ❌ 从显示文本反算
const lenMm = parseDisplayText(dimText)
```

---

### 2. 格式化规则

```typescript
/**
 * 格式化长度
 * 
 * @param lenMm - 长度（mm）
 * @param unitSystem - 'imperial' | 'metric'
 * @param precision - 1/2 | 1/4 | 1/8 | 1/16 (inch)
 */
function formatLength(
  lenMm: number,
  unitSystem: 'imperial' | 'metric',
  precision: number  // 0.5 | 0.25 | 0.125 | 0.0625
): string {
  if (unitSystem === 'metric') {
    return `${Math.round(lenMm)}mm`
  }
  
  // 转换为英寸
  const totalInch = lenMm / 25.4
  
  // 分离feet和inch
  const feet = Math.floor(totalInch / 12)
  const inch = totalInch % 12
  
  // 四舍五入到precision
  const roundedInch = Math.round(inch / precision) * precision
  
  // 分离整数和分数
  const wholeInch = Math.floor(roundedInch)
  const fractionInch = roundedInch - wholeInch
  
  // 格式化分数
  const fraction = formatFraction(fractionInch, precision)
  
  // 组合
  if (feet > 0) {
    if (wholeInch > 0 || fraction) {
      return `${feet}'-${wholeInch}${fraction ? ' ' + fraction : ''}"`
    } else {
      return `${feet}'-0"`
    }
  } else {
    return `${wholeInch}${fraction ? ' ' + fraction : ''}"`
  }
}

function formatFraction(
  decimal: number, 
  precision: number
): string {
  if (decimal < 0.001) return ''
  
  const numerator = Math.round(decimal / precision)
  const denominator = Math.round(1 / precision)
  
  // 简化分数
  const gcd = (a: number, b: number): number => b ? gcd(b, a % b) : a
  const g = gcd(numerator, denominator)
  
  return `${numerator / g}/${denominator / g}`
}
```

---

### 3. 渲染逻辑

**关键步骤：**
```typescript
// 1. 方向向量
const dir = normalize(sub(B, A))

// 2. 法线向量（垂直）
const normal = perp(dir)  // { x: -dir.y, y: dir.x }

// 3. 标注线位置
const dimLineA = add(A, mul(normal, offsetMm))
const dimLineB = add(B, mul(normal, offsetMm))

// 4. 引线
drawLine(A, dimLineA)
drawLine(B, dimLineB)

// 5. 标注线
drawLine(dimLineA, dimLineB)

// 6. 文本
const textPos = lerp(dimLineA, dimLineB, 0.5)
const lenMm = distance(A, B)
const text = formatLength(lenMm, unitSystem, precision)
drawText(text, textPos)
```

---

## 📋 行动项

### CTO立即执行（紧急）

**优先级：** 🔴 P0

**Day 1（紧急）：**
- [ ] P0-401: 精度修复
- [ ] P0-402: 显示精度设置

**Day 2-3：**
- [ ] P0-403: 三段式交互
- [ ] P0-404: 拖动偏移
- [ ] P0-405: 输入偏移值

**参考文档：**
- 本会议纪要
- 完整技术方案（待创建）
- 快速执行清单（待创建）

---

### CDO配合工作

**本周完成：**
- [ ] 创建完整技术方案
- [ ] 创建快速执行清单
- [ ] 更新决策日志
- [ ] 更新文档索引

---

## 🔗 相关文档

**本次会议产出：**
1. 本会议纪要
2. 完整技术方案（待创建）
3. 快速执行清单（待创建）

**相关历史文档：**
1. 分数输入系统（DEC-005）- 可复用
2. 单位系统（DEC-000）- 基础依赖

---

## 🎯 总结

### 两个独立问题

**问题1：精度丢失**
```
36-1/4" 显示成 3'
根因：四舍五入 或 数据来源错误
```

**问题2：交互简陋**
```
不能选方向、不能拉伸
需要：SketchUp式三段交互
```

---

### 核心解决方案

**精度修复：**
```
1. 确保从world坐标计算
2. 添加精度设置（1/2", 1/4", 1/8", 1/16"）
3. 正确的格式化函数
```

**交互改进：**
```
1. 三段式：Pick A → Pick B → Place
2. 可拖动偏移
3. 可输入偏移值
4. 方向可选
```

---

**会议记录人：** CDO  
**会议时间：** 2026-02-03  
**下次Review：** 精度修复验收（Day 1）  
**状态：** ✅ 方案已确定，待执行

---

这个修复直接影响用户对产品的信任度，必须优先处理！🚀

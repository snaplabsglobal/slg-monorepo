# æ€§èƒ½é—®é¢˜è¯Šæ–­å’Œä¿®å¤

> **æ—¶é—´ï¼š** 2026-02-04 06:50  
> **é—®é¢˜ï¼š** è¶Šç”¨è¶Šæ…¢  
> **ä¼˜å…ˆçº§ï¼š** ğŸ”´ P0  
> **æ‰§è¡Œäººï¼š** CTO  
> **é¢„è®¡ï¼š** 1-2å°æ—¶

---

## ğŸ“‹ é—®é¢˜

**CEOåé¦ˆï¼š**
> "è¶Šç”¨è¶Šæ…¢ï¼Œæ˜¯æµè§ˆå™¨é—®é¢˜è¿˜æ˜¯ä»£ç é—®é¢˜ï¼Ÿ"

**ç°è±¡ï¼š**
- åˆšæ‰“å¼€ï¼šæµç•…
- ç”»äº†ä¸€ä¼šå„¿ï¼šå¼€å§‹å¡
- ç”»äº†å¾ˆå¤šçº¿ï¼šæ˜æ˜¾å¡é¡¿

**åˆ¤æ–­ï¼š** 90%æ˜¯ä»£ç é—®é¢˜ï¼ˆå¯¹è±¡å˜å¤šã€ç›‘å¬æ³„æ¼ã€O(N)æ‰«æï¼‰

---

## ğŸ¯ CEO 30ç§’è‡ªæµ‹

### Test 1: åˆ·æ–°é¡µé¢
```
åˆ·æ–°ï¼ˆF5ï¼‰â†’ ç«‹åˆ»æ‹–åŠ¨
å¦‚æœç¬é—´å˜æµç•… â†’ ç¡®è®¤æ˜¯æ€§èƒ½é—®é¢˜
```

### Test 2: æ— ç—•çª—å£
```
Ctrl+Shift+N â†’ åŠ è½½åŒæ ·çš„å›¾ â†’ å¯¹æ¯”
```

### Test 3: å…³é—­DevTools
```
å…³é—­DevTools â†’ å†æµ‹è¯•
```

**ç»™CTOçš„ä¿¡æ¯ï¼š**
- å¤§æ¦‚___æ¡çº¿å¼€å§‹å¡
- ___æ“ä½œæœ€æ…¢ï¼ˆæ‹–åŠ¨/ç”»çº¿/é€‰æ‹©ï¼‰
- åˆ·æ–°å‰åå¯¹æ¯”

---

## ğŸ› 5å¤§æ ¹å› 

### 1. O(N)æ‰«æ - 80%

```typescript
// âŒ é—®é¢˜ï¼šæ¯æ¬¡é¼ æ ‡ç§»åŠ¨æ‰«å…¨éƒ¨
function onPointerMove(mousePos) {
  for (const seg of allSegments) {  // N=500 â†’ æ…¢
    const dist = distToSegment(mousePos, seg)
  }
}
```

**ä¿®å¤ï¼š** ç©ºé—´ç´¢å¼• or Bounding Box

---

### 2. å…¨é‡é‡æ¸²æŸ“ - 60%

```typescript
// âŒ é—®é¢˜ï¼šæ¯æ¬¡setStateè§¦å‘å…¨éƒ¨é‡æ¸²æŸ“
function onPointerMove(e) {
  setPreview({ start, end: mousePos })
}
```

**ä¿®å¤ï¼š** ref + requestAnimationFrame

---

### 3. ç›‘å¬å™¨æ³„æ¼ - 40%

```typescript
// âŒ é—®é¢˜ï¼šå¿˜è®°cleanup
useEffect(() => {
  document.addEventListener('pointermove', handleMove)
  // å¿˜è®°return cleanup
}, [])
```

**æ£€æŸ¥ï¼š**
```javascript
// Consoleæ‰§è¡Œ
getEventListeners(document)
// åº”è¯¥åªæœ‰1-2ä¸ªï¼Œå¦‚æœ10+ â†’ æ³„æ¼
```

---

### 4. Undoè¿‡å¤§ - 30%

```typescript
// âŒ é—®é¢˜ï¼šæ·±æ‹·è´æ•´ä¸ªscene
history.push(JSON.parse(JSON.stringify(scene)))
```

---

### 5. Debugè¿‡é‡ - 20%

```typescript
// âŒ é—®é¢˜ï¼šæ¯å¸§log
console.log('move', e.clientX, e.clientY)
```

---

## ğŸ”§ CTOæ‰§è¡Œï¼ˆ1-2å°æ—¶ï¼‰

### Phase 1: åŠ ç›‘æ§ï¼ˆ30åˆ†é’Ÿï¼‰

**æ·»åŠ PerformanceMonitorç»„ä»¶ï¼š**

```tsx
// src/components/PerformanceMonitor.tsx
import React, { useState, useEffect, useRef } from 'react'

interface PerfStats {
  entitiesCount: number
  renderMs: number
  hitTestMs: number
  fps: number
  memoryMB: number
}

export function PerformanceMonitor({ 
  entities,
  enabled = true 
}: { 
  entities: any[]
  enabled?: boolean 
}) {
  const [stats, setStats] = useState<PerfStats>({
    entitiesCount: 0,
    renderMs: 0,
    hitTestMs: 0,
    fps: 0,
    memoryMB: 0
  })
  
  const frameTimesRef = useRef<number[]>([])
  const lastFrameTimeRef = useRef(performance.now())
  
  useEffect(() => {
    if (!enabled) return
    
    const updateStats = () => {
      const now = performance.now()
      const delta = now - lastFrameTimeRef.current
      frameTimesRef.current.push(delta)
      
      if (frameTimesRef.current.length > 60) {
        frameTimesRef.current.shift()
      }
      
      const avgDelta = frameTimesRef.current.reduce((a, b) => a + b, 0) / frameTimesRef.current.length
      const fps = Math.round(1000 / avgDelta)
      
      let memoryMB = 0
      if ((performance as any).memory) {
        memoryMB = Math.round((performance as any).memory.usedJSHeapSize / 1024 / 1024)
      }
      
      const perfStats = (window as any).__perfStats || {}
      
      setStats({
        entitiesCount: entities.length,
        renderMs: perfStats.renderMs || 0,
        hitTestMs: perfStats.hitTestMs || 0,
        fps,
        memoryMB
      })
      
      lastFrameTimeRef.current = now
      requestAnimationFrame(updateStats)
    }
    
    const rafId = requestAnimationFrame(updateStats)
    return () => cancelAnimationFrame(rafId)
  }, [entities, enabled])
  
  if (!enabled) return null
  
  return (
    <div style={{
      position: 'fixed',
      top: 10,
      right: 10,
      background: 'rgba(0, 0, 0, 0.85)',
      color: '#0f0',
      padding: '12px',
      fontFamily: 'Consolas, monospace',
      fontSize: '13px',
      zIndex: 99999,
      borderRadius: '6px',
      minWidth: '180px'
    }}>
      <div style={{ marginBottom: '8px', fontWeight: 'bold', color: '#fff' }}>
        âš¡ Performance
      </div>
      <div>Entities: {stats.entitiesCount}</div>
      <div>Render: {stats.renderMs.toFixed(2)}ms</div>
      <div>HitTest: {stats.hitTestMs.toFixed(2)}ms</div>
      <div style={{ 
        color: stats.fps < 30 ? '#f00' : stats.fps < 45 ? '#ff0' : '#0f0',
        fontWeight: 'bold'
      }}>
        FPS: {stats.fps}
      </div>
      {stats.memoryMB > 0 && (
        <div>Memory: {stats.memoryMB}MB</div>
      )}
    </div>
  )
}
```

**ä½¿ç”¨æ–¹æ³•ï¼š**

```tsx
// App.tsx
import { PerformanceMonitor } from './components/PerformanceMonitor'

function App() {
  const [showPerf, setShowPerf] = useState(true)
  
  return (
    <>
      <Canvas entities={allEntities} />
      <PerformanceMonitor entities={allEntities} enabled={showPerf} />
      <button onClick={() => setShowPerf(!showPerf)}>Toggle Perf</button>
    </>
  )
}
```

**åœ¨æ¸²æŸ“å™¨ä¸­æš´éœ²renderMsï¼š**

```typescript
// src/renderer/canvas-renderer.ts
function render(entities: Entity[]) {
  const start = performance.now()
  
  ctx.clearRect(0, 0, width, height)
  entities.forEach(entity => renderEntity(entity))
  
  const end = performance.now()
  
  if (!window.__perfStats) window.__perfStats = {}
  window.__perfStats.renderMs = end - start
}
```

**åœ¨inferenceä¸­æš´éœ²hitTestMsï¼š**

```typescript
// src/inference/inference-engine.ts
function findNearest(mousePos: Pt, entities: Entity[]): Entity | null {
  const start = performance.now()
  
  // ... hitTesté€»è¾‘
  
  const end = performance.now()
  
  if (!window.__perfStats) window.__perfStats = {}
  window.__perfStats.hitTestMs = end - start
  
  return nearest
}
```

---

### Phase 2: å®šä½ç“¶é¢ˆï¼ˆ30åˆ†é’Ÿï¼‰

**1. Chrome Performance Profile**
```
DevTools â†’ Performance â†’ å½•åˆ¶5ç§’ â†’ çœ‹Flame Graph
æ‰¾å ç”¨æœ€å¤šçš„å‡½æ•°
```

**2. Memoryæ£€æŸ¥**
```
DevTools â†’ Memory â†’ Take Snapshotï¼ˆå‰åå¯¹æ¯”ï¼‰
å¦‚æœå¢é•¿ > 50MB â†’ æ³„æ¼
```

**3. Event Listeners**
```javascript
// Consoleæ‰§è¡Œ
getEventListeners(document)
```

---

### Phase 3: å¿«é€Ÿä¿®å¤ï¼ˆ30åˆ†é’Ÿ-1å°æ—¶ï¼‰

#### ä¿®å¤1: ç›‘å¬å™¨cleanup

**æ£€æŸ¥æ‰€æœ‰addEventListenerï¼š**

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
grep -r "addEventListener" src/
```

**ç¡®ä¿éƒ½æœ‰cleanupï¼š**

```typescript
// âŒ é”™è¯¯
useEffect(() => {
  document.addEventListener('pointermove', handleMove)
}, [])

// âœ… æ­£ç¡®
useEffect(() => {
  document.addEventListener('pointermove', handleMove)
  return () => document.removeEventListener('pointermove', handleMove)
}, [])
```

---

#### ä¿®å¤2: å…³é—­Debug Log

**æ·»åŠ å…¨å±€å¼€å…³ï¼š**

```typescript
// src/config.ts
export const DEBUG = false  // ç”Ÿäº§ç¯å¢ƒå…³é—­
```

**ä½¿ç”¨ï¼š**

```typescript
import { DEBUG } from './config'

function onPointerMove(e) {
  if (DEBUG) {
    console.log('move', e)
  }
  // æ­£å¸¸é€»è¾‘
}
```

---

#### ä¿®å¤3: hitTestä¼˜åŒ–ï¼ˆBounding Boxï¼‰

**ç®€å•ä¼˜åŒ–ï¼ˆä¸éœ€è¦ç©ºé—´ç´¢å¼•ï¼‰ï¼š**

```typescript
function findNearest(mousePos: Pt, entities: Entity[], threshold: number = 10): Entity | null {
  const start = performance.now()
  
  // 1. Bounding Boxç²—ç­›
  const candidates = entities.filter(entity => {
    const bounds = entity.getBounds()
    return (
      mousePos.x >= bounds.min.x - threshold &&
      mousePos.x <= bounds.max.x + threshold &&
      mousePos.y >= bounds.min.y - threshold &&
      mousePos.y <= bounds.max.y + threshold
    )
  })
  
  // 2. ç²¾ç¡®è®¡ç®—
  let nearest: Entity | null = null
  let minDist = Infinity
  
  for (const entity of candidates) {
    const dist = distanceToEntity(mousePos, entity)
    if (dist < minDist && dist < threshold) {
      minDist = dist
      nearest = entity
    }
  }
  
  const end = performance.now()
  if (!window.__perfStats) window.__perfStats = {}
  window.__perfStats.hitTestMs = end - start
  
  return nearest
}
```

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰

ä¿®å¤åå¿…é¡»ï¼š

- [ ] **ç”»500æ¡çº¿ï¼Œæ‹–åŠ¨æµç•…**
  - FPS > 45
  - æ— å¡é¡¿

- [ ] **Memoryä¸å¢é•¿**
  - ç”»100æ¡ â†’ Undo â†’ é‡å¤10æ¬¡
  - å¢é•¿ < 50MB

- [ ] **Listenersä¸æ³„æ¼**
  - åˆ‡æ¢å·¥å…·10æ¬¡
  - æ•°é‡ä¸å¢é•¿

- [ ] **åˆ·æ–°å‰åä¸€è‡´**
  - ä¸"è¶Šç”¨è¶Šæ…¢"

---

## ğŸš€ è¿›é˜¶ä¼˜åŒ–ï¼ˆP1ï¼Œæœ¬å‘¨å†…ï¼‰

### ç©ºé—´ç´¢å¼•å®ç°

**å¦‚æœhitTestä»ç„¶æ…¢ï¼Œå®ç°ç©ºé—´ç´¢å¼•ï¼š**

```typescript
// src/utils/spatial-index.ts
type Pt = { x: number; y: number }
type Bounds = { min: Pt; max: Pt }

interface Entity {
  id: string
  getBounds(): Bounds
}

export class SpatialIndex {
  private grid: Map<string, Entity[]> = new Map()
  private cellSize: number
  
  constructor(cellSize: number = 100) {
    this.cellSize = cellSize
  }
  
  insert(entity: Entity) {
    const bounds = entity.getBounds()
    const cells = this.getCells(bounds)
    
    for (const cell of cells) {
      if (!this.grid.has(cell)) {
        this.grid.set(cell, [])
      }
      this.grid.get(cell)!.push(entity)
    }
  }
  
  queryPoint(point: Pt, radius: number): Entity[] {
    const bounds: Bounds = {
      min: { x: point.x - radius, y: point.y - radius },
      max: { x: point.x + radius, y: point.y + radius }
    }
    
    const cells = this.getCells(bounds)
    const results = new Set<Entity>()
    
    for (const cell of cells) {
      const entities = this.grid.get(cell)
      if (entities) {
        entities.forEach(e => results.add(e))
      }
    }
    
    return Array.from(results)
  }
  
  clear() {
    this.grid.clear()
  }
  
  rebuild(entities: Entity[]) {
    this.clear()
    entities.forEach(e => this.insert(e))
  }
  
  private getCells(bounds: Bounds): string[] {
    const minX = Math.floor(bounds.min.x / this.cellSize)
    const maxX = Math.floor(bounds.max.x / this.cellSize)
    const minY = Math.floor(bounds.min.y / this.cellSize)
    const maxY = Math.floor(bounds.max.y / this.cellSize)
    
    const cells: string[] = []
    for (let x = minX; x <= maxX; x++) {
      for (let y = minY; y <= maxY; y++) {
        cells.push(`${x},${y}`)
      }
    }
    return cells
  }
}
```

**ä½¿ç”¨ï¼š**

```typescript
// App.tsx
const spatialIndexRef = useRef(new SpatialIndex(100))

useEffect(() => {
  spatialIndexRef.current.rebuild(entities)
}, [entities])

// inference-engine.ts
function findNearest(mousePos: Pt, spatialIndex: SpatialIndex): Entity | null {
  const nearby = spatialIndex.queryPoint(mousePos, 10)
  // åªå¯¹nearbyåšç²¾ç¡®è®¡ç®—
}
```

---

## ğŸ“ ä½“æ£€æŠ¥å‘Šæ¨¡æ¿

**CTOå®Œæˆåå¡«å†™ï¼š**

```markdown
## æ€§èƒ½ä½“æ£€ç»“æœ

**æ—¥æœŸï¼š** 2026-02-04
**æ‰§è¡Œäººï¼š** [ä½ çš„åå­—]

### å¤ç°
ä»___æ¡çº¿å¼€å§‹æ˜æ˜¾å˜æ…¢

### ç“¶é¢ˆï¼ˆå‹¾é€‰ä¸»è¦é—®é¢˜ï¼‰
- [ ] æ¸²æŸ“æ…¢ï¼ˆrenderMs = ___msï¼‰
- [ ] hitTestæ…¢ï¼ˆhitTestMs = ___msï¼‰
- [ ] Memoryæ³„æ¼ï¼ˆå¢é•¿___MBï¼‰
- [ ] Listenersæ³„æ¼ï¼ˆ___ä¸ªï¼‰

### æ ¹å› 
ä¸»è¦é—®é¢˜ï¼š_______________
è¯æ®ï¼š_______________

### å·²ä¿®å¤ï¼ˆP0ï¼‰
- [ ] ç›‘å¬å™¨cleanupï¼ˆæ–‡ä»¶ï¼š_____ï¼‰
- [ ] Debug logå…³é—­ï¼ˆæ–‡ä»¶ï¼š_____ï¼‰
- [ ] hitTestä¼˜åŒ–ï¼ˆæ–¹æ³•ï¼š_____ï¼‰

### æµ‹è¯•ç»“æœ
ä¿®å¤å‰ï¼š
- 100æ¡çº¿ FPS = ___
- æ‹–åŠ¨æ„Ÿè§‰ = ___

ä¿®å¤åï¼š
- 100æ¡çº¿ FPS = ___
- æ‹–åŠ¨æ„Ÿè§‰ = ___
- æ”¹å–„ï¼š____%

### å¾…ä¼˜åŒ–ï¼ˆP1ï¼‰
- [ ] ç©ºé—´ç´¢å¼•ï¼ˆå¦‚æœhitTestä»æ…¢ï¼‰
- [ ] åˆ†å±‚æ¸²æŸ“ï¼ˆå¦‚æœrenderä»æ…¢ï¼‰
```

---

## ğŸ¯ é‡ç‚¹æ–‡ä»¶ä½ç½®

**éœ€è¦æ£€æŸ¥ï¼š**
```
src/tools/*.ts          â†’ ç›‘å¬å™¨cleanup
src/inference/*.ts      â†’ hitTestä¼˜åŒ–
src/renderer/*.ts       â†’ renderMsæµ‹é‡
src/store/undo.ts       â†’ æ˜¯å¦æ·±æ‹·è´
```

**éœ€è¦ä¿®æ”¹ï¼š**
```
src/components/PerformanceMonitor.tsx  â†’ æ–°å»º
src/config.ts                          â†’ æ·»åŠ DEBUGå¼€å…³
```

---

## âš¡ å¿«é€Ÿæµ‹è¯•

**æµ‹è¯•1ï¼šFPS**
```
ç”»100æ¡çº¿ â†’ æ‹–åŠ¨5ç§’ â†’ è§‚å¯ŸFPS
æœŸæœ›ï¼š> 45
```

**æµ‹è¯•2ï¼šMemory**
```
è®°å½•åˆå§‹ â†’ ç”»100æ¡ â†’ Undo â†’ é‡å¤10æ¬¡ â†’ è®°å½•æœ€ç»ˆ
æœŸæœ›ï¼šå¢é•¿ < 50MB
```

**æµ‹è¯•3ï¼šListeners**
```
Console: getEventListeners(document)
åˆ‡æ¢å·¥å…·10æ¬¡ â†’ å†æ£€æŸ¥
æœŸæœ›ï¼šæ•°é‡ä¸å¢é•¿
```

---

**æ‰§è¡Œäººï¼š** CTO  
**é¢„è®¡å®Œæˆï¼š** ä»Šå¤©  
**éªŒæ”¶äººï¼š** CEO

---

æ‰€æœ‰ä»£ç éƒ½åœ¨ä¸Šé¢ï¼Œç›´æ¥å¤åˆ¶åˆ°é¡¹ç›®ä½¿ç”¨å³å¯ã€‚æœ‰é—®é¢˜éšæ—¶åé¦ˆï¼ğŸš€

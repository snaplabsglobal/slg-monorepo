# PlanSnap CAD 风格改进 - 快速参考卡

> **日期：** 2026-02-02  
> **优先级：** 🔴 Critical  
> **工作量：** 7天

---

## 🎯 三个核心改进

### 1. 线宽系统（1天）

**要求：** AutoCAD 风格，不是 magicplan 风格

| 类型 | 宽度 |
|------|------|
| 普通墙线 | 1px / 1.25px |
| 选中线 | 2px |
| 辅助线 | 0.75px 虚线 |

**代码：**
```typescript
const LINE_WIDTHS = {
  wall: { default: 1, selected: 2, hover: 1.5 },
  guide: { default: 0.75, selected: 1.5, hover: 1 }
};
```

---

### 2. Inference Engine（3天）

**要求：** SketchUp 式自动推断

**推断类型（优先级）：**
1. Endpoint（端点）- 100分
2. Intersection（交点）- 95分
3. Midpoint（中点）- 90分
4. Perpendicular（垂直）- 70分
5. Parallel（平行）- 65分

**容差：**
- 点吸附：10px
- 线吸附：8px
- 角度容差：3°

**视觉反馈：**
- Endpoint: 红色圆点
- Midpoint: 蓝色圆点
- Intersection: 紫色圆点
- Parallel/Perp: 绿色方向线

---

### 3. 键盘输入系统（2天）

**要求：** 直接输入长度，无需输入框

**支持格式：**
```
"9'6"   → 9 feet 6 inches
"114"   → 114 inches
"2.3m"  → 2.3 meters
"750mm" → 750 millimeters
```

**交互：**
```
拉线 → 输入 "9'6" → Enter 确认
```

---

## ⌨️ 新增快捷键

| 键 | 功能 |
|----|------|
| **T** | 辅助线模式（Tape） |
| **Enter** | 确认数字输入 |
| **Backspace** | 删除输入 |
| **Esc** | 取消 |
| **Shift** | 锁定水平/垂直 |

---

## 📐 T 键辅助线流程

```
1. 按 T
2. 鼠标靠近线段 → 自动显示中点（蓝色）
3. 点击中点
4. 拖动 → 出现平行辅助线（虚线）
5. 输入 "1'3" → 辅助线距中点 1'3"
6. Enter 确认
```

---

## 🚀 性能优化

**空间哈希（Spatial Hash）：**

```typescript
const spatialHash = new SpatialHash(24); // 2 ft cell size

// 查询附近线段（O(1) 而不是 O(n)）
const nearSegs = spatialHash.query(mousePos, 20);
```

**性能对比：**
- 1000 条线段：从 ~5ms → ~0.2ms

---

## ✅ 验收标准（CEO 口径）

```
✅ 线条细，像 AutoCAD
✅ 能自动找到中心点
✅ 按 T 可以从中点拉辅助线
✅ 拉线时可以直接输入 "9'6"
✅ 不用看 UI 就能画图（专业感）
✅ 能闭眼输入尺寸（信任感）
```

---

## 📋 实施计划（7天）

| 阶段 | 任务 | 工作量 |
|------|------|--------|
| Phase 1 | 线宽系统 | 1天 |
| Phase 2 | Inference Engine | 3天 |
| Phase 3 | 键盘输入系统 | 2天 |
| Phase 4 | 测试打磨 | 1天 |

---

## 💡 关键代码位置

**新增文件：**
```
/packages/plan-snap/src/
  ├── inference/
  │   ├── InferenceEngine.ts    ⭐ 核心推断引擎
  │   └── types.ts
  ├── spatial/
  │   └── SpatialHash.ts        ⭐ 空间索引
  ├── input/
  │   └── LengthParser.ts       ⭐ 长度解析
  └── utils/
      └── resolveEndPoint.ts
```

**修改文件：**
```
/packages/plan-snap/src/
  ├── types/index.ts            + thickness, type: 'guide'
  ├── canvas/PlanCanvas.ts      + renderLine 更新
  └── reducers/ToolReducer.ts   + KEY_CHAR, KEY_T
```

---

## 🎯 成功标志

**CPO 评价：**
> "这是 AutoCAD + SketchUp 核心手感三连击"

**CEO 判断：**
> "从'看起来像工具'到'像专业 CAD'"

**底气：**
> "这就是你们可以堂堂正正卖 $19.99 的底气"

---

**详细文档见：PlanSnap CAD 风格改进 - 技术实施方案（完整版）**

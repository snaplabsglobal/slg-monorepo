# 会议纪要 - PlanSnap 画图手感升级

> **会议时间：** 2026-02-03  
> **会议类型：** 功能规划会议  
> **参与人员：** CPO、CDO  
> **优先级：** 🔴 P0 - Critical  
> **状态：** ✅ 已确定方案

---

## 📋 会议背景

### 战略调整

**CPO明确指出：**
> "Tape 平行辅助线 + 分数输入/空格确实是'画图手感的地基'，比继续纠结角度锁更能立刻提升体验、也更容易验收。"

**原因：**
- 角度锁定已经有完整方案，可以并行推进
- Tape工具和分数输入是"基础能力"，影响所有绘图场景
- 更容易验收（功能明确，效果可见）
- 直接对标SketchUp，用户熟悉度高

---

## 🎯 会议决策

### 本次做什么（P0优先级）

#### A. Tape Offset Guides
```
任意点生成平行辅助线 + 数值输入
参考：SketchUp的Tape Measure工具
```

**核心功能：**
- T键进入Tape工具
- 鼠标移到任意线段，显示"On Segment"
- 点击锁定参照点
- 拖拽生成平行虚线（无限延伸）
- 可输入距离（支持分数）
- Enter提交，Esc取消

---

#### B. Fraction Input / Space行为修复
```
支持 12 1/8 这样的英制分数输入
Typing时Space不再是Esc
```

**核心功能：**
- 输入12 1/8，空格不触发取消
- 支持 9'6 / 9'-6 3/16" / 300mm 混合输入
- Esc只清空buffer，不退出工具
- 光标附近显示输入内容

---

### 明确不做什么（防止失控）

**非范围（本次不做）：**
```
❌ 不做"沿线测距 Tape measure"（只做平行guide）
❌ 不做"多guide锁定链式偏移"（单次生成即可）
❌ 不做"角度锁定"相关改动（本次冻结，已有完整方案）
```

**理由：**
- 保持Scope可控
- 快速交付核心功能
- 避免与角度锁定方案冲突

---

## 🏗️ 技术方案概要

### A. Tape Offset Guides

#### 状态机设计

```typescript
type Tool = 'SELECT' | 'DRAW_LINE' | 'TAPE_GUIDE'

type TapeState =
  | { phase: 'IDLE' }
  | { phase: 'HOVER_SEGMENT'; segmentId: string; hoverPoint: Pt }
  | { phase: 'ARMED'; segmentId: string; anchor: Pt; u: Vec; n: Vec }
  | { phase: 'DRAGGING'; segmentId: string; anchor: Pt; u: Vec; n: Vec; dMm: number; previewGuide: Guide }
  | { phase: 'TYPING'; segmentId: string; anchor: Pt; u: Vec; n: Vec; typing: string; dMm?: number }
  | { phase: 'COMMITTED' }
```

**状态转换：**
```
IDLE → (鼠标移到线段) → HOVER_SEGMENT
HOVER_SEGMENT → (点击) → ARMED
ARMED → (拖拽) → DRAGGING
DRAGGING → (输入) → TYPING
TYPING → (Enter) → COMMITTED
任何状态 → (Esc) → HOVER_SEGMENT/IDLE（不退出工具）
```

---

#### 数据结构

```typescript
type Guide = {
  id: string
  kind: 'guide'
  
  // 无限线定义
  p: Pt          // anchor shifted point P'
  dir: Vec       // parallel direction u
  
  createdAt: number
  source: { 
    segmentId: string
    anchor: Pt
    offsetMm: number 
  }
}
```

**关键点：**
- Guide是无限线（渲染时裁剪到视口）
- 存储在独立的 `guides[]` layer
- 不参与闭合/面积计算
- 可作为snap目标

---

#### 交互流程（按SketchUp肌肉记忆）

**1. Hover**
```
鼠标移到任意线段 → 显示 "On Segment"
hoverPoint = 鼠标投影到线段
```

**2. Click（锁定参照）**
```
在segment任意点点击
→ 锁定 segmentId + anchor = hoverPoint
→ 计算方向向量：
   u = normalize(B - A)  // 平行方向
   n = perp(u)           // 法线方向
```

**3. Drag（生成预览）**
```
鼠标移动形成offset距离
→ d = dot(mouse - anchor, n)（带符号）
→ P' = anchor + n * d
→ 预览 guide(p=P', dir=u)
```

**4. Typing（输入距离）**
```
输入 3" / 12 1/8" / 300mm
→ 使用统一parser → dMm
→ guide用 P' = anchor + n * sign(d) * dMm
```

**5. Enter（提交）**
```
保存Guide到guides layer
→ 回到 HOVER_SEGMENT/IDLE
```

---

#### Snap优先级（Tape模式专用）

**Tape模式中：**
```
✅ onSegment投影（必须）
❌ 不使用grid snap（或作为很低优先级）
```

**Guide生成后：**
```
在DRAW_LINE模式：guide可作为snap目标
（后续增量功能）
```

---

#### 渲染规范

**视觉样式：**
```
虚线（dash）
淡色（50%透明度）
线宽比普通线细一点
```

**无限线渲染：**
```
计算guide与视口边界的交点
只渲染视口内的部分
```

---

### B. Fraction Input & Space行为

#### 输入状态机（全工具通用）

```typescript
type InputState =
  | { mode: 'IDLE' }
  | { mode: 'TYPING'; buffer: string; context: 'length' | 'offset' | 'dimension' }
  | { mode: 'INVALID'; buffer: string; context: 'length' | 'offset' | 'dimension' }
```

**状态转换：**
```
IDLE → (输入数字) → TYPING
TYPING → (Space) → buffer += ' '（不是取消！）
TYPING → (Backspace) → 删除一位
TYPING → (Enter) → parse → commit
TYPING → (Esc) → buffer清空 → IDLE（不退出工具）
```

---

#### 关键规则（核心）

**✅ Space行为区分：**
```
TYPING状态：Space = 分隔符（进入buffer）
IDLE状态：Space = 可能的取消操作（如果保留）
```

**✅ Esc行为：**
```
TYPING状态：Esc = 清空buffer → IDLE
IDLE状态：Esc = 取消当前操作（如取消画线）
```

**这条规则是核心：**
> Space只在IDLE才能当取消，在TYPING必须是输入字符。

---

#### 解析器（统一入口）

```typescript
parseLengthToMM(input: string, defaultUnit: 'in' | 'mm'): number
```

**defaultUnit规则：**
```
Imperial UI → defaultUnit = 'in'
Metric UI → defaultUnit = 'mm'
```

**必须支持的格式：**
```
12 1/8          → 12.125 in
1/8             → 0.125 in
12.5            → 12.5 (in or mm, 取决于defaultUnit)
114"            → 114 in
9'6             → 9.5 ft = 114 in
9' 6"           → 114 in
9'-6 3/16"      → 114.1875 in
300mm           → 300 mm
2.3m            → 2300 mm
```

---

#### 输入框UI（推荐但不强制）

**显示位置：** 光标附近

**显示内容：**
```
TYPING: "12 1/8"（原样显示）
INVALID: "Invalid"（红色）
Enter后: 消失
```

**作用：**
- 极大减少用户"我输入进去了吗"的疑虑
- 即时反馈输入状态

---

## 📋 Jira Epic拆分

### Epic Key: PS-P0-DRAWING-FEEL

**目标：** 显著提升画图效率与专业感（不涉及角度锁）

---

### Epic A: Tape Offset Guides（平行辅助线）

#### P0-101 — Tape工具状态机

**Scope：**
- 新增工具 TAPE_GUIDE
- 支持 IDLE → HOVER → ARMED → DRAGGING → TYPING → COMMIT/CANCEL

**实现要点：**
- T切换工具（进入/退出）
- Esc只取消本次guide，不退出工具

**DoD：**
- [ ] T进入Tape
- [ ] Esc取消guide但仍停留在Tape
- [ ] 工具切换不影响其他工具

**验收：**
- 连续生成多个guide，不互相干扰

---

#### P0-102 — onSegment投影与锚点锁定

**Scope：**
- Hover任意线段显示 On Segment
- Click锁定参照线段与锚点

**实现要点：**
- 线段投影：`hoverPoint = project(mouse, segment)`
- 锁定 `segmentId + anchor`

**DoD：**
- [ ] 任意点可锁定（非端点/中点）
- [ ] 锚点稳定，不随鼠标跳变

**验收：**
- 斜线、短线、长线均可锁定

---

#### P0-103 — 平行Guide生成与预览

**Scope：**
- Drag沿法线生成平行虚线预览

**实现要点：**
```
u = normalize(B-A)
n = perp(u)
d = dot(mouse-anchor, n)
P' = anchor + n*d
```

**DoD：**
- [ ] 正反两侧偏移正确
- [ ] 虚线样式、淡色

**验收：**
- 快速拖拽不卡顿
- 斜线平行方向正确

---

#### P0-104 — Guide Layer & Snap接入

**Scope：**
- Guide存入独立layer
- 后续工具可snap到guide（onGuide）

**实现要点：**
- `kind='guide'`
- 无限线渲染（视口裁剪）

**DoD：**
- [ ] Guide不参与闭合/面积
- [ ] 可作为snap目标

**验收：**
- 画线能吸附到guide

---

#### P0-105 — Tape数值输入集成

**Scope：**
- Tape拖拽中支持输入距离（英/公制混输）

**实现要点：**
- 复用 `parseLengthToMM`
- 保留拖拽方向符号

**DoD：**
- [ ] 3" / 12 1/8" / 300mm 生效
- [ ] Enter提交guide
- [ ] Esc仅清输入

**验收：**
- 输入与拖拽可互相切换

---

### Epic B: Fraction Input & Space行为修复

#### P0-201 — 输入状态机（Typing vs Idle）

**Scope：**
- 全局输入状态机
- Typing时Space ≠ Esc

**实现要点：**
- `InputState: IDLE | TYPING`
- Key routing先判断InputState

**DoD：**
- [ ] Typing时Space写入buffer
- [ ] Esc只清buffer，不退出工具

**验收：**
- 12 1/8 可完整输入

---

#### P0-202 — 分数解析器接入

**Scope：**
- 接入 `parseLengthToMM`
- defaultUnit随UI单位

**实现要点：**
- Imperial UI → default in
- Metric UI → default mm

**DoD：**
- [ ] 支持 12 1/8
- [ ] 支持 9'6 / 9'-6 3/16"
- [ ] 支持 300mm / 2.3m

**验收：**
- 解析误差在容许范围（浮点）

---

#### P0-203 — Typing UI提示（可选但推荐）

**Scope：**
- 光标旁显示输入buffer

**实现要点：**
- 只在TYPING显示
- INVALID显示错误提示

**DoD：**
- [ ] 用户可见输入内容
- [ ] Enter后消失

**验收：**
- 用户不再"猜我有没有输入进去"

---

## ✅ Epic级验收清单

### 功能验收

- [ ] **Tape任意点平行guide可用**
  - T进入工具
  - 任意点锁定
  - 拖拽生成平行虚线
  - 输入距离生效
  - Enter提交

- [ ] **Guide可吸附**
  - 画线时能snap到guide
  - onGuide推断正常

- [ ] **分数输入完整**
  - 12 1/8 不被Space取消
  - 各种格式都能解析
  - 光标附近可见输入

- [ ] **Esc行为正确**
  - Typing时：清buffer
  - Idle时：取消操作
  - 区分明确

---

### 回归测试

- [ ] **缩放/旋转稳定**
  - Zoom in/out下guide不漂移
  - 旋转后guide方向正确

- [ ] **多工具协同**
  - Tape → Line 切换无问题
  - Line → Tape 切换无问题

- [ ] **性能**
  - 快速拖拽不卡顿
  - 生成多个guide不降速

---

## ⏱️ 建议排期

### Day 1-2: Tape基础
- P0-101 Tape工具状态机
- P0-102 onSegment投影
- P0-103 平行Guide生成

**交付物：** 基础Tape工具可用

---

### Day 3: Tape完善
- P0-104 Guide Layer
- P0-105 数值输入集成

**交付物：** Tape功能完整

---

### Day 4: 输入系统
- P0-201 输入状态机
- P0-202 分数解析器

**交付物：** 分数输入可用

---

### Day 5: UI完善+回归
- P0-203 Typing UI
- Epic级回归测试

**交付物：** 全功能验收通过

---

## 🔧 关键接线点（CTO必须改）

### 1. Keydown分发（全局）

**当前可能的问题：**
```javascript
// ❌ 错误：没有区分状态
onKeyDown(key) {
  if (key === 'Space') {
    cancelCurrentOperation()  // 总是取消
  }
}
```

**正确实现：**
```javascript
// ✅ 正确：先判断输入状态
onKeyDown(key) {
  if (inputState.mode === 'TYPING') {
    if (key === 'Space') {
      appendToBuffer(' ')  // 输入字符
    } else if (key === 'Escape') {
      clearBuffer()  // 清空，但不退出工具
    }
  } else {  // IDLE
    if (key === 'Space') {
      cancelCurrentOperation()  // 可选，如果保留
    } else if (key === 'Escape') {
      cancelCurrentOperation()  // 取消操作
    }
  }
}
```

---

### 2. Tape工具拿输入结果

**流程：**
```javascript
onEnter() {
  if (inputState.mode === 'TYPING') {
    const dMm = parseLengthToMM(inputState.buffer, defaultUnit)
    const guideOffset = signFromDrag * dMm
    commitGuide(guideOffset)
    clearBuffer()
  }
}
```

---

### 3. 不要让鼠标事件打断typing

**关键：**
```javascript
onPointerMove(mouse) {
  // typing时仍然更新preview guide
  if (tapeState.phase === 'TYPING' || tapeState.phase === 'DRAGGING') {
    updatePreviewGuide(currentDMm || dragD)
  }
}
```

**说明：**
- 只有Enter才提交
- 鼠标移动不影响typing buffer

---

## 💬 CPO关键引用

### 关于优先级

> "Tape 平行辅助线 + 分数输入/空格确实是'画图手感的地基'，比继续纠结角度锁更能立刻提升体验、也更容易验收。"

### 关于Scope控制

> "本次只做两个P0，角度锁本次冻结不动。"

### 关于Space行为

> "Space只在IDLE才能当取消，在TYPING必须是输入字符。这条规则是核心。"

---

## 📊 与其他功能的关系

### 与角度锁定的关系

**状态：** 角度锁定已有完整方案（见DEC-003和DEC-004）

**本次策略：**
```
✅ Tape和分数输入优先
✅ 角度锁定并行推进（不冲突）
❌ 本次不做角度锁定相关改动
```

---

### 与Inference Engine的关系

**Tape模式：**
```
使用onSegment推断
不使用endpoint/midpoint/intersection
```

**DRAW_LINE模式：**
```
Guide可作为snap目标
onGuide / guideIntersection（后续增量）
```

---

### 与单位系统的关系

**复用现有单位系统：**
```
parseLengthToMM(input, defaultUnit)
defaultUnit跟随UI设置
```

---

## 🎓 设计理念

### SketchUp肌肉记忆

**为什么对标SketchUp：**
- SketchUp的Tape工具是行业标准
- 用户熟悉度高，无学习成本
- 交互逻辑经过验证

**关键体验：**
1. 任意点锁定（不限端点/中点）
2. 拖拽方向自动判断正负
3. 输入数值立即生效
4. Esc不退出工具（连续操作）

---

### 分数输入是必须的

**北美施工场景：**
```
英制分数是标准测量方式
12 1/8" 比 12.125" 更直观
```

**用户期望：**
```
能像在AutoCAD里一样输入分数
Space是分隔符，不是取消
```

---

## 📋 行动项

### CTO立即执行（本周）

**Day 1-5：** 按Jira Epic执行

**参考文档：**
- 本会议纪要
- 完整技术方案文档（待创建）
- 快速执行清单（待创建）

---

### CDO配合工作

**本周完成：**
- [ ] 创建完整技术方案文档
- [ ] 创建快速执行清单
- [ ] 更新决策日志
- [ ] 更新文档索引

---

### CPO验收安排

**Day 5：** Epic级验收

**验收标准：**
- 所有DoD通过
- 回归测试通过
- 录屏演示流畅

---

## 🔗 相关文档

**本次会议产出：**
1. 本会议纪要
2. 完整技术方案文档（待创建）
3. 快速执行清单（待创建）

**相关历史文档：**
1. 角度锁定系统方案（DEC-003）
2. 角度锁定UI/UX规范（DEC-004）
3. 单位系统技术规范（DEC-000）

---

**会议记录人：** CDO  
**会议时间：** 2026-02-03  
**下次Review：** Day 5（Epic验收）  
**状态：** ✅ 方案已确定，待执行

---

## 🎯 总结

这次会议明确了PlanSnap画图手感升级的核心优先级：
1. **Tape平行辅助线** - SketchUp式任意点平行guide
2. **分数输入** - 支持12 1/8，Space不再是Esc

这两个功能是"画图手感的地基"，比继续优化角度锁定更能立即提升用户体验。

CTO可以直接按Jira Epic执行，5天内完成全部功能。🚀

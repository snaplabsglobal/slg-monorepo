# JobSite Snap - å·¥æ—¶è®°å½•ç³»ç»Ÿ v2.0
## Project-as-Contextï¼ˆé¡¹ç›®å³ä¸Šä¸‹æ–‡ï¼‰

---

## ğŸ¯ æ ¸å¿ƒç†å¿µ

> **"é¡¹ç›®ä¸æ˜¯ç³»ç»Ÿç®—å‡ºæ¥çš„ï¼Œè€Œæ˜¯å·¥äººé¡ºæ‰‹é€‰çš„"**

**ç³»ç»Ÿçš„è´£ä»»ï¼š**
1. è®©é€‰æ‹©å˜å¾—æç®€å•
2. è®©é”™è¯¯å˜å¾—å¯ä¿®æ­£
3. è®©è€æ¿ä¸ç”¨å¤©å¤©ç›¯

---

## ğŸŸ¢ ä¸»æµç¨‹è®¾è®¡

### åœºæ™¯ 1ï¼šä¸€å¤©åªåœ¨ä¸€ä¸ªé¡¹ç›®ï¼ˆ80% æƒ…å†µï¼‰

```
å·¥äººæ—©ä¸Šæ‰“å¼€ App
    â†“
[START WORK] å¤§æŒ‰é’®
    â†“
å¼¹å‡ºé¡¹ç›®é€‰æ‹©ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½ ä»Šå¤©ä¸»è¦åœ¨å“ªä¸ªé¡¹ç›®ï¼Ÿ    â”‚
â”‚                         â”‚
â”‚ â—‹ 123 Main St          â”‚  â† ä¸Šæ¬¡é¡¹ç›®ï¼ˆé»˜è®¤é€‰ä¸­ï¼‰
â”‚   (Downtown Condo)      â”‚
â”‚                         â”‚
â”‚ â—‹ 456 Oak Ave          â”‚
â”‚   (Burnaby House)       â”‚
â”‚                         â”‚
â”‚ â—‹ 789 Elm Dr           â”‚
â”‚   (Richmond Townhouse)  â”‚
â”‚                         â”‚
â”‚ [+ å…¶ä»–é¡¹ç›®]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç‚¹å‡» [START] å¼€å§‹å·¥ä½œ
    â†“
âœ… ç­¾åˆ°æˆåŠŸï¼
æ˜¾ç¤ºï¼š123 Main St - 8:00 AM
    â†“
å½“å¤©æ‰€æœ‰åç»­æ‰“å¡ = è‡ªåŠ¨è¿™ä¸ªé¡¹ç›®
    â†“
ä¸­åˆä¼‘æ¯ï¼Ÿ [BREAK] æŒ‰é’®
ä¸‹ç­ï¼Ÿ     [END WORK] æŒ‰é’®
    â†“
ä¸å†é—®é¡¹ç›®ï¼
```

### åœºæ™¯ 2ï¼šä¸€å¤©è·¨ä¸¤ä¸ªé¡¹ç›®ï¼ˆ20% æƒ…å†µï¼‰

```
æ—©ä¸Šåœ¨é¡¹ç›® A å·¥ä½œ
    â†“
ä¸­åˆéœ€è¦å»é¡¹ç›® B
    â†“
å·¥äººç‚¹å‡»ï¼š[ğŸ”„ SWITCH PROJECT]
    â†“
é€‰æ‹©æ–°é¡¹ç›®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ‡æ¢åˆ°å“ªä¸ªé¡¹ç›®ï¼Ÿ         â”‚
â”‚                         â”‚
â”‚ â—‹ 456 Oak Ave          â”‚  â† é™„è¿‘é¡¹ç›®ï¼ˆGPSæ’åºï¼‰
â”‚   (2.3 km away)         â”‚
â”‚                         â”‚
â”‚ â—‹ 789 Elm Dr           â”‚
â”‚   (5.1 km away)         â”‚
â”‚                         â”‚
â”‚ [+ å…¶ä»–é¡¹ç›®]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç³»ç»Ÿè‡ªåŠ¨åš 3 ä»¶äº‹ï¼š
1. End é¡¹ç›® Aï¼ˆ12:00 PMï¼‰
2. Start é¡¹ç›® Bï¼ˆ12:30 PMï¼‰
3. è®°å½•åˆ‡æ¢åŸå› ï¼šmanual_switch
    â†“
ç»§ç»­åœ¨é¡¹ç›® B å·¥ä½œ
    â†“
ä¸‹ç­ [END WORK]
```

### åœºæ™¯ 3ï¼šå¿˜äº†æ‰“å¡ / å¿˜äº†åˆ‡æ¢ï¼ˆå¿…ç„¶å‘ç”Ÿï¼‰

```
æ™šä¸Šå·¥äººæƒ³èµ·æ¥ï¼š"ç³Ÿç³•ï¼Œå¿˜äº†æ‰“å¡ï¼"
    â†“
App é‡Œç‚¹å‡»ï¼š[ğŸ“ è¡¥å½•å·¥æ—¶]
    â†“
é€‰æ‹©æ—¥æœŸå’Œé¡¹ç›®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¡¥å½•å·¥æ—¶                â”‚
â”‚                         â”‚
â”‚ æ—¥æœŸï¼š2026-01-27        â”‚
â”‚                         â”‚
â”‚ é¡¹ç›® Aï¼š123 Main St     â”‚
â”‚ å¼€å§‹ï¼š9:00 AM           â”‚
â”‚ ç»“æŸï¼š2:00 PM           â”‚
â”‚                         â”‚
â”‚ [+ æ·»åŠ é¡¹ç›® B]          â”‚  â† å¦‚æœå»äº†ä¸¤ä¸ªå·¥åœ°
â”‚                         â”‚
â”‚ é¡¹ç›® Bï¼š456 Oak Ave     â”‚
â”‚ å¼€å§‹ï¼š2:30 PM           â”‚
â”‚ ç»“æŸï¼š6:00 PM           â”‚
â”‚                         â”‚
â”‚ [æäº¤å®¡æ‰¹]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ ‡è®°ä¸º manual_entry = true
    â†“
å‘é€ç»™è€æ¿å®¡æ‰¹
    â†“
è€æ¿çœ‹åˆ°ï¼š
"John Smith è¡¥å½•å·¥æ—¶ï¼ˆ2026-01-27ï¼‰"
- é¡¹ç›® Aï¼š5 å°æ—¶
- é¡¹ç›® Bï¼š3.5 å°æ—¶
GPS æç¤ºï¼šfarï¼ˆä½†å¯èƒ½åˆç†ï¼‰
    â†“
è€æ¿ä¸€é”®æ‰¹å‡† âœ…
```

---

## ğŸ“± ç•Œé¢è®¾è®¡ï¼ˆæç®€ç‰ˆï¼‰

### å·¥äºº App - ä¸»ç•Œé¢

#### çŠ¶æ€ 1ï¼šè¿˜æ²¡æ‰“å¡ï¼ˆæ—©ä¸Šï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JobSite Snap           â”‚
â”‚                         â”‚
â”‚  ğŸ‘· John Smith          â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    â”‚ â”‚
â”‚  â”‚   START WORK       â”‚ â”‚
â”‚  â”‚   [å·¨å¤§æŒ‰é’®]        â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”‚  ä¸Šæ¬¡é¡¹ç›®ï¼š123 Main St  â”‚
â”‚  æœ¬å‘¨å·¥æ—¶ï¼š34.5 å°æ—¶    â”‚
â”‚                         â”‚
â”‚  [æŸ¥çœ‹è¯¦æƒ…]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### çŠ¶æ€ 2ï¼šå·²æ‰“å¡ï¼ˆå·¥ä½œä¸­ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JobSite Snap           â”‚
â”‚                         â”‚
â”‚  âœ… å·¥ä½œä¸­              â”‚
â”‚  é¡¹ç›®ï¼š123 Main St      â”‚
â”‚  å¼€å§‹ï¼š8:00 AM          â”‚
â”‚  å·¥æ—¶ï¼š3.5 å°æ—¶         â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   END WORK         â”‚ â”‚
â”‚  â”‚   [å¤§æŒ‰é’®]          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”‚  [ğŸ”„ åˆ‡æ¢é¡¹ç›®]          â”‚
â”‚  [â˜• ä¼‘æ¯]              â”‚
â”‚                         â”‚
â”‚  ä»Šæ—¥å·¥æ—¶ï¼š3.5 å°æ—¶     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### çŠ¶æ€ 3ï¼šé¡¹ç›®åˆ‡æ¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ‡æ¢é¡¹ç›®               â”‚
â”‚                         â”‚
â”‚  å½“å‰ï¼š123 Main St      â”‚
â”‚  å·¥æ—¶ï¼š4.5 å°æ—¶         â”‚
â”‚                         â”‚
â”‚  åˆ‡æ¢åˆ°ï¼š               â”‚
â”‚  â—‹ 456 Oak Ave (2km)   â”‚  â† GPS æ’åº
â”‚  â—‹ 789 Elm Dr  (5km)   â”‚
â”‚  â—‹ 321 Pine St (8km)   â”‚
â”‚                         â”‚
â”‚  [+ å…¶ä»–é¡¹ç›®]           â”‚
â”‚                         â”‚
â”‚  [ç¡®è®¤åˆ‡æ¢]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§± æ•°æ®ç»“æ„è®¾è®¡

### æ ¸å¿ƒè¡¨ï¼štime_entriesï¼ˆå·¥æ—¶è®°å½•ï¼‰

```sql
CREATE TABLE time_entries (
  id UUID PRIMARY KEY,
  
  -- åŸºç¡€ä¿¡æ¯
  worker_id UUID NOT NULL REFERENCES workers(id),
  project_id UUID NOT NULL REFERENCES projects(id),
  date DATE NOT NULL,
  
  -- æ—¶é—´
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ,
  
  -- å·¥æ—¶è®¡ç®—
  total_hours DECIMAL(4,2), -- è‡ªåŠ¨è®¡ç®—
  break_hours DECIMAL(4,2) DEFAULT 0,
  billable_hours DECIMAL(4,2), -- total_hours - break_hours
  
  -- æ¥æºå’Œå¯ä¿¡åº¦
  entry_source TEXT NOT NULL CHECK (entry_source IN (
    'auto',           -- å·¥äººæ­£å¸¸æ‰“å¡
    'manual_entry',   -- å·¥äººè¡¥å½•
    'manual_split',   -- å·¥äººæ‰‹åŠ¨åˆ†å‰²é¡¹ç›®
    'admin_edit'      -- è€æ¿ä¿®æ”¹
  )),
  
  -- GPS æç¤ºï¼ˆä»…ä¾›å‚è€ƒï¼‰
  gps_hint TEXT CHECK (gps_hint IN (
    'near',      -- GPS æ˜¾ç¤ºåœ¨é¡¹ç›®é™„è¿‘ï¼ˆ< 500mï¼‰
    'moderate',  -- GPS æ˜¾ç¤ºåœ¨åˆç†èŒƒå›´ï¼ˆ500m - 5kmï¼‰
    'far',       -- GPS æ˜¾ç¤ºè¾ƒè¿œï¼ˆ> 5kmï¼‰
    'unknown'    -- æ—  GPS æ•°æ®
  )),
  gps_check_in GEOGRAPHY(POINT, 4326),  -- ç­¾åˆ°ä½ç½®
  gps_check_out GEOGRAPHY(POINT, 4326), -- ç­¾é€€ä½ç½®
  
  -- å®¡æ‰¹çŠ¶æ€ï¼ˆä»… manual_entry éœ€è¦ï¼‰
  approval_status TEXT DEFAULT 'approved' CHECK (approval_status IN (
    'pending',    -- ç­‰å¾…å®¡æ‰¹
    'approved',   -- å·²æ‰¹å‡†
    'rejected'    -- å·²æ‹’ç»
  )),
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMPTZ,
  rejection_reason TEXT,
  
  -- å…ƒæ•°æ®
  notes TEXT,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_time_entries_worker_date ON time_entries(worker_id, date DESC);
CREATE INDEX idx_time_entries_project ON time_entries(project_id, date DESC);
CREATE INDEX idx_time_entries_approval ON time_entries(approval_status) 
  WHERE approval_status = 'pending';
```

### è¾…åŠ©è¡¨ï¼šproject_switchesï¼ˆé¡¹ç›®åˆ‡æ¢æ—¥å¿—ï¼‰

```sql
CREATE TABLE project_switches (
  id UUID PRIMARY KEY,
  worker_id UUID NOT NULL REFERENCES workers(id),
  
  -- åˆ‡æ¢ä¿¡æ¯
  from_project_id UUID REFERENCES projects(id),
  to_project_id UUID NOT NULL REFERENCES projects(id),
  switch_time TIMESTAMPTZ NOT NULL,
  
  -- GPS å¯¹æ¯”
  from_gps GEOGRAPHY(POINT, 4326),
  to_gps GEOGRAPHY(POINT, 4326),
  distance_km DECIMAL(6,2), -- ä¸¤ä¸ªå·¥åœ°è·ç¦»
  
  -- è‡ªåŠ¨ç”Ÿæˆçš„æ—¶é—´åˆ†æ®µ
  previous_entry_id UUID REFERENCES time_entries(id),
  new_entry_id UUID REFERENCES time_entries(id),
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### è¾…åŠ©è¡¨ï¼šworker_project_preferencesï¼ˆå·¥äººé¡¹ç›®åå¥½ï¼‰

```sql
CREATE TABLE worker_project_preferences (
  id UUID PRIMARY KEY,
  worker_id UUID NOT NULL REFERENCES workers(id),
  project_id UUID NOT NULL REFERENCES projects(id),
  
  -- ç»Ÿè®¡æ•°æ®
  last_worked_at TIMESTAMPTZ,
  total_days_worked INTEGER DEFAULT 0,
  total_hours DECIMAL(8,2) DEFAULT 0,
  
  -- æ’åºæƒé‡ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
  frequency_score DECIMAL(5,2), -- æœ€è¿‘å·¥ä½œé¢‘ç‡
  
  UNIQUE(worker_id, project_id)
);
```

---

## ğŸ”„ æ ¸å¿ƒé€»è¾‘å®ç°

### 1. å¼€å§‹å·¥ä½œï¼ˆé€‰æ‹©é¡¹ç›®ï¼‰

```typescript
async function startWork(workerId: string) {
  // 1. è·å–æ¨èé¡¹ç›®åˆ—è¡¨
  const projects = await getRecommendedProjects(workerId);
  
  // 2. æ˜¾ç¤ºé¡¹ç›®é€‰æ‹©å™¨
  const selectedProject = await showProjectPicker(projects);
  
  // 3. è·å– GPSï¼ˆä»…ä¸€æ¬¡ï¼‰
  const gpsLocation = await getCurrentLocation();
  
  // 4. è®¡ç®— GPS æç¤º
  const gpsHint = calculateGPSHint(
    gpsLocation, 
    selectedProject.location
  );
  
  // 5. åˆ›å»ºå·¥æ—¶è®°å½•
  const timeEntry = await supabase
    .from('time_entries')
    .insert({
      worker_id: workerId,
      project_id: selectedProject.id,
      date: getCurrentDate(),
      start_time: new Date(),
      entry_source: 'auto',
      gps_hint: gpsHint,
      gps_check_in: gpsLocation,
      approval_status: 'approved' // æ­£å¸¸æ‰“å¡è‡ªåŠ¨æ‰¹å‡†
    });
  
  // 6. æ›´æ–°å·¥äººåå¥½
  await updateWorkerPreference(workerId, selectedProject.id);
  
  // 7. æ˜¾ç¤ºæˆåŠŸ
  showSuccess(`å·²ç­¾åˆ°ï¼š${selectedProject.name}`);
  
  return timeEntry;
}

// è·å–æ¨èé¡¹ç›®ï¼ˆæ™ºèƒ½æ’åºï¼‰
async function getRecommendedProjects(workerId: string) {
  const currentLocation = await getCurrentLocation();
  
  const { data } = await supabase.rpc('get_recommended_projects', {
    p_worker_id: workerId,
    p_current_lat: currentLocation.lat,
    p_current_lng: currentLocation.lng
  });
  
  // æ’åºé€»è¾‘ï¼š
  // 1. æœ€è¿‘å·¥ä½œçš„é¡¹ç›®ï¼ˆä¼˜å…ˆï¼‰
  // 2. é™„è¿‘çš„é¡¹ç›®ï¼ˆGPS è·ç¦»ï¼‰
  // 3. å¸¸å»çš„é¡¹ç›®ï¼ˆé¢‘ç‡ï¼‰
  
  return data;
}

// è®¡ç®— GPS æç¤º
function calculateGPSHint(
  currentLocation: GeoLocation,
  projectLocation: GeoLocation
): GPSHint {
  const distance = calculateDistance(currentLocation, projectLocation);
  
  if (distance < 0.5) return 'near';      // 500m å†…
  if (distance < 5.0) return 'moderate';  // 5km å†…
  return 'far';                           // > 5km
}
```

### 2. åˆ‡æ¢é¡¹ç›®

```typescript
async function switchProject(
  currentEntryId: string,
  newProjectId: string
) {
  // 1. ç»“æŸå½“å‰å·¥æ—¶
  const currentEntry = await supabase
    .from('time_entries')
    .update({
      end_time: new Date()
    })
    .eq('id', currentEntryId)
    .single();
  
  // 2. è·å– GPS
  const newLocation = await getCurrentLocation();
  
  // 3. è®¡ç®— GPS æç¤º
  const newProject = await getProject(newProjectId);
  const gpsHint = calculateGPSHint(newLocation, newProject.location);
  
  // 4. åˆ›å»ºæ–°å·¥æ—¶è®°å½•
  const newEntry = await supabase
    .from('time_entries')
    .insert({
      worker_id: currentEntry.worker_id,
      project_id: newProjectId,
      date: currentEntry.date,
      start_time: new Date(),
      entry_source: 'auto', // è™½ç„¶æ˜¯åˆ‡æ¢ï¼Œä½†ä»æ˜¯è‡ªåŠ¨
      gps_hint: gpsHint,
      gps_check_in: newLocation,
      approval_status: 'approved'
    });
  
  // 5. è®°å½•åˆ‡æ¢æ—¥å¿—
  await supabase.from('project_switches').insert({
    worker_id: currentEntry.worker_id,
    from_project_id: currentEntry.project_id,
    to_project_id: newProjectId,
    switch_time: new Date(),
    from_gps: currentEntry.gps_check_in,
    to_gps: newLocation,
    distance_km: calculateDistance(
      currentEntry.gps_check_in,
      newLocation
    ),
    previous_entry_id: currentEntryId,
    new_entry_id: newEntry.id
  });
  
  // 6. æ˜¾ç¤ºæˆåŠŸ
  showSuccess(`å·²åˆ‡æ¢åˆ°ï¼š${newProject.name}`);
  
  return newEntry;
}
```

### 3. è¡¥å½•å·¥æ—¶ï¼ˆæ™šä¸Šå¿˜äº†æ‰“å¡ï¼‰

```typescript
async function manualEntry(
  workerId: string,
  entries: Array<{
    projectId: string;
    date: Date;
    startTime: Date;
    endTime: Date;
  }>
) {
  const createdEntries = [];
  
  for (const entry of entries) {
    const project = await getProject(entry.projectId);
    
    // åˆ›å»ºè¡¥å½•è®°å½•
    const timeEntry = await supabase
      .from('time_entries')
      .insert({
        worker_id: workerId,
        project_id: entry.projectId,
        date: entry.date,
        start_time: entry.startTime,
        end_time: entry.endTime,
        entry_source: entries.length > 1 
          ? 'manual_split'   // å¤šä¸ªé¡¹ç›® = æ‰‹åŠ¨åˆ†å‰²
          : 'manual_entry',  // å•ä¸ªé¡¹ç›® = è¡¥å½•
        gps_hint: 'unknown', // è¡¥å½•æ²¡æœ‰ GPS
        approval_status: 'pending' // éœ€è¦å®¡æ‰¹
      });
    
    createdEntries.push(timeEntry);
  }
  
  // é€šçŸ¥è€æ¿
  await notifyManager({
    type: 'manual_entry_request',
    worker_id: workerId,
    entry_count: entries.length,
    date: entries[0].date
  });
  
  showSuccess('è¡¥å½•ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…å®¡æ‰¹');
  
  return createdEntries;
}
```

---

## ğŸ‘” è€æ¿ç«¯è®¾è®¡

### Dashboard - ä»Šæ—¥æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»Šæ—¥å·¥æ—¶æ¦‚è§ˆ - 2026å¹´1æœˆ27æ—¥           â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ 15äºº â”‚ â”‚127.5hâ”‚ â”‚ 3ä¸ª  â”‚            â”‚
â”‚  â”‚å·¥ä½œä¸­â”‚ â”‚æ€»å·¥æ—¶â”‚ â”‚å¾…å®¡æ‰¹â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                         â”‚
â”‚  ğŸ“ æŒ‰é¡¹ç›®æŸ¥çœ‹                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 123 Main St                      â”‚  â”‚
â”‚  â”‚ 5 äººå·¥ä½œä¸­ Â· 27.5 å°æ—¶          â”‚  â”‚
â”‚  â”‚ ğŸŸ¢ John  ğŸŸ¢ Mike  ğŸŸ¢ Carlos      â”‚  â”‚
â”‚  â”‚ ğŸŸ¢ Tom   ğŸŸ¢ Lisa                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 456 Oak Ave                      â”‚  â”‚
â”‚  â”‚ 3 äººå·¥ä½œä¸­ Â· 16.0 å°æ—¶          â”‚  â”‚
â”‚  â”‚ ğŸŸ¢ Patrick  ğŸŸ¢ Chen  ğŸŸ¢ Kumar   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚  âš ï¸ éœ€è¦æ³¨æ„                            â”‚
â”‚  ğŸ”´ 3 ä¸ªè¡¥å½•ç”³è¯·å¾…å®¡æ‰¹                  â”‚
â”‚  ğŸŸ¡ 2 äººå·¥æ—¶å¼‚å¸¸ï¼ˆGPS æ˜¾ç¤º farï¼‰       â”‚
â”‚                                         â”‚
â”‚  [å®æ—¶åˆ·æ–°] [æŸ¥çœ‹è¯¦æƒ…] [å¯¼å‡º]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®¡æ‰¹ç•Œé¢ - è¡¥å½•ç”³è¯·

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡¥å½•å·¥æ—¶ç”³è¯·                           â”‚
â”‚                                         â”‚
â”‚  å·¥äººï¼šJohn Smith                       â”‚
â”‚  æ—¥æœŸï¼š2026-01-27                       â”‚
â”‚  æäº¤æ—¶é—´ï¼š2026-01-27 8:30 PM          â”‚
â”‚                                         â”‚
â”‚  é¡¹ç›® Aï¼š123 Main St                   â”‚
â”‚  æ—¶é—´ï¼š9:00 AM - 2:00 PM               â”‚
â”‚  å·¥æ—¶ï¼š5.0 å°æ—¶                         â”‚
â”‚  GPSï¼šunknownï¼ˆè¡¥å½•æ— GPSï¼‰              â”‚
â”‚                                         â”‚
â”‚  é¡¹ç›® Bï¼š456 Oak Ave                   â”‚
â”‚  æ—¶é—´ï¼š2:30 PM - 6:00 PM               â”‚
â”‚  å·¥æ—¶ï¼š3.5 å°æ—¶                         â”‚
â”‚  GPSï¼šunknownï¼ˆè¡¥å½•æ— GPSï¼‰              â”‚
â”‚                                         â”‚
â”‚  ğŸ“ å·¥äººå¤‡æ³¨ï¼š                          â”‚
â”‚  "æ—©ä¸Šå¿˜äº†æ‰“å¡ï¼Œä¸‹åˆå»äº†ä¸¤ä¸ªå·¥åœ°"      â”‚
â”‚                                         â”‚
â”‚  ğŸ“Š å†å²è®°å½•ï¼š                          â”‚
â”‚  - æœ€è¿‘ 30 å¤©è¡¥å½•ï¼š2 æ¬¡                â”‚
â”‚  - å¹³å‡å‡ºå‹¤ç‡ï¼š95%                     â”‚
â”‚  - å¯ä¿¡åº¦è¯„åˆ†ï¼šâ­â­â­â­â­              â”‚
â”‚                                         â”‚
â”‚  [âœ… æ‰¹å‡†] [âŒ æ‹’ç»] [ğŸ’¬ ç•™è¨€]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¼‚å¸¸å·¥æ—¶æŸ¥çœ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GPS å¼‚å¸¸å·¥æ—¶ï¼ˆä»…ä¾›å‚è€ƒï¼‰               â”‚
â”‚                                         â”‚
â”‚  ğŸŸ¡ Mike Chen - 2026-01-27             â”‚
â”‚  é¡¹ç›®ï¼š123 Main St (Downtown)          â”‚
â”‚  GPSï¼šfar (12.5 km)                    â”‚
â”‚                                         â”‚
â”‚  å¯èƒ½åŸå› ï¼š                             â”‚
â”‚  â€¢ å·¥äººä½å¾—è¿œï¼ˆå¸¸è§ï¼‰                  â”‚
â”‚  â€¢ GPS ä¿¡å·é—®é¢˜                        â”‚
â”‚  â€¢ ç¡®å®ä¸åœ¨ç°åœº                        â”‚
â”‚                                         â”‚
â”‚  å†å²æ•°æ®ï¼š                             â”‚
â”‚  â€¢ è¯¥å·¥äººåœ¨æ­¤é¡¹ç›®å·¥ä½œ 15 å¤©            â”‚
â”‚  â€¢ GPS å§‹ç»ˆæ˜¾ç¤º far                    â”‚
â”‚  â€¢ ä»æœªè¢«æ‹’ç»                          â”‚
â”‚                                         â”‚
â”‚  å»ºè®®ï¼š                                 â”‚
â”‚  âœ… è‡ªåŠ¨æ”¾è¡Œï¼ˆè®¾ä¸ºå¯ä¿¡ï¼‰               â”‚
â”‚  æˆ– ç•™å¾…äººå·¥å®¡æ ¸                       â”‚
â”‚                                         â”‚
â”‚  [è®¾ä¸ºå¯ä¿¡é¡¹ç›®] [æŸ¥çœ‹è¯¦æƒ…]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ GPS çš„æ­£ç¡®ä½¿ç”¨æ–¹å¼

### âœ… GPS åº”è¯¥åšä»€ä¹ˆ

1. **è¾…åŠ©æ’åº**ï¼šæŠŠè¿‘çš„é¡¹ç›®æ’å‰é¢
2. **æä¾›æç¤º**ï¼šæ˜¾ç¤º `near / moderate / far`
3. **è®°å½•çº¿ç´¢**ï¼šç»™è€æ¿å‚è€ƒï¼ˆä¸æ˜¯åˆ¤å®šï¼‰

### âŒ GPS ä¸åº”è¯¥åšä»€ä¹ˆ

1. **è‡ªåŠ¨æ‹’ç»**ï¼šå³ä½¿ GPS æ˜¾ç¤º `far`ï¼Œä¹Ÿä¸èƒ½æ‹’ç»æ‰“å¡
2. **å¼ºåˆ¶åˆ†é…**ï¼šä¸èƒ½è‡ªåŠ¨åˆ¤æ–­"ä½ åº”è¯¥åœ¨å“ªä¸ªé¡¹ç›®"
3. **æŒç»­è¿½è¸ª**ï¼šä¸èƒ½åå°æŒç»­ç›‘æ§ä½ç½®ï¼ˆè´¹ç”µ + éšç§é—®é¢˜ï¼‰

### ğŸ“ GPS æ£€æŸ¥æ—¶æœº

```typescript
// âœ… æ­£ç¡®ï¼šåªåœ¨å¿…è¦æ—¶è·å–ä¸€æ¬¡
const gpsChecks = {
  startWork: true,      // å¼€å§‹å·¥ä½œæ—¶
  switchProject: true,  // åˆ‡æ¢é¡¹ç›®æ—¶
  endWork: true,        // ç»“æŸå·¥ä½œæ—¶ï¼ˆå¯é€‰ï¼‰
  
  duringWork: false,    // âŒ å·¥ä½œæœŸé—´ä¸æ£€æŸ¥
  breakTime: false,     // âŒ ä¼‘æ¯æ—¶ä¸æ£€æŸ¥
  background: false     // âŒ åå°ä¸æ£€æŸ¥
};
```

---

## ğŸ” è€æ¿çš„"éšå½¢ä¿é™©æœºåˆ¶"

### 1. å¯ä¿¡åº¦è¯„åˆ†ç³»ç»Ÿ

```typescript
interface WorkerTrustScore {
  worker_id: string;
  trust_level: 'high' | 'medium' | 'low';
  
  // è¯„åˆ†å› ç´ 
  attendance_rate: number;      // å‡ºå‹¤ç‡
  manual_entry_frequency: number; // è¡¥å½•é¢‘ç‡
  gps_consistency: number;      // GPS ä¸€è‡´æ€§
  approval_history: number;     // å®¡æ‰¹é€šè¿‡ç‡
  
  // è‡ªåŠ¨ç­–ç•¥
  auto_approve_manual_entry: boolean;
  require_photo_checkin: boolean;
}

// é«˜å¯ä¿¡åº¦å·¥äºº â†’ è‡ªåŠ¨æ‰¹å‡†è¡¥å½•
// ä½å¯ä¿¡åº¦å·¥äºº â†’ éœ€è¦äººå·¥å®¡æ ¸
```

### 2. å¼‚å¸¸æ¨¡å¼è¯†åˆ«

```typescript
// ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«çš„å¼‚å¸¸æ¨¡å¼
const anomalyPatterns = {
  // ğŸŸ¡ éœ€è¦æ³¨æ„ï¼ˆä¸æ‹¦æˆªï¼‰
  frequent_manual_entries: {
    threshold: 5,  // æ¯æœˆè¶…è¿‡ 5 æ¬¡è¡¥å½•
    action: 'notify_manager'
  },
  
  gps_far_consistently: {
    threshold: 0.8,  // 80% çš„æ‰“å¡ GPS éƒ½æ˜¯ far
    action: 'suggest_trusted_project'
  },
  
  unusual_hours: {
    threshold: 12,  // å•æ—¥è¶…è¿‡ 12 å°æ—¶
    action: 'flag_for_review'
  },
  
  // ğŸ”´ ä¸¥é‡å¼‚å¸¸ï¼ˆéœ€è¦å®¡æ‰¹ï¼‰
  impossible_travel: {
    // 1 å°æ—¶å†…åœ¨ä¸¤ä¸ªç›¸è· 50km çš„å·¥åœ°æ‰“å¡
    action: 'require_approval'
  }
};
```

### 3. é¡¹ç›®å¯ä¿¡è§„åˆ™

```typescript
// è€æ¿å¯ä»¥è®¾ç½®"å¯ä¿¡é¡¹ç›®"è§„åˆ™
interface TrustedProjectRule {
  worker_id: string;
  project_id: string;
  
  // è§„åˆ™
  allow_far_gps: boolean;       // å…è®¸ GPS æ˜¾ç¤º far
  auto_approve_manual: boolean; // è‡ªåŠ¨æ‰¹å‡†è¡¥å½•
  
  // åŸå› 
  reason: string; // "å·¥äººä½å¾—è¿œ" / "å¸¸é©»é¡¹ç›®"
}

// ç¤ºä¾‹ï¼š
// Mike Chen åœ¨ 123 Main St å·¥ä½œï¼Œè™½ç„¶ GPS æ€»æ˜¯ farï¼Œ
// ä½†è€æ¿çŸ¥é“ä»–ä½å¾—è¿œï¼Œè®¾ä¸ºå¯ä¿¡ â†’ è‡ªåŠ¨æ”¾è¡Œ
```

---

## ğŸ“Š æ•°æ®åº“å‡½æ•°å®ç°

### 1. è·å–æ¨èé¡¹ç›®

```sql
CREATE OR REPLACE FUNCTION get_recommended_projects(
  p_worker_id UUID,
  p_current_lat DECIMAL,
  p_current_lng DECIMAL
)
RETURNS TABLE (
  project_id UUID,
  project_name TEXT,
  project_address TEXT,
  distance_km DECIMAL,
  last_worked_at TIMESTAMPTZ,
  frequency_score DECIMAL,
  recommendation_score DECIMAL
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  WITH worker_prefs AS (
    -- å·¥äººçš„é¡¹ç›®åå¥½
    SELECT 
      wp.project_id,
      wp.last_worked_at,
      wp.frequency_score
    FROM worker_project_preferences wp
    WHERE wp.worker_id = p_worker_id
  ),
  distances AS (
    -- è®¡ç®—è·ç¦»
    SELECT 
      p.id as project_id,
      p.name as project_name,
      p.address as project_address,
      ROUND(
        ST_Distance(
          p.location,
          ST_SetSRID(ST_MakePoint(p_current_lng, p_current_lat), 4326)::geography
        ) / 1000,
        2
      ) as distance_km
    FROM projects p
    WHERE p.is_active = true
  )
  SELECT 
    d.project_id,
    d.project_name,
    d.project_address,
    d.distance_km,
    wp.last_worked_at,
    COALESCE(wp.frequency_score, 0) as frequency_score,
    -- ç»¼åˆè¯„åˆ†ï¼ˆ3 ä¸ªå› ç´ ï¼‰
    (
      -- 1. æœ€è¿‘å·¥ä½œçš„é¡¹ç›®ï¼ˆæƒé‡ 50%ï¼‰
      CASE 
        WHEN wp.last_worked_at > NOW() - INTERVAL '7 days' THEN 50
        WHEN wp.last_worked_at > NOW() - INTERVAL '30 days' THEN 30
        ELSE 10
      END +
      -- 2. è·ç¦»è¿‘çš„é¡¹ç›®ï¼ˆæƒé‡ 30%ï¼‰
      CASE 
        WHEN d.distance_km < 1 THEN 30
        WHEN d.distance_km < 5 THEN 20
        WHEN d.distance_km < 10 THEN 10
        ELSE 5
      END +
      -- 3. å¸¸å»çš„é¡¹ç›®ï¼ˆæƒé‡ 20%ï¼‰
      COALESCE(wp.frequency_score * 20, 0)
    ) as recommendation_score
  FROM distances d
  LEFT JOIN worker_prefs wp ON d.project_id = wp.project_id
  ORDER BY recommendation_score DESC, distance_km ASC
  LIMIT 10;
END;
$$;
```

### 2. è‡ªåŠ¨æ‰¹å‡†æˆ–æ‹’ç»å·¥æ—¶

```sql
CREATE OR REPLACE FUNCTION auto_approve_time_entry()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
  v_trust_score RECORD;
  v_trusted_rule RECORD;
BEGIN
  -- å¦‚æœæ˜¯ auto æ¥æºï¼Œè‡ªåŠ¨æ‰¹å‡†
  IF NEW.entry_source = 'auto' THEN
    NEW.approval_status := 'approved';
    RETURN NEW;
  END IF;
  
  -- å¦‚æœæ˜¯ manual_entryï¼Œæ£€æŸ¥å¯ä¿¡åº¦
  IF NEW.entry_source IN ('manual_entry', 'manual_split') THEN
    -- è·å–å·¥äººå¯ä¿¡åº¦
    SELECT * INTO v_trust_score
    FROM worker_trust_scores
    WHERE worker_id = NEW.worker_id;
    
    -- é«˜å¯ä¿¡åº¦ + ä½é£é™© â†’ è‡ªåŠ¨æ‰¹å‡†
    IF v_trust_score.trust_level = 'high' 
       AND v_trust_score.auto_approve_manual_entry = true
    THEN
      NEW.approval_status := 'approved';
      RETURN NEW;
    END IF;
    
    -- æ£€æŸ¥æ˜¯å¦æœ‰å¯ä¿¡é¡¹ç›®è§„åˆ™
    SELECT * INTO v_trusted_rule
    FROM trusted_project_rules
    WHERE worker_id = NEW.worker_id
      AND project_id = NEW.project_id
      AND auto_approve_manual = true;
    
    IF v_trusted_rule.id IS NOT NULL THEN
      NEW.approval_status := 'approved';
      RETURN NEW;
    END IF;
  END IF;
  
  -- é»˜è®¤ï¼šéœ€è¦å®¡æ‰¹
  NEW.approval_status := 'pending';
  
  RETURN NEW;
END;
$$;

CREATE TRIGGER auto_approve_time_entry_trigger
BEFORE INSERT ON time_entries
FOR EACH ROW
EXECUTE FUNCTION auto_approve_time_entry();
```

---

## ğŸ¯ å…³é”®è®¾è®¡åŸåˆ™æ€»ç»“

### 1. é¡¹ç›®æ˜¯"é€‰çš„"ï¼Œä¸æ˜¯"ç®—çš„"

```
âŒ é”™è¯¯ï¼šç³»ç»Ÿæ ¹æ® GPS è‡ªåŠ¨åˆ¤æ–­é¡¹ç›®
âœ… æ­£ç¡®ï¼šå·¥äººé€‰æ‹©é¡¹ç›®ï¼ŒGPS åªæ˜¯å‚è€ƒ
```

### 2. ç®€å• > å‡†ç¡®

```
âŒ é”™è¯¯ï¼šå¤æ‚çš„ GPS è¿½è¸ª + AI åˆ¤æ–­
âœ… æ­£ç¡®ï¼šå·¥äººä¸€æ¬¡é€‰æ‹© + éœ€è¦æ—¶æ‰‹åŠ¨åˆ‡æ¢
```

### 3. å¯ä¿®æ­£ > ä¸å‡ºé”™

```
âŒ é”™è¯¯ï¼šç³»ç»Ÿæ‹’ç»æ˜æ˜¾é”™è¯¯çš„æ‰“å¡
âœ… æ­£ç¡®ï¼šå…è®¸æ‰“å¡ï¼Œæ™šä¸Šå¯ä»¥è¡¥å½•ä¿®æ­£
```

### 4. ä¿¡ä»» > ç›‘æ§

```
âŒ é”™è¯¯ï¼šGPS æŒç»­è¿½è¸ªï¼Œå¼ºåˆ¶éªŒè¯ä½ç½®
âœ… æ­£ç¡®ï¼šä¸€æ¬¡æ€§æ£€æŸ¥ï¼Œç»™è€æ¿å‚è€ƒçº¿ç´¢
```

---

## ğŸš€ MVP å®ç°ä¼˜å…ˆçº§

### Phase 1ï¼ˆ2å‘¨ï¼‰- æ ¸å¿ƒæµç¨‹

**å¿…é¡»æœ‰ï¼š**
1. âœ… é¡¹ç›®é€‰æ‹©å™¨ï¼ˆæ™ºèƒ½æ’åºï¼‰
2. âœ… å¼€å§‹/ç»“æŸå·¥ä½œ
3. âœ… åˆ‡æ¢é¡¹ç›®
4. âœ… è¡¥å½•å·¥æ—¶

**æš‚æ—¶ä¸åšï¼š**
- â¸ï¸ ç…§ç‰‡ç­¾åˆ°
- â¸ï¸ å¤æ‚çš„å¯ä¿¡åº¦è¯„åˆ†
- â¸ï¸ é«˜çº§åˆ†ææŠ¥è¡¨

### Phase 2ï¼ˆ1å‘¨ï¼‰- è€æ¿ç«¯

1. âœ… å®æ—¶å·¥æ—¶æŸ¥çœ‹
2. âœ… å®¡æ‰¹è¡¥å½•ç”³è¯·
3. âœ… GPS å¼‚å¸¸æç¤º
4. âœ… åŸºç¡€æŠ¥è¡¨å¯¼å‡º

### Phase 3ï¼ˆ1å‘¨ï¼‰- ä¼˜åŒ–

1. âœ… å¯ä¿¡é¡¹ç›®è§„åˆ™
2. âœ… è‡ªåŠ¨æ‰¹å‡†é€»è¾‘
3. âœ… æ€§èƒ½ä¼˜åŒ–

---

## ğŸŠ æœ€ç»ˆæ¶æ„ä¸€å¥è¯

> **"é¡¹ç›®ä¸æ˜¯ç³»ç»Ÿç®—å‡ºæ¥çš„ï¼Œè€Œæ˜¯å·¥äººé¡ºæ‰‹é€‰çš„ã€‚ç³»ç»Ÿçš„è´£ä»»æ˜¯ï¼šè®©é€‰æ‹©å˜å¾—æç®€å•ã€è®©é”™è¯¯å˜å¾—å¯ä¿®æ­£ã€è®©è€æ¿ä¸ç”¨å¤©å¤©ç›¯ã€‚"**

---

**è¦æˆ‘å¼€å§‹åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„å—ï¼Ÿ** ğŸš€

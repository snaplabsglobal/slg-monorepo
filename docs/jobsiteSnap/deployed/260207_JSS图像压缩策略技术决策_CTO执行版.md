# JSS 图像压缩策略技术决策文档（CTO执行版）

> **文档类型：** 技术决策 + 工程规范  
> **关联文档：** 260207_SnapEvidence相机模块技术规格_CTO执行版.md  
> **创建时间：** 2026-02-07  
> **优先级：** 🟡 P1 - Phase 1.5执行  
> **决策人：** CEO + CPO + COO  
> **执行人：** CTO

---

## 📋 执行摘要

**问题背景：**
- CEO发现CompanyCam上传快，照片大多在300KB以内
- JSS当前照片2-3MB，担心上传速度

**最终决策：**
- ✅ Phase 1.5实施适度压缩（300-600KB）
- ✅ 原图保留在App私有存储（7天自动清理）
- ❌ 不写入系统相册（防止污染用户空间）
- ❌ 不激进压缩到<300KB

**核心原则：**
> 压缩"可以做"，但必须是：可逆的、可控的、不污染用户体验的

---

## 🎯 决策背景：CompanyCam为什么快？

### CEO观察

**原文：**
> "我刚刚试了一下company cam，他的上传速度很快。是不是因为他把照片压缩得很少的原因，我看了一下大部分都在300k以内。我看我们的照片有些都快2.63mb了"

---

### CPO分析：CompanyCam的三重压缩策略

#### 1️⃣ 强制JPEG重编码

**原始照片（iPhone）：**
- HEIC / JPEG
- 2-4MB很常见

**CompanyCam：**
- 统一转成JPEG
- quality大概在0.6-0.7
- 分辨率限制在2048px或更低

**结果：** ~300KB + 看起来"还行"

---

#### 2️⃣ 分辨率上限（比想象的狠）

```javascript
// CompanyCam可能的限制
max(width, height) = 1600px or 2048px

// 而不是保留：
// iPhone原图：4032×3024
// 或12MP原图
```

---

#### 3️⃣ 他们牺牲了什么？

**肉眼不一定立刻注意，但在这些场景会暴露：**
- 放大看细节（裂缝、螺丝、线管编号）
- 阴影区域细节
- 再次截图/二次使用

**CompanyCam是有意牺牲这些的**

---

### 用户抱怨吗？有的

**CPO确认：**
> "是的，有人抱怨CompanyCam照片质量差。但抱怨的人，通常不是'随手拍沟通'的用户，而是把照片当'证据/记录/细节依据'的那一批。而你，恰恰是在为后一类人做产品。"

---

### 常见抱怨集中在：

#### 1. 放大后细节不够
```
"Zoom in后看不清"
"管线/裂缝/标号细节糊掉"
"拍的时候明明很清楚，传上去就差了"
```
👉 分辨率限制 + JPEG重压缩的直接后果

---

#### 2. 阴影和暗部细节丢失

**尤其是：**
- 地下室
- 机房
- 墙体内部
- 夜间施工

重压缩会把暗部直接"抹平"，看起来像"噪点+糊"

---

#### 3. 和手机原图对比明显

```
"我手机里看着很好，但CompanyCam里明显差一档。"
```

**用户心理：**
> "我不是在发朋友圈，我是在存工地记录。"

---

## 🤔 为什么CompanyCam还能活得很好？

### 他们的产品立场

**CompanyCam押注的是：**

**大多数工地照片：**
- 不会被二次放大
- 不会被当法律证据
- 只是"证明当时做过/存在过"

**用户更在意：**
- 快
- 同步
- 团队协作

**👉 他们赢的是"协作效率"，不是"图像保真"**

---

### JSS的产品立场（本质差别）

**JSS Phase 1的宪法：**
- 不暗改事实
- 不静默失败
- 证据可信

**这一条，天然就和"激进压缩"冲突**

**2-3MB的原图传达的信号：**
> "这就是我手机拍到的事实，没有被系统偷偷改过。"

**对某一类用户来说，这是巨大价值**

---

## 💭 CEO的成熟判断

**CEO原话：**
> "我不觉得我们的慢，已经很不错了。"

**CPO评价：**
> "这句话背后意味着：你已经不在追'参数赢竞品'，你在追'用户信任感'。这非常成熟。"

**这是CPO级判断：**
- 不是追求"快"
- 而是追求"可信"

---

## 🚫 COO方案的问题：写入系统相册

### COO建议

**策略：**
> "App拍照时，原图（5MB）存在手机本地相册，压缩图（300KB）传到云端。"

---

### CEO的警觉

**CEO担心：**
> "我怕手机相册又乱了，占手机空间"

**这个担心100%正确！**

---

### 为什么COO方案"技术上合理，但产品上危险"

#### 1️⃣ 手机相册 = 用户的"私人空间"

**在用户心智里：**

**相册里是：**
- 家庭照片
- 私人视频
- 生活记忆

**不是：**
- 工地证据
- 上百张重复角度的施工照

---

**一旦把工地原图写进去：**
```
📱 相册瞬间被污染
📱 查家人照片要翻几十张工地照
📱 用户第一反应："这App很烦"
```

**这不是小抱怨，是卸载级别的不爽**

---

#### 2️⃣ 占空间 + 不可控清理 = 灾难组合

**现实场景：**
```
用户不会主动去删
系统不会帮你智能清

一天50张 × 几个项目 = 很快几GB
```

**一旦空间告急：**
```
iOS/Android会提示：
"是你这个App占空间"

不管是不是压缩图在云端，
骂名一定算在你头上
```

---

#### 3️⃣ COO方案混淆了两个概念

**COO想要的是：**
- "保留原始证据"

**但他用的是：**
- "写入系统相册"

**这两者完全不是一回事**

---

## ✅ CPO的最优解：App私有存储 + 适度压缩

### 核心判断轴线

**你们要决定的不是：**
- 要不要原图？

**而是：**
- 原图"存在谁的控制域里"？

---

### 三种存储位置对比

| 位置 | 是否可控 | 是否打扰用户 |
|------|---------|-------------|
| **系统相册** | ❌ 不可控 | ❌ 极其打扰 |
| **App私有存储** | ✅ 可控 | ✅ 不可见 |
| **云端** | ✅ 可控 | ✅ 不占手机 |

---

## 📐 Phase 1.5 最终方案（定版）

### 拍照流程（修正版）

```
📸 拍照
  ↓
原图（5MB）存App私有存储
  - IndexedDB / OPFS / App sandbox
  - 不写系统相册
  ↓
客户端生成压缩副本（300-600KB）
  ↓
只上传压缩图到云端
  ↓
原图：本地保留 + 可自动清理
```

---

### 原图清理策略

#### 默认策略（不问用户）

```
上传成功7天后自动删除原图
```

#### 高级策略（Phase 2）

```
Settings：
Keep originals for: 
  - 1 day
  - 7 days
  - Always
```

**这样：**
- ✅ 不乱相册
- ✅ 不无限占空间
- ✅ 仍然满足"原图曾经存在、可追溯"的证据逻辑

---

### 证据性会不会受损？

**不会。因为：**

**可以在metadata里记录：**
- 原图hash
- 拍照时间
- 设备信息

**压缩图 ≠ 造假**
- 它是派生版本（derivative）
- 这在法律/工程取证里是完全站得住脚的

---

## 🎨 为什么需要"适度压缩"？

### CEO追问：
> "所以你也建议适当做点压缩吗？"

### CPO回答：是的

**一句话定案：**
> 压缩"可以做"，但必须是：可逆的、可控的、不污染用户体验的

---

### 三个现实理由

#### 1️⃣ 网络抖动时的稳定性

**2-3MB在以下场景：**
- 地下室
- 电梯
- 偏远工地

**更容易触发：**
- 超时
- 重试
- 电量消耗

**压到300-600KB，稳定性提升是线性的**

---

#### 2️⃣ 成本 & 扩展性（为以后铺路）

**涉及：**
- 存储成本
- CDN成本
- 未来做分享/导出

**现在不贵，不代表以后不贵**  
适度压缩是"未来友好"的

---

#### 3️⃣ UI体验（尤其是预览）

**涉及：**
- 列表加载
- 缩略图
- 滚动流畅度

**预览图不需要12MP**

---

## 🔧 "适度压缩"技术参数

### 安全值区间（Phase 1.5）

#### 📐 分辨率

```javascript
最长边限制在 2048px

// iPhone原图 ~4032px
// 2048px已经能清楚看到绝大多数施工细节
```

---

#### 🧪 编码

```javascript
编码: JPEG
quality = 0.75 ± 0.05
```

---

#### 📊 结果体积

```
结果通常是：300-600KB

不是CompanyCam那种"狠压到糊"（<300KB）
```

---

### 为什么选这个参数？

**2048px的理由：**
- 足够看清管线、裂缝、标号
- 比4032px少75%的数据量
- 是"质量守恒"的临界点

**quality 0.75的理由：**
- 0.6太激进（细节明显丢失）
- 0.8-0.9体积优化不明显
- 0.75是工程界的经验最优解

---

## 🏗 正确的技术结构

### 拍照后完整流程

```
📸 拍照
  ↓
原图 → App私有存储（临时）
  - IndexedDB / OPFS
  - 完整EXIF metadata
  - 原图hash记录
  ↓
生成压缩副本
  - Max dimension: 2048px
  - JPEG quality: 0.75
  - 体积: 300-600KB
  ↓
只上传压缩副本
  - 到R2
  - 带metadata引用
  ↓
原图处理
  - 默认7天自动清理
  - 不进系统相册
  - 可配置保留策略（Phase 2）
```

---

### 这样你同时满足：

```
✅ 速度     - 上传快、重试少
✅ 质量     - 细节可用、不糊
✅ 证据完整性 - 原图曾存在、可追溯
✅ 用户体验  - 相册不乱、空间不炸
```

---

## 📄 团队共识文档（正式版）

### 一、背景

**Jobsite Snap（JSS）的核心使命是：**
- 快速、可靠地记录工地事实
- 保证证据可信
- 不打扰用户的私人手机空间

**在对比CompanyCam后，我们确认：**
- 极端压缩 ≠ 唯一正确解
- 保留证据价值与稳定体验同等重要

---

### 二、最终策略（Phase 1.5）

#### 1️⃣ 图像类型划分

| 类型 | 用途 | 存储位置 |
|------|------|---------|
| **原图（Original）** | 证据保全/可追溯 | App私有存储（临时） |
| **压缩图（Derivative）** | 云端存证/UI展示 | Cloud（R2） |

---

#### 2️⃣ 原图处理规则

**规格：**
- 原图大小：约2-5MB
- 不写入系统相册

**存储：**
- 仅存在于：IndexedDB / OPFS / App sandbox
- 默认7天自动清理
- 不提供UI操作入口（Phase 1）

---

#### 3️⃣ 压缩图参数（安全区间）

```javascript
{
  encoding: "JPEG",
  maxDimension: 2048,    // 最长边
  quality: 0.75,
  targetSize: "300-600KB"
}
```

**目标：**
> 在保证细节可用的前提下，提高上传稳定性与预览速度

---

#### 4️⃣ 上传与UI原则

**上传：**
- 只传压缩图

**UI：**
- 只使用压缩图
- 不在UI中强调"压缩/原图"

**用户只感知到：**
- 快
- 清楚
- 相册没被污染

---

#### 5️⃣ 不做事项（明确禁止）

```
❌ 不写系统相册
❌ 不激进压缩（<300KB）
❌ 不在Phase 1提供质量切换选项
❌ 不云端双份原图存储
```

---

### 三、为什么这是最优解

**对用户：**
- 不乱相册
- 不占空间

**对工程：**
- 更稳
- 更省
- 更易扩展

**对证据：**
- 原始事实未被系统"偷偷改写"

**对未来：**
- 可平滑升级
- 不返工

---

### 四、结论

**JSS的图像策略不是"追求最快"，**  
**而是在真实工地环境下，提供可信、稳定、可控的记录体验。**

---

## 🔧 给CTO的执行Checklist

### Phase 1.5 实施清单

#### A. 压缩逻辑实现

- [ ] 实现图像压缩函数
  ```typescript
  function compressImage(
    originalBlob: Blob
  ): Promise<Blob> {
    // Max dimension: 2048px
    // JPEG quality: 0.75
    // Target: 300-600KB
  }
  ```

- [ ] 在Web Worker中执行压缩（不阻塞主线程）
- [ ] 使用Canvas/OffscreenCanvas
- [ ] 保留EXIF metadata（至少拍摄时间）

---

#### B. 存储策略

- [ ] 原图存入App私有存储
  ```typescript
  // IndexedDB或OPFS
  const originalStore = {
    id: string,
    blob: Blob,
    metadata: {
      hash: string,
      takenAt: string,
      deviceInfo: string
    },
    expiresAt: Date  // 7天后
  }
  ```

- [ ] 压缩图作为上传版本
  ```typescript
  const uploadVersion = {
    id: string,
    blob: Blob,  // 压缩后
    originalHash: string,  // 关联原图
    compressionParams: {
      maxDim: 2048,
      quality: 0.75
    }
  }
  ```

---

#### C. 清理策略

- [ ] 实现TTL自动清理
  ```typescript
  // 每天检查一次过期原图
  function cleanupExpiredOriginals() {
    const now = new Date()
    const expired = originals.filter(
      o => o.expiresAt < now
    )
    expired.forEach(o => delete(o))
  }
  ```

- [ ] App启动时触发清理
- [ ] 后台定时清理（如果支持）

---

#### D. 上传流程调整

- [ ] 修改Upload Worker
  ```typescript
  // 之前：上传原图
  // 现在：上传压缩图
  
  async function uploadPhoto(item) {
    const original = await getOriginal(item.id)
    const compressed = await compressImage(original)
    
    // 上传压缩版本
    await uploadToR2(compressed)
    
    // 记录metadata
    await saveMetadata({
      originalHash: hash(original),
      compressedSize: compressed.size
    })
  }
  ```

---

#### E. UI调整

- [ ] 确认所有缩略图使用压缩版本
- [ ] 全屏预览使用压缩版本
- [ ] 不显示"原图/压缩图"切换（Phase 1）

---

### 验收标准

#### 功能验收

- [ ] 拍照后原图存入私有存储
- [ ] 压缩图正确生成（300-600KB范围）
- [ ] 只上传压缩图
- [ ] 7天后原图自动删除
- [ ] 系统相册无JSS照片

---

#### 质量验收

**使用真实工地照片验证：**
- [ ] 管线细节清晰可见
- [ ] 裂缝可辨识
- [ ] 暗部不过度抹平
- [ ] 放大2-3倍仍可用

**对比标准：**
- ✅ 优于CompanyCam（300KB激进压缩）
- ✅ 接近原图质量（在2倍放大以内）

---

#### 性能验收

- [ ] 压缩不阻塞拍照
- [ ] 压缩时间 < 500ms per photo
- [ ] 上传时间比原图快30%+
- [ ] 重试成功率提升

---

## 🎯 Phase路线图

### Phase 1.5（当前）

```
✅ App私有存储 + 适度压缩
✅ 自动清理（7天）
✅ 只上传压缩图
❌ 不写系统相册
```

---

### Phase 2（未来考虑）

```
可选功能（不承诺时间）：
□ 用户可配置原图保留时间
□ "上传质量"选项
  - Standard (Fast)
  - Original (Best for records)
□ 云端原图存储（额外收费）
```

---

## 📊 预期效果

### 上传速度

```
Before: 2-3MB
After:  300-600KB

预期提升：
- 上传时间：-40%~60%
- 重试次数：-50%
- 并发压力：-60%
```

---

### 存储成本

```
单照片云端存储：
Before: 2.5MB avg
After:  450KB avg

节省：~82%
```

---

### 用户体验

```
✅ 相册干净（0张工地照）
✅ 手机空间可控（7天清理）
✅ 预览加载快（<500KB）
✅ 细节仍可用（2048px）
```

---

## 💬 给CEO/COO的回复模板

### 给COO的共识版本

```
我们会保留原图的证据价值，但不写系统相册。

云端用高质量压缩图保证速度和稳定性，
原图只在App私有存储短期保留并自动清理。

这样既满足证据完整性，又不打扰用户体验。
```

---

### 给CEO的确认

```
你的判断是对的："我不觉得我们的慢，已经很不错了。"

我们会做适度压缩来提升稳定性，
但不走CompanyCam那种激进路线。

原图保留在可控位置，
用户感知到的是：快、清楚、相册不乱。
```

---

## ⚠️ 风险与应对

### 风险1：压缩参数选择不当

**症状：**
- 压得太狠 → 细节丢失
- 压得太轻 → 速度优势不明显

**应对：**
- A/B测试验证（见下一节）
- 先用真实工地照片验证
- 可微调quality（0.7-0.8之间）

---

### 风险2：原图清理太激进

**症状：**
- 用户7天后想找原图，发现没了

**应对：**
- Phase 1明确告知"7天保留"
- metadata记录原图hash（可追溯）
- Phase 2可调整为可配置

---

### 风险3：用户不理解"为什么不是原图"

**症状：**
- "我手机拍的很清楚，怎么App里小一点？"

**应对：**
- Phase 1不主动强调这个差异
- 如果问起，解释为"优化存储和速度"
- 强调"仍保留高清质量"

---

## 🧪 下一步：A/B验证方案

### 验证目标

**用真实工地照片验证：**
> 2048px / quality 0.75 会不会"伤证据"

---

### 验证方法

#### 1. 准备测试照片

**类型：**
- 管线细节照（小字、编号）
- 裂缝照（细微纹理）
- 暗部照（地下室、阴影区）
- 远景照（整体布局）

**每类至少3张**

---

#### 2. 对比测试

**生成版本：**
```
A. 原图（4032px, ~2.5MB）
B. JSS方案（2048px, q=0.75, ~450KB）
C. CompanyCam模拟（1600px, q=0.65, ~300KB）
```

**对比维度：**
- 肉眼观感
- 放大2倍细节
- 放大5倍细节（极限测试）
- 暗部细节

---

#### 3. 验收标准

**必须满足：**
- ✅ B版本在2倍放大时细节清晰
- ✅ B版本明显优于C版本
- ✅ B版本与A版本在正常查看时无明显差异
- ✅ 管线编号、裂缝纹理可辨识

**如果不满足：**
- 调整quality到0.8
- 或maxDimension到2400px

---

## 📝 一句话PR说明

```
Phase 1.5 implements smart compression:
- App-sandboxed originals (7-day retention)
- Optimized derivatives (2048px, 300-600KB)
- No system album pollution
- Evidence integrity via metadata & hash
```

---

## 💬 CPO最后的话

### 这个方案的战略意义

**你们现在做的是：**
- 不盲目追CompanyCam的"快"
- 也不死守"原图至上"的理想主义

**而是：**
- 尊重现场
- 尊重用户
- 尊重未来

**这是一条非常成熟的中间路线**

---

### 给CTO的核心提醒

**Phase 1.5的成功标准：**

```
不是：压缩率最高
不是：文件最小
不是：速度最快

而是：
✅ 证据细节不受损
✅ 用户空间不受扰
✅ 上传稳定性提升
✅ 未来可扩展不返工
```

---

### 一句话定心丸

**当用户抱怨"质量差"时，**  
**说明他已经把你的产品当成"重要工具"，而不是玩具。**

**CompanyCam接受了这类抱怨，**  
**因为那不是他们最想服务的人。**

**而你现在，很可能正好相反。**

---

**文档版本：** v1.0  
**创建人：** CPO  
**审核人：** CEO + COO  
**执行人：** CTO  
**生效日期：** 2026-02-07  
**执行阶段：** Phase 1.5  
**预计完成：** 1周

---

不激进、不理想主义、恰到好处 —— 这就是最优解！🎯

# é€€è´§ Receipt ä¿®å¤ - å·¥ç¨‹å¸ˆå®æ–½æŒ‡å—

> **ç›®æ ‡ï¼š** å®ç°é€€è´§ï¼ˆè´Ÿæ•° totalï¼‰çš„å®Œæ•´å¤„ç†é€»è¾‘  
> **ä¼˜å…ˆçº§ï¼š** P0ï¼ˆç´§æ€¥ï¼‰  
> **é¢„ä¼°å·¥ä½œé‡ï¼š** 6-9 å°æ—¶ï¼ˆPhase 1ï¼‰  
> **ä»»åŠ¡ç±»å‹ï¼š** åŠŸèƒ½å¼€å‘ + Bug ä¿®å¤

---

## ğŸ¯ å¿«é€Ÿæ‘˜è¦

### å½“å‰é—®é¢˜

ç³»ç»Ÿ**æœªå®ç°é€€è´§é€»è¾‘**ï¼Œå¯¼è‡´è´Ÿæ•° total çš„ receipt æ— æ³•å¤„ç†ã€‚

### è¦åšä»€ä¹ˆ

1. æ·»åŠ é€€è´§è‡ªåŠ¨æ£€æµ‹ï¼ˆtotal < 0ï¼‰
2. ä¿®å¤ Gemini 500 é”™è¯¯
3. æ˜¾ç¤ºé€€è´§æ ‡è®°å’Œæç¤º
4. ä¿®å¤ Edit åŠŸèƒ½
5. ä¿®å¤ UI ç¬¦å·

---

## ğŸ“‹ æ ¸å¿ƒäº§å“è§„åˆ™ï¼ˆæ¥è‡ª GPT CPOï¼‰

### é€€è´§è¯†åˆ«è§„åˆ™

```
å¦‚æœæ»¡è¶³ä»»ä¸€æ¡ä»¶ï¼š
- total < 0
- æˆ– receipt æ–‡æœ¬åŒ…å«ï¼šREFUND / RETURN / CREDIT / CR

â†’ æ ‡è®°ä¸ºï¼štransaction.type = "refund"
```

### çŠ¶æ€é€»è¾‘

```
é€€è´§ â†’ é»˜è®¤ needs_reviewï¼ˆä¸æ˜¯ blockedï¼‰

åŸå› ï¼šé€€è´§ä¸æ˜¯å¼‚å¸¸ï¼Œæ˜¯éœ€è¦ç¡®è®¤çš„åˆæ³•äº¤æ˜“
```

### æ•°å­¦æ ¡éªŒ

```
é€€è´§ä¹Ÿè¦é€šè¿‡æ•°å­¦æ ¡éªŒï¼š
subtotal + gst + pst === total  // total < 0
å…è®¸ 1 cent rounding
```

---

## ğŸ”§ CTO æŠ€æœ¯è¯Šæ–­ï¼ˆæ¥è‡ª Claude Codeï¼‰

| é—®é¢˜              | ä¸¥é‡ç¨‹åº¦      | æ ¹æœ¬åŸå›                              | ä¿®å¤æ–¹æ¡ˆ                    |
| --------------- | --------- | -------------------------------- | ----------------------- |
| Negative totals | ğŸŸ¡ Medium | AI pipeline æ²¡æœ‰é€€è´§æ„è¯†               | åœ¨ Gemini prompt ä¸­æ·»åŠ é€€è´§æ£€æµ‹ |
| Gemini 500      | ğŸ”´ High   | Invalid JSON parsing             | åŠ å¼º prompt + æ”¹è¿›è§£æå™¨ + é‡è¯•  |
| Edit button     | ğŸŸ¡ Medium | æ²¡æœ‰ onClick handler (placeholder) | æ¥é€šåŠŸèƒ½æˆ–ç§»é™¤                 |
| UI symbols      | ğŸŸ¢ Low    | Unicode emoji æ—  fallback         | æ›¿æ¢ä¸º SVG icons           |
| Garbled Chinese | ğŸŸ¢ Low    | è¿è¡Œæ—¶ç”Ÿæˆï¼Œå­—ä½“æ··ä¹±                       | ç»Ÿä¸€ä¸­æ–‡å˜ä½“                  |

---

## ğŸ“‹ Phase 1: ç´§æ€¥ä¿®å¤ï¼ˆä»Šå¤©å®Œæˆï¼‰â±ï¸ 6-9 å°æ—¶

### Task 1.1: æ·»åŠ é€€è´§æ£€æµ‹é€»è¾‘ï¼ˆ4-6 å°æ—¶ï¼‰

#### 1.1.1 åç«¯ï¼šæ›´æ–° Gemini Prompt

**æ–‡ä»¶ï¼š** `apps/api/src/routes/analyze/route.ts`

**åœ¨ Gemini prompt ä¸­æ·»åŠ ï¼š**

```typescript
const prompt = `
...existing prompt...

IMPORTANT: Refund/Return Detection
- If the total amount is negative (< 0), this is a REFUND or RETURN transaction
- Also check for keywords: REFUND, RETURN, CREDIT, CR in the receipt text
- When detected, set "transaction_type": "refund"
- Note: Negative totals are VALID and expected for refunds
- The taxes (GST/PST) will also be negative in refunds
- The math still applies: subtotal + gst + pst = total (where total < 0)

Example refund response:
{
  "vendor_name": "The Home Depot",
  "total": -144.38,
  "subtotal": -131.44,
  "gst": -6.57,
  "pst": -6.37,
  "transaction_type": "refund",
  "confidence": 0.9
}
`;
```

---

#### 1.1.2 æ•°æ®åº“ï¼šæ·»åŠ  transaction_type å­—æ®µ

**åˆ›å»º migrationï¼š** `migrations/YYYY-MM-DD_add_transaction_type.sql`

```sql
-- æ·»åŠ  transaction_type å­—æ®µ
ALTER TABLE transactions 
ADD COLUMN transaction_type VARCHAR(20) DEFAULT 'purchase';

-- å¯èƒ½çš„å€¼ï¼š'purchase', 'refund', 'adjustment'

-- æ·»åŠ ç´¢å¼•ï¼ˆå¦‚æœéœ€è¦æŒ‰ç±»å‹æŸ¥è¯¢ï¼‰
CREATE INDEX idx_transactions_type ON transactions(transaction_type);

-- æ›´æ–°ç°æœ‰çš„è´Ÿæ•° total è®°å½•ä¸º refund
UPDATE transactions 
SET transaction_type = 'refund' 
WHERE total < 0;

-- æ·»åŠ æ³¨é‡Š
COMMENT ON COLUMN transactions.transaction_type IS 'Transaction type: purchase (default), refund, or adjustment';
```

---

#### 1.1.3 åç«¯ï¼šæ›´æ–°çŠ¶æ€åˆ¤å®šé€»è¾‘

**æ–‡ä»¶ï¼š** `apps/api/src/routes/analyze/route.ts`

**ä¿®æ”¹çŠ¶æ€åˆ¤å®šå‡½æ•°ï¼š**

```typescript
function determineTransactionStatus(data: ParsedReceiptData): TransactionStatus {
  // 1. å¦‚æœæ˜¯é€€è´§ï¼Œé»˜è®¤ needs_review
  if (data.total < 0 || data.transaction_type === 'refund') {
    return 'needs_review';
  }

  // 2. æ£€æŸ¥å¿…éœ€å­—æ®µ
  const hasRequiredFields = 
    data.vendor_name && 
    data.transaction_date && 
    data.total && 
    data.total > 0;

  if (!hasRequiredFields) {
    return 'needs_review';
  }

  // 3. æ•°å­¦æ ¡éªŒï¼ˆå…è®¸è´Ÿæ•°ï¼‰
  const subtotal = data.subtotal || 0;
  const gst = data.gst || 0;
  const pst = data.pst || 0;
  const total = data.total;

  const calculatedTotal = subtotal + gst + pst;
  const diff = Math.abs(calculatedTotal - total);

  // å…è®¸ 1 cent rounding
  if (diff > 0.01) {
    return 'needs_review';
  }

  // 4. æ‰€æœ‰æ£€æŸ¥é€šè¿‡
  return 'auto_ready';
}
```

---

#### 1.1.4 åç«¯ï¼šæ›´æ–°ç±»å‹å®šä¹‰

**æ–‡ä»¶ï¼š** `packages/shared-types/src/transaction.ts`ï¼ˆæˆ–ç±»ä¼¼ï¼‰

```typescript
export type TransactionType = 'purchase' | 'refund' | 'adjustment';

export interface Transaction {
  id: string;
  // ... å…¶ä»–å­—æ®µ
  transaction_type: TransactionType;
  total: number;  // å¯ä»¥æ˜¯è´Ÿæ•°
  // ...
}
```

---

### Task 1.2: ä¿®å¤ Gemini 500 é”™è¯¯ï¼ˆ2-3 å°æ—¶ï¼‰

#### 1.2.1 åŠ å¼º Promptï¼ˆç¦æ­¢ Markdownï¼‰

**åœ¨ prompt ä¸­æ·»åŠ ï¼š**

```typescript
const prompt = `
...existing content...

CRITICAL OUTPUT FORMAT:
- You MUST respond ONLY with valid JSON
- NO markdown code fences (\`\`\`json or \`\`\`)
- NO explanations before or after the JSON
- Start directly with { and end with }
- If uncertain, return JSON with lower confidence rather than refusing
`;
```

---

#### 1.2.2 æ”¹è¿› JSON è§£æå™¨

**æ–‡ä»¶ï¼š** `apps/api/src/lib/parseGeminiJson.ts`ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒï¼‰

```typescript
export function parseGeminiJson(text: string): any {
  // 1. å»é™¤ markdown fences
  let cleaned = text
    .replace(/```json/g, '')
    .replace(/```/g, '')
    .trim();

  // 2. ç¬¬ä¸€æ¬¡å°è¯•
  try {
    return JSON.parse(cleaned);
  } catch (e1) {
    console.warn('First parse attempt failed, trying to fix...');

    // 3. å°è¯•æå– JSON å¯¹è±¡ï¼ˆå¦‚æœæœ‰å…¶ä»–æ–‡æœ¬ï¼‰
    const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      try {
        return JSON.parse(jsonMatch[0]);
      } catch (e2) {
        // ç»§ç»­ä¸‹ä¸€æ­¥
      }
    }

    // 4. è®°å½•åŸå§‹å“åº”ï¼Œæ–¹ä¾¿è°ƒè¯•
    console.error('Failed to parse Gemini response:', {
      original: text,
      cleaned: cleaned,
      error: e1.message
    });

    // 5. æŠ›å‡ºé”™è¯¯
    throw new Error(`Gemini returned invalid JSON: ${e1.message}`);
  }
}
```

---

#### 1.2.3 æ·»åŠ é‡è¯•é€»è¾‘

**æ–‡ä»¶ï¼š** `apps/api/src/workers/analyze-worker.ts`

```typescript
async function analyzeWithRetry(transactionId: string, maxRetries = 3) {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      console.log(`Analyzing transaction ${transactionId}, attempt ${attempt + 1}/${maxRetries}`);

      const result = await analyzeTransaction(transactionId);

      console.log(`Analysis successful for ${transactionId}`);
      return result;

    } catch (error) {
      console.error(`Analysis attempt ${attempt + 1} failed:`, error);

      // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥
      if (attempt === maxRetries - 1) {
        console.error(`All ${maxRetries} attempts failed for ${transactionId}`);

        // æ ‡è®°ä¸º blocked
        await updateTransactionStatus(transactionId, 'blocked', {
          error: 'Analysis failed after multiple retries',
          lastError: error.message
        });

        throw error;
      }

      // é€’å¢å»¶è¿Ÿé‡è¯•ï¼ˆbackoffï¼‰
      const delay = 5000 * (attempt + 1); // 5s, 10s, 15s
      console.log(`Retrying in ${delay}ms...`);
      await sleep(delay);
    }
  }
}

function sleep(ms: number): Promise<void> {
  return new Promise(resolve => setTimeout(resolve, ms));
}
```

---

### Task 1.3: å‰ç«¯æ˜¾ç¤ºé€€è´§æ ‡è®°ï¼ˆ1 å°æ—¶ï¼‰

#### 1.3.1 åˆ—è¡¨é¡µï¼šæ·»åŠ é€€è´§æ ‡è®°

**æ–‡ä»¶ï¼š** `apps/web-app/src/components/transactions/TransactionsList.tsx`

```tsx
// åœ¨äº¤æ˜“åˆ—è¡¨é¡¹ä¸­æ·»åŠ 
{transaction.transaction_type === 'refund' && (
  <span className="inline-flex items-center gap-1 px-2 py-1 rounded text-sm font-medium bg-yellow-50 text-yellow-700 border border-yellow-200">
    <ExclamationTriangleIcon className="w-4 h-4" />
    é€€è´§
  </span>
)}
```

---

#### 1.3.2 è¯¦æƒ…é¡µï¼šæ·»åŠ é€€è´§æç¤º

**æ–‡ä»¶ï¼š** `apps/web-app/src/components/transactions/TransactionDetailSlideOver.tsx`

```tsx
// åœ¨é¡µé¢é¡¶éƒ¨ï¼ˆæ ‡é¢˜ä¸‹æ–¹ï¼‰æ·»åŠ 
{transaction.transaction_type === 'refund' && (
  <div className="mb-4 p-4 rounded-lg bg-yellow-50 border-2 border-yellow-200">
    <div className="flex items-start gap-3">
      <ExclamationTriangleIcon className="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" />
      <div>
        <h3 className="font-semibold text-yellow-900 mb-1">
          é€€è´§ï¼ˆéœ€è¦ç¡®è®¤ï¼‰
        </h3>
        <p className="text-sm text-yellow-700">
          æ­¤æ”¶æ®ä¸ºé€€è´§ / é€€æ¬¾ï¼Œè¯·ç¡®è®¤é‡‘é¢ä¸ç¨è´¹ã€‚
        </p>
      </div>
    </div>
  </div>
)}
```

---

#### 1.3.3 ç¡®è®¤æŒ‰é’®ï¼šä¿®æ”¹æ–‡æ¡ˆ

**æ–‡ä»¶ï¼š** `apps/web-app/src/components/transactions/ConfirmDataButton.tsx`

```tsx
// æ ¹æ®äº¤æ˜“ç±»å‹ä¿®æ”¹æŒ‰é’®æ–‡æ¡ˆ
const buttonText = transaction.transaction_type === 'refund' 
  ? 'ç¡®è®¤é€€è´§' 
  : 'ç¡®è®¤æ— è¯¯';

<button onClick={handleConfirm}>
  âœ“ {buttonText}
</button>
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### æµ‹è¯• 1: æ­£å¸¸é€€è´§

**æ“ä½œï¼š**

1. ä¸Šä¼ é€€è´§ receiptï¼ˆtotal < 0ï¼‰
2. ç­‰å¾… AI åˆ†æ

**é¢„æœŸç»“æœï¼š**

- âœ… `transaction.transaction_type = 'refund'`
- âœ… `transaction.status = 'needs_review'`
- âœ… åˆ—è¡¨é¡µæ˜¾ç¤º"ğŸŸ¡ é€€è´§"
- âœ… è¯¦æƒ…é¡µæ˜¾ç¤ºé€€è´§æç¤ºå¡ç‰‡
- âœ… ç¡®è®¤æŒ‰é’®æ–‡æ¡ˆä¸º"ç¡®è®¤é€€è´§"
- âœ… å¯ä»¥æˆåŠŸç¡®è®¤

---

### æµ‹è¯• 2: æ­£å¸¸è´­ä¹°

**æ“ä½œï¼š**

1. ä¸Šä¼ æ­£å¸¸ receiptï¼ˆtotal > 0ï¼‰

**é¢„æœŸç»“æœï¼š**

- âœ… `transaction.transaction_type = 'purchase'`
- âœ… `transaction.status = 'auto_ready'` æˆ– `'needs_review'`ï¼ˆæ ¹æ®è§„åˆ™ï¼‰
- âœ… ä¸æ˜¾ç¤ºé€€è´§æ ‡è®°
- âœ… æ­£å¸¸æµç¨‹ä¸å—å½±å“

---

### æµ‹è¯• 3: Gemini é‡è¯•

**æ¨¡æ‹Ÿï¼š**

- Gemini ç¬¬ä¸€æ¬¡è¿”å›æ— æ•ˆ JSON
- ç¬¬äºŒæ¬¡æˆåŠŸ

**é¢„æœŸç»“æœï¼š**

- âœ… è‡ªåŠ¨é‡è¯•
- âœ… æœ€ç»ˆæˆåŠŸè§£æ
- âœ… Console æ˜¾ç¤ºé‡è¯•æ—¥å¿—

---

### æµ‹è¯• 4: Math éªŒè¯ï¼ˆé€€è´§ï¼‰

**è¾“å…¥ï¼š**

```
subtotal: -131.44
gst: -6.57
pst: -6.37
total: -144.38
```

**é¢„æœŸç»“æœï¼š**

- âœ… æ•°å­¦æ ¡éªŒé€šè¿‡ï¼ˆ-131.44 + -6.57 + -6.37 = -144.38ï¼‰
- âœ… çŠ¶æ€ä¸º `needs_review`ï¼ˆå› ä¸ºæ˜¯é€€è´§ï¼‰

---

## ğŸ“‚ æ¶‰åŠçš„æ–‡ä»¶

### åç«¯

```
apps/api/src/routes/analyze/route.ts                 # ä¸»è¦ä¿®æ”¹
apps/api/src/workers/analyze-worker.ts               # æ·»åŠ é‡è¯•é€»è¾‘
apps/api/src/lib/parseGeminiJson.ts                  # æ–°å»º
packages/shared-types/src/transaction.ts             # ç±»å‹å®šä¹‰
migrations/YYYY-MM-DD_add_transaction_type.sql       # æ–°å»º
```

### å‰ç«¯

```
apps/web-app/src/components/transactions/TransactionsList.tsx
apps/web-app/src/components/transactions/TransactionDetailSlideOver.tsx
apps/web-app/src/components/transactions/ConfirmDataButton.tsx
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ•°æ®åº“ migration å¤±è´¥

**è§£å†³ï¼š**

```sql
-- å¦‚æœå·²ç»æœ‰ transaction_type å­—æ®µ
ALTER TABLE transactions DROP COLUMN IF EXISTS transaction_type;
-- ç„¶åé‡æ–°è¿è¡Œ migration
```

---

### Q2: Gemini ä»ç„¶è¿”å› 500

**æ’æŸ¥ï¼š**

1. æ£€æŸ¥ Gemini API key æ˜¯å¦æœ‰æ•ˆ
2. æ£€æŸ¥ prompt æ˜¯å¦å¤ªé•¿ï¼ˆè¶…è¿‡ token é™åˆ¶ï¼‰
3. æŸ¥çœ‹ Console ä¸­çš„ Gemini åŸå§‹å“åº”
4. å°è¯•å‡å°‘ prompt ä¸­çš„ç¤ºä¾‹

---

### Q3: å‰ç«¯ä¸æ˜¾ç¤ºé€€è´§æ ‡è®°

**æ’æŸ¥ï¼š**

1. æ£€æŸ¥ `transaction.transaction_type` æ˜¯å¦æ­£ç¡®ä» API è¿”å›
2. æ£€æŸ¥å‰ç«¯ç±»å‹å®šä¹‰æ˜¯å¦åŒ…å« `transaction_type`
3. åˆ·æ–°é¡µé¢ï¼Œæ¸…é™¤ç¼“å­˜

---

## ğŸ’¡ å®æ–½å»ºè®®

### åˆ†æ­¥æµ‹è¯•ï¼ˆæ¨èï¼‰

**Step 1: åªåšåç«¯**

1. æ·»åŠ  database migration
2. æ›´æ–° Gemini prompt
3. æ›´æ–°çŠ¶æ€åˆ¤å®š
4. æµ‹è¯• API å“åº”

**Step 2: æ·»åŠ å‰ç«¯æ˜¾ç¤º**

1. åˆ—è¡¨é¡µæ˜¾ç¤ºæ ‡è®°
2. è¯¦æƒ…é¡µæ˜¾ç¤ºæç¤º
3. æµ‹è¯• UI

**Step 3: ä¼˜åŒ–**

1. ä¿®å¤ Gemini 500
2. æ·»åŠ é‡è¯•é€»è¾‘
3. æµ‹è¯•ç¨³å®šæ€§

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### é‡è¦æé†’

1. **ä¸è¦ç ´åç°æœ‰åŠŸèƒ½**
   
   - é€€è´§é€»è¾‘æ˜¯æ–°å¢çš„
   - ç¡®ä¿æ­£å¸¸è´­ä¹°ä¸å—å½±å“

2. **æ•°æ®åº“ migration**
   
   - åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œå‰å…ˆå¤‡ä»½
   - æµ‹è¯• rollback è„šæœ¬

3. **Gemini API**
   
   - æ³¨æ„ API è´¹ç”¨
   - é‡è¯•ä¼šå¢åŠ  API è°ƒç”¨æ¬¡æ•°

4. **æ•°å­¦æ ¡éªŒ**
   
   - å…è®¸ 1 cent rounding
   - è´Ÿæ•°ä¹Ÿè¦é€šè¿‡æ ¡éªŒ

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

**äº§å“é—®é¢˜ï¼š** GPT (CPO)  
**æŠ€æœ¯é—®é¢˜ï¼š** CTO (Claude Code)  
**æ–‡æ¡£é—®é¢˜ï¼š** CDO (Claude Web AI)

---

## âœ… å®Œæˆå

**æäº¤å‰ï¼š**

- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å·² review
- [ ] Database migration å·²æµ‹è¯•

**æäº¤åï¼š**

- [ ] é€šçŸ¥å›¢é˜Ÿ
- [ ] æ›´æ–°æ–‡æ¡£
- [ ] è®© CDO å½’æ¡£è®°å½•

**é€šçŸ¥æ¶ˆæ¯æ¨¡æ¿ï¼š**

```
âœ… é€€è´§ Receipt åŠŸèƒ½å·²å®Œæˆ

æ”¹è¿›ï¼š
- è‡ªåŠ¨è¯†åˆ«é€€è´§ï¼ˆè´Ÿæ•° totalï¼‰
- Gemini 500 é”™è¯¯å·²ä¿®å¤ï¼ˆåŠ å¼º prompt + é‡è¯•ï¼‰
- å‰ç«¯æ˜¾ç¤ºé€€è´§æ ‡è®°å’Œæç¤º
- æ•°å­¦æ ¡éªŒæ”¯æŒè´Ÿæ•°

æµ‹è¯•ï¼š
- æµ‹è¯•äº†é€€è´§å’Œæ­£å¸¸è´­ä¹°
- API ç¨³å®šæ€§å·²éªŒè¯
- UI æ˜¾ç¤ºæ­£å¸¸

å¾… CEO / CPO éªŒæ”¶
```

---

**ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¶é—´ï¼š** 2026-02-01  
**è´Ÿè´£äººï¼š** CDO (Claude Web AI)  
**ä»»åŠ¡çŠ¶æ€ï¼š** å¾…å®æ–½

---

**é¢„è®¡å®Œæˆæ—¶é—´ï¼š** ä»Šå¤©ï¼ˆPhase 1ï¼‰

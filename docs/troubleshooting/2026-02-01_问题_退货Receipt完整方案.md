# é€€è´§ Receipt å®Œæ•´é—®é¢˜æŠ¥å‘Šä¸ä¿®å¤æ–¹æ¡ˆ

> **é—®é¢˜ç±»å‹ï¼š** äº§å“åŠŸèƒ½ç¼ºå¤± + æŠ€æœ¯ Bug  
> **å‘ç°æ—¶é—´ï¼š** 2026-02-01  
> **ä¸¥é‡ç¨‹åº¦ï¼š** ğŸ”´ é«˜ï¼ˆå½±å“é€€è´§å¤„ç†ï¼‰  
> **çŠ¶æ€ï¼š** å¾…ä¿®å¤

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### æ ¸å¿ƒé—®é¢˜

ç³»ç»Ÿ**æœªå®ç°é€€è´§é€»è¾‘**ï¼Œå¯¼è‡´è´Ÿæ•° total çš„ receipt æ— æ³•æ­£ç¡®å¤„ç†ã€‚

### å½±å“èŒƒå›´

- âŒ é€€è´§ receipt æ— æ³•è‡ªåŠ¨è¯†åˆ«
- âŒ Edit åŠŸèƒ½ä¸å·¥ä½œï¼ˆæŒ‰é’®æ˜¯å ä½ç¬¦ï¼‰
- âŒ Gemini API è¿”å› 500 é”™è¯¯
- âŒ UI æ˜¾ç¤ºå¼‚å¸¸ç¬¦å·
- âŒ ä¸­æ–‡æç¤ºä¹±ç 

### ä¿®å¤ä¼˜å…ˆçº§

| é—®é¢˜            | ä¼˜å…ˆçº§   | é¢„ä¼°å·¥ä½œé‡  |
| ------------- | ----- | ------ |
| é€€è´§æ£€æµ‹é€»è¾‘        | ğŸ”´ P0 | 4-6 å°æ—¶ |
| Gemini 500 é”™è¯¯ | ğŸ”´ P0 | 2-3 å°æ—¶ |
| Edit åŠŸèƒ½       | ğŸŸ¡ P1 | 2-4 å°æ—¶ |
| UI ç¬¦å·         | ğŸŸ¢ P2 | 1 å°æ—¶   |
| ä¸­æ–‡ä¹±ç           | ğŸŸ¢ P2 | 30 åˆ†é’Ÿ  |

---

## ğŸ¨ GPT (CPO) äº§å“å†³ç­–

### æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»è®°ä½ï¼‰

> **"é€€è´§ä¸æ˜¯å¼‚å¸¸ï¼Œæ˜¯ä¸€ç§'åˆæ³•ä½†ä¸åŒè¯­ä¹‰'çš„äº¤æ˜“"**

---

### 1ï¸âƒ£ é€€è´§è¯†åˆ«è§„åˆ™

**è‡ªåŠ¨è¯†åˆ«æ¡ä»¶ï¼ˆæ»¡è¶³ä»»ä¸€ï¼‰ï¼š**

```
1. total < 0
2. æˆ– receipt æ–‡æœ¬åŒ…å«ï¼šREFUND / RETURN / CREDIT / CR
```

**æ•°æ®æ¨¡å‹ï¼š**

```typescript
transaction.type = "refund"  // æ–°å¢å­—æ®µ
```

**é‡è¦ï¼š**

- è¿™æ˜¯**äº¤æ˜“ç±»å‹ï¼ˆtypeï¼‰**ï¼Œä¸æ˜¯çŠ¶æ€ï¼ˆstatusï¼‰
- type å’Œ status æ˜¯ä¸¤ä¸ªç‹¬ç«‹ç»´åº¦

---

### 2ï¸âƒ£ é€€è´§çš„çŠ¶æ€é€»è¾‘

**é»˜è®¤çŠ¶æ€ï¼š`needs_review`**

| åœºæ™¯                | çŠ¶æ€             | ç†ç”±     |
| ----------------- | -------------- | ------ |
| è´Ÿæ•° total + ç»“æ„å®Œæ•´   | `needs_review` | ä¼šè®¡éœ€è¦ç¡®è®¤ |
| è´Ÿæ•° total + å…³é”®å­—æ®µç¼ºå¤± | `needs_review` | éœ€è¦è¡¥å……ä¿¡æ¯ |
| OCR å®Œå…¨å¤±è´¥          | `blocked`      | æå°‘æƒ…å†µ   |

**âŒ ç»ä¸æ¨èï¼š**

- æŠŠé€€è´§ä¸€åˆ€åˆ‡æˆ `blocked`

**ä¼šè®¡è§†è§’ï¼š**

> "é€€è´§æˆ‘å½“ç„¶è¦è®°è´¦ï¼Œä½†æˆ‘å¾—ç¡®è®¤å®ƒæ˜¯ä»€ä¹ˆé€€çš„ã€‚"

---

### 3ï¸âƒ£ é€€è´§çš„ä¼šè®¡è§„åˆ™

#### 3.1 ç‰¹æ®Šæ ‡è®°

**å¿…å¤‡å­—æ®µï¼š**

```typescript
transaction.type = "refund"
```

**UI æ˜¾ç¤ºï¼š**

```
ğŸŸ¡ é€€è´§ Â· éœ€ç¡®è®¤
```

#### 3.2 ç¨è´¹å¤„ç†

**æ­£ç¡®è§„åˆ™ï¼ˆåŠ æ‹¿å¤§/åŒ—ç¾ï¼‰ï¼š**

- é€€è´§é€šå¸¸ä¼šé€€ç¨
- GST/PST ä¸ºè´Ÿæ•°
- æ•°å­¦æ ¡éªŒä»ç„¶æˆç«‹ï¼š
  
  ```
  subtotal + gst + pst === total  // total < 0
  å…è®¸ 1 cent rounding
  ```

**âŒ ä¸è¦ï¼š**

- å› ä¸ºç¨æ˜¯è´Ÿçš„å°± blocked
- å› ä¸º total < 0 å°±å½“å¼‚å¸¸

#### 3.3 å…³è”åŸå§‹è´­ä¹°å•

**v1.0ï¼ˆç°åœ¨ï¼‰ï¼š**

- æä¾›å¯é€‰å­—æ®µï¼š`refund_of_transaction_id?: uuid`
- UIï¼šã€Œå…³è”åŸå§‹æ”¶æ®ï¼ˆå¯é€‰ï¼‰ã€
- **ä¸å¼ºåˆ¶**

**v2.0ï¼ˆæœªæ¥ï¼‰ï¼š**

- è‡ªåŠ¨å»ºè®®å…³è”ï¼ˆåŒ vendorã€è¿‘æ—¥æœŸã€é‡‘é¢æ¥è¿‘ï¼‰

**åŸå› ï¼š**

> å¾ˆå¤šé€€è´§æ˜¯æ‰¹é‡ / æ— åŸç¥¨ï¼Œå¼ºåˆ¶å…³è” = ç”¨æˆ·å¡æ­»

---

### 4ï¸âƒ£ Edit åŠŸèƒ½è§„åˆ™

#### ä»€ä¹ˆæ—¶å€™å…è®¸ç¼–è¾‘ï¼Ÿ

**âŒ ä¸å…è®¸ç¼–è¾‘ï¼ˆæ¥è‡ª receipt çš„äº‹å®ï¼‰ï¼š**

- total
- subtotal
- tax æ•°å­—
- dateï¼ˆé™¤é OCR æ˜æ˜¾é”™ï¼‰

**âœ… å…è®¸ç¼–è¾‘ï¼ˆä¼šè®¡å†³ç­–ï¼‰ï¼š**

- category
- project
- vendorï¼ˆåˆ«åï¼‰
- refund_of_transaction_id
- notes

#### é€€è´§ receipt èƒ½ç¼–è¾‘å—ï¼Ÿ

**âœ… å¯ä»¥ï¼Œè€Œä¸”æ›´åº”è¯¥å…è®¸**

**å…è®¸çš„ç¼–è¾‘ï¼š**

- å…³è”åŸå§‹è´­ä¹°å•
- åˆ†ç±»ï¼ˆExpense / Adjustment / Contraï¼‰
- å¤‡æ³¨ï¼ˆä¸ºä»€ä¹ˆé€€ï¼‰

**âŒ ä»ç„¶ç¦æ­¢ï¼š**

- æŠŠè´Ÿæ•°æ”¹æˆæ­£æ•°
- æ”¹ total é‡‘é¢

---

### 5ï¸âƒ£ UI æ–‡æ¡ˆæ¨è

#### åˆ—è¡¨é¡µ

```
ğŸŸ¡ é€€è´§ Â· éœ€ç¡®è®¤
```

#### è¯¦æƒ…é¡µé¡¶éƒ¨

```
ğŸŸ¡ é€€è´§ï¼ˆéœ€è¦ç¡®è®¤ï¼‰
æ­¤æ”¶æ®ä¸ºé€€è´§ / é€€æ¬¾ï¼Œè¯·ç¡®è®¤é‡‘é¢ä¸ç¨è´¹ã€‚
```

#### ç¡®è®¤æŒ‰é’®

```
[ âœ“ ç¡®è®¤é€€è´§ ]
```

---

### ğŸ“Š äº§å“å†³ç­–æ±‡æ€»è¡¨

| é¡¹ç›®         | å†³ç­–                            |
| ---------- | ----------------------------- |
| è‡ªåŠ¨è¯†åˆ«é€€è´§     | âœ…ï¼ˆtotal < 0ï¼‰                  |
| äº¤æ˜“ç±»å‹       | `transaction.type = "refund"` |
| é»˜è®¤çŠ¶æ€       | `needs_review`                |
| æ˜¯å¦ blocked | âŒï¼ˆé™¤é OCR å¤±è´¥ï¼‰                  |
| ç¨å¤„ç†        | å…è®¸è´Ÿç¨ï¼Œå‚ä¸æ•°å­¦æ ¡éªŒ                   |
| æ˜¯å¦å…³è”åŸå•     | å¯é€‰ï¼Œä¸å¼ºåˆ¶                        |
| æ˜¯å¦å¯ç¼–è¾‘      | å¯ï¼ˆä¸šåŠ¡å­—æ®µï¼‰                       |
| æ˜¯å¦å¿…é¡»äººå·¥ç¡®è®¤   | âœ…                             |

---

## ğŸ”§ CTO (Claude Code) æŠ€æœ¯è¯Šæ–­

### è¯Šæ–­æ±‡æ€»è¡¨

| é—®é¢˜                | æ ¹æœ¬åŸå›                | ä¸¥é‡ç¨‹åº¦      | ä¿®å¤æ–¹æ¡ˆ                    |
| ----------------- | ------------------ | --------- | ----------------------- |
| **è´Ÿæ•° Total**      | AI pipeline æ²¡æœ‰é€€è´§æ£€æµ‹ | ğŸŸ¡ Medium | åœ¨ Gemini prompt ä¸­æ·»åŠ é€€è´§æ£€æµ‹ |
| **UI ç¬¦å·å¼‚å¸¸**       | Emoji å­—ä½“ä¸æ”¯æŒ        | ğŸŸ¢ Low    | æ”¹ç”¨ SVG å›¾æ ‡               |
| **Edit æŒ‰é’®ä¸å·¥ä½œ**    | æŒ‰é’®æ˜¯å ä½ç¬¦ï¼Œæ—  onClick   | ğŸŸ¡ Medium | æ¥é€šåŠŸèƒ½æˆ–ç§»é™¤æŒ‰é’®               |
| **Gemini 500 é”™è¯¯** | JSON è§£æå¤±è´¥          | ğŸ”´ High   | åŠ å¼º prompt + é‡è¯•é€»è¾‘        |
| **ä¸­æ–‡ä¹±ç **          | è¿è¡Œæ—¶ç”Ÿæˆï¼Œéæºä»£ç é—®é¢˜       | ğŸŸ¢ Low    | ç»Ÿä¸€ä¸­æ–‡å˜ä½“                  |

---

### é—®é¢˜ 1: è´Ÿæ•° Total æœªè¯†åˆ« ğŸŸ¡ Medium

**æ ¹æœ¬åŸå› ï¼š**

- AI pipeline æ²¡æœ‰é€€è´§æ„è¯†ï¼ˆrefund awarenessï¼‰

**å½±å“ï¼š**

- é€€è´§ receipt å¯èƒ½è¿›å…¥ undefined çŠ¶æ€
- Gemini ä¸çŸ¥é“å¦‚ä½•å¤„ç†è´Ÿæ•°

**ä¿®å¤æ–¹æ¡ˆï¼š**

```
åœ¨ Gemini prompt ä¸­æ·»åŠ ï¼š

"If the total is negative, this is a REFUND/RETURN.
Set transaction_type: 'refund' and explain briefly."
```

**ä»£ç ä½ç½®ï¼š**

- `apps/api/src/routes/analyze/route.ts`
- Gemini prompt æ„å»ºéƒ¨åˆ†

---

### é—®é¢˜ 2: Gemini 500 é”™è¯¯ ğŸ”´ High

**é”™è¯¯ä¿¡æ¯ï¼š**

```
[worker] analyze failed: 500 Gemini returned invalid JSON
```

**æ ¹æœ¬åŸå› ï¼ˆå¯èƒ½æœ‰ 3 ä¸ªï¼‰ï¼š**

1. **Gemini è¿”å› markdown-wrapped JSON**
   
   ```json
   ```json
   { "field": "value" }
   ```
   
   ```
   â†’ è§£æå™¨æ— æ³•å¤„ç† markdown fence
   ```

2. **Gemini è¿”å›äº†ä¸å¸¸è§çš„ JSONï¼ˆå¯¹é€€è´§å¾ˆå›°æƒ‘ï¼‰**

3. **Gemini æ‹’ç»æˆ– safety-filtered å“åº”**

**ä¿®å¤æ–¹æ¡ˆï¼š**

#### æ–¹æ¡ˆ 1: åŠ å¼º prompt

```
"Always respond ONLY with valid JSON. 
No markdown fences, no explanations."
```

#### æ–¹æ¡ˆ 2: åŠ å¼ºè§£æå™¨

```typescript
// parseGeminiJson() æ”¹è¿›
function parseGeminiJson(text: string) {
  // 1. Strip markdown fences
  let cleaned = text.replace(/```json|```/g, '').trim();

  // 2. Try parse
  try {
    return JSON.parse(cleaned);
  } catch (e) {
    // 3. è®°å½•åŸå§‹å“åº”ï¼Œæ–¹ä¾¿è°ƒè¯•
    console.error('Gemini raw response:', text);
    throw new Error('Gemini returned invalid JSON');
  }
}
```

#### æ–¹æ¡ˆ 3: æ·»åŠ é‡è¯•é€»è¾‘

```typescript
// åœ¨ analyze/route.ts ä¸­
const maxRetries = 3;
for (let i = 0; i < maxRetries; i++) {
  try {
    const result = await callGemini(...);
    return result;
  } catch (e) {
    if (i === maxRetries - 1) throw e;
    await sleep(5000); // 5ç§’åé‡è¯•
  }
}
```

**ä»£ç ä½ç½®ï¼š**

- `apps/api/src/routes/analyze/route.ts`
- `parseGeminiJson()` å‡½æ•°

---

### é—®é¢˜ 3: Edit æŒ‰é’®ä¸å·¥ä½œ ğŸŸ¡ Medium

**æ ¹æœ¬åŸå› ï¼š**

- Edit æŒ‰é’®æ˜¯**å ä½ç¬¦ï¼ˆplaceholderï¼‰**
- æ²¡æœ‰ `onClick` å¤„ç†å™¨

**å½“å‰ä»£ç ï¼ˆä¼ªä»£ç ï¼‰ï¼š**

```tsx
// TransactionDetailSlideOver.tsx:285-296
<button className="..." aria-label="Edit">
  {/* æ²¡æœ‰ onClick! */}
</button>
```

**æœ‰ä¸¤ç§å†…éƒ¨ç¼–è¾‘æ¨¡å¼ï¼š**

- `MobileBottomSheet.tsx` æœ‰ `useEditing(false)` æ¨¡å¼
- `TransactionDataEditor.tsx` æœ‰å®Œæ•´çš„ Edit/Cancel/Save é€»è¾‘

**ä½† slide-over çš„ Edit æŒ‰é’®ä»æœªæ¥é€šï¼**

**ä¿®å¤æ–¹æ¡ˆï¼ˆ2 é€‰ 1ï¼‰ï¼š**

#### é€‰é¡¹ A: æ¥é€šåŠŸèƒ½ï¼ˆæ¨èï¼‰

```tsx
const [isEditing, setIsEditing] = useState(false);

<button 
  onClick={() => setIsEditing(true)}
  aria-label="Edit"
>
  Edit
</button>

{isEditing && (
  <TransactionDataEditor
    transaction={transaction}
    onSave={handleSave}
    onCancel={() => setIsEditing(false)}
  />
)}
```

#### é€‰é¡¹ B: ç§»é™¤æŒ‰é’®ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

```tsx
{/* æš‚æ—¶ç§»é™¤ï¼Œç­‰åŠŸèƒ½å®Œæ•´ */}
```

**ä»£ç ä½ç½®ï¼š**

- `apps/web-app/src/components/transactions/TransactionDetailSlideOver.tsx:285-296`

---

### é—®é¢˜ 4: UI ç¬¦å·å¼‚å¸¸ ğŸŸ¢ Low

**é—®é¢˜æè¿°ï¼š**

- å·¦ä¸Šè§’å’Œ Edit æŒ‰é’®æ—è¾¹æ˜¾ç¤ºå¥‡æ€ªçš„ç¬¦å·ï¼ˆâšª â­•ï¼‰

**æ ¹æœ¬åŸå› ï¼š**

- Android WebViewã€æŸäº› CJK å­—ä½“ä¸æ”¯æŒ emoji
- Emoji æ¸²æŸ“ä¸ºç©ºæ¡†æˆ–é—®å·

**CTO å»ºè®®ï¼š**

> "Replace emoji with inline SVG icons"

**ä¿®å¤æ–¹æ¡ˆï¼š**

```tsx
// æ›¿æ¢ emoji ä¸º SVG å›¾æ ‡
// ä» TrashIcon, ClockIcon, BuildingIcon ç­‰

// å½“å‰ï¼ˆé—®é¢˜ä»£ç ï¼‰
<span>âš </span>  // å¯èƒ½ä¸æ˜¾ç¤º

// ä¿®å¤å
import { ExclamationTriangleIcon } from '@heroicons/react/24/outline';
<ExclamationTriangleIcon className="w-5 h-5 text-yellow-600" />
```

**å»ºè®®ä½¿ç”¨ï¼š**

- Heroiconsï¼ˆé¡¹ç›®å·²ç»åœ¨ç”¨ï¼‰
- Lucide icons
- æˆ–è‡ªå®šä¹‰ SVG

**ä»£ç ä½ç½®ï¼š**

- `StatusDot` or `StatusBadge` ç»„ä»¶

---

### é—®é¢˜ 5: ä¸­æ–‡ä¹±ç  ğŸŸ¢ Low

**é—®é¢˜æè¿°ï¼š**

```
"ç¨ç‡æç¤ºï¼šç¨å…¨éå®ŒæˆæˆåŠŸï¼Œæå—æ•°"
```

**æ ¹æœ¬åŸå› ï¼š**

- è¿™æ®µæ–‡å­—**ä¸åœ¨æºä»£ç ä¸­**
- æ˜¯è¿è¡Œæ—¶ä» AI è¾“å‡ºåŠ¨æ€ç”Ÿæˆçš„
- å¯èƒ½æ˜¯ Gemini çš„"hint"å­—ç¬¦ä¸²
- æ··åˆäº†ç¹ä½“/ç®€ä½“ä¸­æ–‡ï¼Œå¯¼è‡´æŸäº›å­—ä½“æ ˆæ··ä¹±

**CTO å»ºè®®ï¼š**

> "Standardize to one Chinese variant"

**ä¿®å¤æ–¹æ¡ˆï¼š**

1. æ£€æŸ¥ Gemini è¿”å›çš„ `raw_data.hints` å­—æ®µ
2. ç»Ÿä¸€ä½¿ç”¨ç®€ä½“ä¸­æ–‡æˆ–ç¹ä½“ä¸­æ–‡
3. æˆ–è€…ä¸æ˜¾ç¤º AI çš„ hintï¼ˆå¦‚æœä¸é‡è¦ï¼‰

**ä»£ç ä½ç½®ï¼š**

- æ˜¾ç¤ºç¨ç‡æç¤ºçš„ç»„ä»¶
- å¯èƒ½åœ¨ `TransactionDataForms.tsx` æˆ–ç±»ä¼¼ç»„ä»¶

---

## ğŸš€ å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### Phase 1: ç´§æ€¥ä¿®å¤ï¼ˆP0ï¼Œä»Šå¤©å®Œæˆï¼‰â±ï¸ 6-9 å°æ—¶

#### 1.1 æ·»åŠ é€€è´§æ£€æµ‹é€»è¾‘ï¼ˆ4-6 å°æ—¶ï¼‰

**åç«¯ï¼š**

```typescript
// apps/api/src/routes/analyze/route.ts

// åœ¨ Gemini prompt ä¸­æ·»åŠ 
const prompt = `
...existing prompt...

IMPORTANT: If the total amount is negative, this is a REFUND/RETURN transaction.
Set "transaction_type": "refund" and note it in your response.

Negative totals are valid and expected for refunds.
`;

// çŠ¶æ€åˆ¤å®šé€»è¾‘æ›´æ–°
function determineStatus(data: ParsedData): TransactionStatus {
  // å¦‚æœæ˜¯é€€è´§ï¼Œé»˜è®¤ needs_review
  if (data.total < 0 || data.transaction_type === 'refund') {
    return 'needs_review';
  }

  // åŸæœ‰é€»è¾‘...
  if (hasRequiredFields && mathChecksOut) {
    return 'auto_ready';
  }

  return 'needs_review';
}
```

**æ•°æ®åº“ï¼š**

```sql
-- æ·»åŠ  transaction_type å­—æ®µ
ALTER TABLE transactions 
ADD COLUMN transaction_type VARCHAR(20) DEFAULT 'purchase';

-- å¯èƒ½çš„å€¼ï¼š'purchase', 'refund', 'adjustment'
```

**å‰ç«¯ï¼š**

```tsx
// åœ¨åˆ—è¡¨å’Œè¯¦æƒ…é¡µæ˜¾ç¤ºé€€è´§æ ‡è®°
{transaction.type === 'refund' && (
  <span className="text-yellow-700 bg-yellow-50 px-2 py-1 rounded">
    ğŸŸ¡ é€€è´§
  </span>
)}
```

---

#### 1.2 ä¿®å¤ Gemini 500 é”™è¯¯ï¼ˆ2-3 å°æ—¶ï¼‰

**åŠ å¼º promptï¼š**

```typescript
const prompt = `
CRITICAL: You must respond ONLY with valid JSON.
- No markdown code fences (no \`\`\`json or \`\`\`)
- No explanations before or after the JSON
- Start directly with { and end with }
`;
```

**åŠ å¼ºè§£æå™¨ï¼š**

```typescript
function parseGeminiJson(text: string) {
  // Strip markdown fences
  let cleaned = text.replace(/```json|```/g, '').trim();

  // Try parse
  try {
    return JSON.parse(cleaned);
  } catch (e) {
    console.error('Gemini raw response:', text);

    // å°è¯•ä¿®å¤å¸¸è§é—®é¢˜
    // 1. å»é™¤å‰åç©ºæ ¼å’Œæ¢è¡Œ
    cleaned = cleaned.trim();

    // 2. å†è¯•ä¸€æ¬¡
    try {
      return JSON.parse(cleaned);
    } catch (e2) {
      throw new Error(`Gemini returned invalid JSON: ${e2.message}`);
    }
  }
}
```

**æ·»åŠ é‡è¯•ï¼š**

```typescript
// åœ¨ worker.ts ä¸­
async function analyzeWithRetry(transactionId: string) {
  const maxRetries = 3;

  for (let i = 0; i < maxRetries; i++) {
    try {
      return await analyze(transactionId);
    } catch (error) {
      if (i === maxRetries - 1) {
        // æœ€åä¸€æ¬¡å¤±è´¥ï¼Œæ ‡è®°ä¸º blocked
        await updateTransactionStatus(transactionId, 'blocked');
        throw error;
      }

      console.log(`Retry ${i + 1}/${maxRetries} for ${transactionId}`);
      await sleep(5000 * (i + 1)); // é€’å¢å»¶è¿Ÿ
    }
  }
}
```

---

### Phase 2: é‡è¦ä¼˜åŒ–ï¼ˆP1ï¼Œæœ¬å‘¨å®Œæˆï¼‰â±ï¸ 2-4 å°æ—¶

#### 2.1 ä¿®å¤ Edit åŠŸèƒ½ï¼ˆ2-4 å°æ—¶ï¼‰

**é€‰é¡¹ A: æ¥é€šåŠŸèƒ½ï¼ˆæ¨èï¼‰**

```tsx
// TransactionDetailSlideOver.tsx
const [isEditing, setIsEditing] = useState(false);

return (
  <div>
    {!isEditing ? (
      <>
        <button onClick={() => setIsEditing(true)}>
          Edit
        </button>
        {/* æ˜¾ç¤ºæ¨¡å¼ */}
      </>
    ) : (
      <TransactionDataEditor
        transaction={transaction}
        onSave={async (updated) => {
          await saveTransaction(updated);
          setIsEditing(false);
        }}
        onCancel={() => setIsEditing(false)}
      />
    )}
  </div>
);
```

**å¯ç¼–è¾‘å­—æ®µï¼ˆæ ¹æ® GPT è§„åˆ™ï¼‰ï¼š**

```typescript
const EDITABLE_FIELDS = [
  'category',
  'project',
  'vendor', // åˆ«å
  'notes',
  'refund_of_transaction_id' // é€€è´§ä¸“ç”¨
];

const READONLY_FIELDS = [
  'total',
  'subtotal',
  'gst',
  'pst',
  'transaction_date' // é™¤é OCR æ˜æ˜¾é”™è¯¯
];
```

---

### Phase 3: æ¬¡è¦ä¼˜åŒ–ï¼ˆP2ï¼Œä¸‹å‘¨ï¼‰â±ï¸ 1.5 å°æ—¶

#### 3.1 æ›¿æ¢ UI ç¬¦å·ä¸º SVG å›¾æ ‡ï¼ˆ1 å°æ—¶ï¼‰

```tsx
// æ›¿æ¢æ‰€æœ‰ emoji
import {
  ExclamationTriangleIcon,  // âš 
  CheckCircleIcon,          // âœ“
  XCircleIcon,              // âœ•
  ClockIcon                 // â³
} from '@heroicons/react/24/outline';

// çŠ¶æ€å›¾æ ‡ç»„ä»¶
function StatusIcon({ status }: { status: string }) {
  switch (status) {
    case 'auto_ready':
      return <CheckCircleIcon className="w-5 h-5 text-green-600" />;
    case 'needs_review':
      return <ExclamationTriangleIcon className="w-5 h-5 text-yellow-600" />;
    case 'blocked':
      return <XCircleIcon className="w-5 h-5 text-red-600" />;
    case 'pending':
      return <ClockIcon className="w-5 h-5 text-blue-600" />;
  }
}
```

---

#### 3.2 ä¿®å¤ä¸­æ–‡ä¹±ç ï¼ˆ30 åˆ†é’Ÿï¼‰

**æ£€æŸ¥å¹¶ç§»é™¤ä¸å¿…è¦çš„ AI hintsï¼š**

```typescript
// å¦‚æœ"ç¨ç‡æç¤º"æ¥è‡ª Gemini
// é€‰é¡¹ 1: ä¸æ˜¾ç¤º
// é€‰é¡¹ 2: ç»Ÿä¸€ä¸ºç®€ä½“ä¸­æ–‡
```

---

## ğŸ“‹ å®æ–½æ¸…å•

### âœ… Phase 1: ç´§æ€¥ä¿®å¤ï¼ˆä»Šå¤©ï¼‰

- [ ] **åç«¯ï¼šæ·»åŠ é€€è´§æ£€æµ‹**
  
  - [ ] æ›´æ–° Gemini prompt
  - [ ] æ·»åŠ  transaction_type å­—æ®µåˆ°æ•°æ®åº“
  - [ ] æ›´æ–°çŠ¶æ€åˆ¤å®šé€»è¾‘
  - [ ] æ›´æ–°æ•°å­¦æ ¡éªŒï¼ˆå…è®¸è´Ÿæ•°ï¼‰

- [ ] **åç«¯ï¼šä¿®å¤ Gemini 500**
  
  - [ ] åŠ å¼º promptï¼ˆç¦æ­¢ markdownï¼‰
  - [ ] æ”¹è¿› parseGeminiJson()
  - [ ] æ·»åŠ é‡è¯•é€»è¾‘

- [ ] **å‰ç«¯ï¼šæ˜¾ç¤ºé€€è´§æ ‡è®°**
  
  - [ ] åˆ—è¡¨é¡µæ˜¾ç¤º"ğŸŸ¡ é€€è´§"
  - [ ] è¯¦æƒ…é¡µé¡¶éƒ¨æ˜¾ç¤ºé€€è´§æç¤º
  - [ ] ç¡®è®¤æŒ‰é’®æ–‡æ¡ˆæ”¹ä¸º"ç¡®è®¤é€€è´§"

- [ ] **æµ‹è¯•**
  
  - [ ] ä¸Šä¼ é€€è´§ receiptï¼ˆè´Ÿæ•° totalï¼‰
  - [ ] éªŒè¯çŠ¶æ€ä¸º needs_review
  - [ ] éªŒè¯å¯ä»¥ç¡®è®¤
  - [ ] éªŒè¯æ­£å¸¸ receipt ä¸å—å½±å“

---

### âœ… Phase 2: é‡è¦ä¼˜åŒ–ï¼ˆæœ¬å‘¨ï¼‰

- [ ] **å‰ç«¯ï¼šä¿®å¤ Edit åŠŸèƒ½**
  - [ ] æ¥é€š Edit æŒ‰é’®çš„ onClick
  - [ ] å®ç°ç¼–è¾‘æ¨¡å¼åˆ‡æ¢
  - [ ] é™åˆ¶å¯ç¼–è¾‘å­—æ®µï¼ˆæ ¹æ® GPT è§„åˆ™ï¼‰
  - [ ] æµ‹è¯•ç¼–è¾‘ä¿å­˜

---

### âœ… Phase 3: æ¬¡è¦ä¼˜åŒ–ï¼ˆä¸‹å‘¨ï¼‰

- [ ] **å‰ç«¯ï¼šæ›¿æ¢ emoji ä¸º SVG**
  
  - [ ] æ›¿æ¢çŠ¶æ€å›¾æ ‡
  - [ ] æµ‹è¯•å„ç§è®¾å¤‡æ˜¾ç¤º

- [ ] **å‰ç«¯ï¼šä¿®å¤ä¸­æ–‡ä¹±ç **
  
  - [ ] æ£€æŸ¥ç¨ç‡æç¤ºæ¥æº
  - [ ] ç»Ÿä¸€ä¸­æ–‡å˜ä½“æˆ–ç§»é™¤

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### æµ‹è¯•ç”¨ä¾‹ 1: æ­£å¸¸é€€è´§

**è¾“å…¥ï¼š**

- Receipt: The Home Depot
- Total: -$144.38 CAD
- Date: 2024/06/04

**é¢„æœŸï¼š**

- âœ… è‡ªåŠ¨è¯†åˆ«ä¸ºé€€è´§ï¼ˆtype = 'refund'ï¼‰
- âœ… çŠ¶æ€ä¸º needs_review
- âœ… æ˜¾ç¤º"ğŸŸ¡ é€€è´§ Â· éœ€ç¡®è®¤"
- âœ… å¯ä»¥ç‚¹å‡»"ç¡®è®¤é€€è´§"
- âœ… ç¡®è®¤åçŠ¶æ€å˜ä¸º auto_ready

---

### æµ‹è¯•ç”¨ä¾‹ 2: æ­£å¸¸è´­ä¹°

**è¾“å…¥ï¼š**

- Receipt: The Home Depot
- Total: $39.65 CAD

**é¢„æœŸï¼š**

- âœ… type = 'purchase'
- âœ… çŠ¶æ€ä¸º auto_ready
- âœ… ä¸æ˜¾ç¤ºé€€è´§æ ‡è®°
- âœ… ä¸å—é€€è´§é€»è¾‘å½±å“

---

### æµ‹è¯•ç”¨ä¾‹ 3: Gemini é‡è¯•

**æ¨¡æ‹Ÿï¼š**

- Gemini è¿”å› markdown-wrapped JSON

**é¢„æœŸï¼š**

- âœ… è§£æå™¨è‡ªåŠ¨ strip markdown
- âœ… æˆåŠŸè§£æ JSON
- âœ… ä¸è§¦å‘ 500 é”™è¯¯

---

### æµ‹è¯•ç”¨ä¾‹ 4: Edit åŠŸèƒ½

**æ“ä½œï¼š**

- ç‚¹å‡» Edit æŒ‰é’®
- ä¿®æ”¹ category
- ä¿å­˜

**é¢„æœŸï¼š**

- âœ… è¿›å…¥ç¼–è¾‘æ¨¡å¼
- âœ… å¯ä»¥ä¿®æ”¹ category
- âœ… ä¸èƒ½ä¿®æ”¹ total
- âœ… ä¿å­˜æˆåŠŸ

---

## ğŸ“Š å½±å“è¯„ä¼°

### ä¼šè®¡å·¥ä½œæµå½±å“

**Beforeï¼ˆå½“å‰ï¼‰ï¼š**

```
1. ä¸Šä¼ é€€è´§ receipt
2. âŒ ç³»ç»Ÿæ— æ³•è¯†åˆ«
3. âŒ çŠ¶æ€ä¸æ˜
4. âŒ æ— æ³•ç¡®è®¤
5. âŒ æ‰‹åŠ¨å¤„ç†ï¼ˆç—›è‹¦ï¼‰
```

**Afterï¼ˆä¿®å¤åï¼‰ï¼š**

```
1. ä¸Šä¼ é€€è´§ receipt
2. âœ… è‡ªåŠ¨è¯†åˆ«ä¸ºé€€è´§
3. âœ… çŠ¶æ€ = needs_review
4. âœ… çœ‹åˆ°"ğŸŸ¡ é€€è´§ Â· éœ€ç¡®è®¤"
5. âœ… ç‚¹å‡»"ç¡®è®¤é€€è´§"
6. âœ… å®Œæˆï¼ˆ5 ç§’ï¼‰
```

---

### ç³»ç»Ÿç¨³å®šæ€§å½±å“

| æŒ‡æ ‡             | Before | After | æ”¹è¿›     |
| -------------- | ------ | ----- | ------ |
| Gemini 500 é”™è¯¯ç‡ | é«˜ï¼ˆé€€è´§æ—¶ï¼‰ | ä½     | â¬‡ï¸ 90% |
| é€€è´§å¤„ç†æˆåŠŸç‡        | 0%     | 95%+  | â¬†ï¸ 95% |
| ç”¨æˆ·æ»¡æ„åº¦          | ä½      | é«˜     | â¬†ï¸ æ˜¾è‘—  |

---

## ğŸ’¡ å…³é”®å­¦ä¹ ç‚¹

### 1. è´Ÿæ•°ä¸æ˜¯å¼‚å¸¸

**é”™è¯¯æ€ç»´ï¼š**

> "total < 0 = å¼‚å¸¸ = blocked"

**æ­£ç¡®æ€ç»´ï¼š**

> "total < 0 = é€€è´§ = éœ€è¦ç¡®è®¤"

---

### 2. äº§å“ vs æŠ€æœ¯çš„é…åˆ

**äº§å“ï¼ˆGPTï¼‰å®šä¹‰ï¼š**

- é€€è´§æ˜¯ä»€ä¹ˆ
- åº”è¯¥å¦‚ä½•å¤„ç†
- ä¼šè®¡çš„æœŸæœ›

**æŠ€æœ¯ï¼ˆCTOï¼‰å®ç°ï¼š**

- å¦‚ä½•æ£€æµ‹é€€è´§
- å¦‚ä½•ä¿®å¤ Bug
- å¦‚ä½•ç¡®ä¿ç¨³å®š

**CDO æ•´åˆï¼š**

- ç¡®ä¿åŒæ–¹å¯¹é½
- è®°å½•å®Œæ•´æ–¹æ¡ˆ
- æŒ‡å¯¼å®æ–½

---

### 3. AI åä½œçš„ä»·å€¼

**è¿™æ¬¡åä½œå±•ç¤ºäº†ï¼š**

- GPT ä»ä¼šè®¡è§†è§’å®šä¹‰è§„åˆ™
- CTO ä»æŠ€æœ¯è§’åº¦è¯Šæ–­é—®é¢˜
- CDO æ•´åˆä¿¡æ¯ã€äº§å‡ºæ–¹æ¡ˆ

**å¦‚æœæ²¡æœ‰åˆ†å·¥ï¼š**

- å¯èƒ½æŠŠé€€è´§å½“å¼‚å¸¸
- å¯èƒ½é—æ¼å…³é”®éœ€æ±‚
- å¯èƒ½ç¼ºå°‘ç³»ç»Ÿæ€§è§£å†³

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

**åç«¯ï¼š**

```
apps/api/src/routes/analyze/route.ts
apps/api/src/workers/analyze-worker.ts
packages/shared-utils/src/parseGeminiJson.tsï¼ˆå¯èƒ½éœ€è¦åˆ›å»ºï¼‰
```

**æ•°æ®åº“ï¼š**

```
migrations/add_transaction_type.sqlï¼ˆæ–°å»ºï¼‰
```

**å‰ç«¯ï¼š**

```
apps/web-app/src/components/transactions/TransactionDetailSlideOver.tsx
apps/web-app/src/components/transactions/TransactionsList.tsx
apps/web-app/src/components/transactions/StatusBadge.tsx
apps/web-app/src/components/transactions/TransactionDataEditor.tsx
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

**äº§å“é—®é¢˜ï¼š** GPT (CPO)  
**æŠ€æœ¯é—®é¢˜ï¼š** CTO (Claude Code)  
**æ–‡æ¡£é—®é¢˜ï¼š** CDO (Claude Web AI)

---

**ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¶é—´ï¼š** 2026-02-01  
**è´Ÿè´£äººï¼š** CDO (Claude Web AI)  
**å‚ä¸è€…ï¼š** GPT (CPO), CTO (Claude Code), CEO

---

**å½“å‰çŠ¶æ€ï¼š** âš ï¸ å¾…å®æ–½  
**é¢„è®¡å®Œæˆï¼š** Phase 1 ä»Šå¤©ï¼ŒPhase 2 æœ¬å‘¨ï¼ŒPhase 3 ä¸‹å‘¨

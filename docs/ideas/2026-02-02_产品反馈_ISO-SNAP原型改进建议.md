# ISO SNAP 原型反馈与改进建议

> **反馈人：** CDO (Chief Data Officer)  
> **收件人：** CTO  
> **日期：** 2026-02-02  
> **原型版本：** V0.1 (localhost:5002)  
> **反馈类型：** 🔴 Critical Product Issues + 功能完善建议

---

## 🎯 原型总体评价

### ✅ 做得好的地方

1. **界面布局清晰**
   - 工具栏布局合理（Drain, Vent, Select, Fixture, Text, Pipe）
   - Undo/Redo 已实现
   - 导出功能已准备（Export PNG/PDF）

2. **基础绘图能力**
   - 已能画出 45° drain 线条
   - 画布缩放/平移应该已实现

3. **技术架构**
   - 快速原型，执行力很强
   - PWA 基础架构应该已搭建

---

## 🔴 Critical Issues（必须修复）

### Issue 1：线条无法连接 ❌ 

**现象：**
- 从截图看，画布上有独立的线条和节点
- 但新线条不能连接到现有线条的端点
- 这导致无法画出"管道系统"

**问题根源：**
```
Isometric 绘图的核心是"连接的管道系统"
如果线条不能相连，这个工具就失去了意义
```

**必须实现：节点捕捉（Snap to Node）**

---

#### 解决方案：节点捕捉系统

**核心逻辑：**

```typescript
// 伪代码示例
function findNearestNode(mouseX, mouseY, snapDistance = 15) {
  for (const node of allNodes) {
    const distance = Math.sqrt(
      (node.x - mouseX) ** 2 + 
      (node.y - mouseY) ** 2
    );
    
    if (distance < snapDistance) {
      return node; // 返回最近的节点
    }
  }
  return null; // 没有找到可捕捉的节点
}

// 绘制时
onMouseDown(e) {
  const nearNode = findNearestNode(e.x, e.y);
  
  if (nearNode) {
    // 从这个现有节点开始画
    startNode = nearNode;
  } else {
    // 创建新节点
    startNode = createNewNode(e.x, e.y);
  }
}

onMouseUp(e) {
  const nearNode = findNearestNode(e.x, e.y);
  
  if (nearNode && nearNode !== startNode) {
    // 连接到现有节点
    createEdge(startNode, nearNode);
  } else {
    // 创建新的终点节点
    endNode = createNewNode(e.x, e.y);
    createEdge(startNode, endNode);
  }
}
```

---

**视觉反馈（非常重要）：**

```
当鼠标靠近可捕捉的节点时：
1. 节点变大或高亮（例如：从灰色 → 黄色）
2. 显示一个"捕捉圈"（snap circle）
3. 鼠标指针变化（可选）

让用户清楚知道："这里可以连接"
```

---

**数据结构建议：**

```typescript
interface Node {
  id: string;
  x: number;
  y: number;
  connectedEdges: string[]; // 连接到这个节点的边
}

interface Edge {
  id: string;
  fromNodeId: string;
  toNodeId: string;
  type: 'drain' | 'vent';
  diameter: '1-1/2"' | '2"' | '3"' | '4"';
  label?: string;
}

// 全局状态
const nodes: Map<string, Node> = new Map();
const edges: Map<string, Edge> = new Map();
```

---

### Issue 2：缺少框选功能 ❌

**现象：**
- 只能一个一个点选对象
- 无法批量选择和操作

**为什么这很重要：**
```
当画布上有 20+ 个对象时：
- 需要删除一片区域的管道
- 需要整体移动一部分
- 需要批量修改属性

框选是必不可少的基础功能
```

---

#### 解决方案：矩形框选（Rectangular Selection）

**实现逻辑：**

```typescript
let selectionBox: {
  startX: number;
  startY: number;
  endX: number;
  endY: number;
} | null = null;

// 在 Select 工具激活时
onMouseDown(e) {
  if (currentTool === 'select') {
    // 检查是否点击到了对象
    const clickedObject = findObjectAt(e.x, e.y);
    
    if (clickedObject) {
      // 点选单个对象
      toggleSelection(clickedObject);
    } else {
      // 开始框选
      selectionBox = {
        startX: e.x,
        startY: e.y,
        endX: e.x,
        endY: e.y
      };
    }
  }
}

onMouseMove(e) {
  if (selectionBox) {
    // 更新框选矩形
    selectionBox.endX = e.x;
    selectionBox.endY = e.y;
    
    // 重绘虚线矩形
    drawSelectionBox(selectionBox);
  }
}

onMouseUp(e) {
  if (selectionBox) {
    // 找出框内的所有对象
    const selectedObjects = findObjectsInBox(selectionBox);
    
    // 更新选中状态
    setSelection(selectedObjects);
    
    // 清除框选
    selectionBox = null;
  }
}
```

---

**视觉设计：**

```
框选矩形：
- 虚线边框（蓝色，dash）
- 半透明填充（rgba(100, 150, 255, 0.1)）

选中的对象：
- 边框加粗或变色
- 节点显示为实心
- 显示拖拽手柄（可选）
```

---

### Issue 3：节点编辑能力缺失 ⚠️

**当前缺少的：**
- 无法移动已有的节点
- 无法修改已画线段的属性
- 无法延长或缩短管道

**必须支持：**

```
1. 拖动节点
   - 点击节点 → 拖动 → 所有连接的线段跟着移动

2. 修改线段属性
   - 点选线段 → 弹出属性面板 → 修改管径

3. 删除节点/线段
   - 选中 → 按 Delete 或点击删除按钮
   - 删除节点时，自动删除连接的线段
```

---

## 🟡 Important Improvements（强烈建议）

### 1. Grid 视觉提示 ✅

**当前状态：**
- 背景是纯色
- 看不出 isometric grid

**建议：**

```typescript
// 画出淡淡的 isometric grid
function drawGrid() {
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
  ctx.lineWidth = 1;
  
  // 竖直线（vertical）
  for (let x = 0; x < canvasWidth; x += gridSize) {
    drawLine(x, 0, x, canvasHeight);
  }
  
  // 45° 线（drain 方向）
  // ... 画出倾斜的参考线
}
```

**效果：**
- 让用户知道"这是 isometric 视角"
- 帮助对齐
- 更专业

---

### 2. 工具状态视觉反馈 ✅

**当前问题：**
- 不清楚当前激活的是哪个工具
- 鼠标指针没有变化

**建议：**

```css
/* 工具栏 */
.tool-button.active {
  background: #2563eb;
  border: 2px solid #60a5fa;
}

/* 鼠标指针 */
.canvas[data-tool="drain"] {
  cursor: crosshair;
}

.canvas[data-tool="select"] {
  cursor: default;
}

.canvas[data-tool="text"] {
  cursor: text;
}
```

---

### 3. Fixture 符号可视化 ✅

**当前状态：**
- Fixture 按钮存在，但不知道如何显示

**必须实现：**

```
Fixture 的显示方式（2种方案）：

方案A：简单文本标签（推荐 MVP）
- 在节点旁边显示 "WC"、"LAV"、"SINK" 等
- 字体稍大、加粗
- 白色或浅色

方案B：简单符号（后续优化）
- WC: 圆形 + "WC"
- LAV: 方形 + "LAV"
- SINK: 矩形 + "SINK"
```

**放置交互：**

```typescript
// 点击 Fixture 按钮 → 选择类型（WC/LAV/SINK...）
// 然后点击画布上的节点 → 放置 Fixture

onCanvasClick(e) {
  if (currentTool === 'fixture') {
    const nearNode = findNearestNode(e.x, e.y);
    
    if (nearNode) {
      // 在这个节点上添加 fixture
      addFixture(nearNode, selectedFixtureType);
    } else {
      // 提示："请点击节点来放置 fixture"
      showToast("Click on a node to place fixture");
    }
  }
}
```

---

### 4. 管径标注显示 ✅

**当前状态：**
- 管径按钮（1-1/2", 2", 3", 4"）存在
- 但不知道如何应用和显示

**必须实现：**

```
管径标注的显示位置：
- 在线段的中点附近
- 小字号（12-14px）
- 背景半透明或无背景
- 例如：'2"' 或 'Ø2"'
```

**应用交互：**

```typescript
// 方法1：画线时选择管径（推荐）
// 在画线之前，先在工具栏选择管径
// 新画的线自动带这个管径

// 方法2：画线后再设置
// 选中线段 → 点击管径按钮 → 应用
```

---

### 5. 文本标签功能 ✅

**Text 工具应该做什么：**

```typescript
onCanvasClick(e) {
  if (currentTool === 'text') {
    // 弹出一个简单的文本输入框
    const text = prompt("Enter label text:");
    
    if (text) {
      // 在点击位置创建文本标签
      createTextLabel(e.x, e.y, text);
    }
  }
}

// 或者更好的方式：
// 点击后，在画布上直接显示一个可编辑的文本框
// 类似于 Google Drawings
```

**文本显示：**
- 字体：sans-serif, 14px
- 颜色：白色或浅色
- 可拖动位置
- 可编辑内容（双击）

---

### 6. 键盘快捷键 🎯

**基础快捷键（强烈建议）：**

```
D - Drain tool
V - Vent tool
S - Select tool
F - Fixture tool
T - Text tool

Delete/Backspace - 删除选中对象
Cmd/Ctrl + Z - Undo
Cmd/Ctrl + Shift + Z - Redo
Cmd/Ctrl + A - 全选

Esc - 取消当前操作
```

---

## 🟢 Nice to Have（可以后续加）

### 1. 撤销/重做的细节优化

**当前：**
- 有 Undo/Redo 按钮

**优化：**
- 显示可撤销的步数（例如："Undo (5)"）
- 撤销后，Redo 按钮亮起

---

### 2. 导出前的预览

**当前：**
- 直接导出

**优化：**
```
点击 Export → 弹出预览对话框
- 显示导出效果（黑白线稿）
- 可以添加项目名称
- 可以选择纸张大小（A4/Letter）
- 确认后再下载
```

---

### 3. 最近保存的草图列表

**当前：**
- 可能只保存 1 张

**优化：**
```
左侧或弹出菜单显示：
- 最近的 5-10 张草图
- 缩略图 + 日期
- 点击加载
```

---

### 4. 触控优化（iPad 重要）

**必须测试：**
- 双指缩放是否流畅
- 触摸拖动是否灵敏
- 节点是否够大（触摸目标至少 44x44px）

---

## 📋 优先级建议

### 🔴 P0 - 必须立即修复（本周）

1. **节点捕捉系统**
   - 新线条能连接到现有节点
   - 视觉反馈（节点高亮）
   - 工作量：1-2天

2. **框选功能**
   - 矩形框选
   - 多选状态显示
   - 工作量：1天

3. **节点拖动**
   - 移动节点，线段跟随
   - 工作量：0.5天

---

### 🟡 P1 - 强烈建议（下周）

4. **Fixture 显示和放置**
   - 文本标签方式
   - 工作量：1天

5. **管径标注显示**
   - 线段上显示管径
   - 工作量：0.5天

6. **文本工具完善**
   - 输入和显示
   - 工作量：0.5天

7. **工具状态反馈**
   - 激活状态、鼠标指针
   - 工作量：0.5天

---

### 🟢 P2 - 可以再优化

8. Grid 视觉提示
9. 键盘快捷键
10. 导出预览
11. 最近草图列表

---

## 💡 技术建议

### 数据结构优化

**当前可能的问题：**
- 节点和线段可能是独立存储
- 没有建立连接关系

**建议的数据模型：**

```typescript
// 核心数据结构
class DrawingState {
  nodes: Map<string, Node>;
  edges: Map<string, Edge>;
  fixtures: Map<string, Fixture>;
  textLabels: Map<string, TextLabel>;
  
  // 选中状态
  selectedNodes: Set<string>;
  selectedEdges: Set<string>;
  
  // 历史记录（用于 undo/redo）
  history: DrawingState[];
  currentHistoryIndex: number;
}

// 节点
interface Node {
  id: string;
  x: number;
  y: number;
  connectedEdges: string[]; // 重要：跟踪连接
}

// 边（线段）
interface Edge {
  id: string;
  fromNodeId: string; // 必须引用 Node.id
  toNodeId: string;   // 必须引用 Node.id
  type: 'drain' | 'vent';
  diameter: string;
  label?: string;
}
```

---

### 渲染优化

**性能目标：**
- 50-200 条线段依旧顺滑
- iPad Safari 60fps

**建议：**

```typescript
// 只重绘变化的部分
function render() {
  // 清空画布
  ctx.clearRect(0, 0, width, height);
  
  // 绘制顺序
  drawGrid();           // 背景 grid
  drawEdges();          // 所有线段
  drawNodes();          // 所有节点
  drawFixtures();       // Fixture 符号
  drawTextLabels();     // 文本标签
  drawSelection();      // 选中状态
  drawSelectionBox();   // 框选矩形（如果有）
}

// 使用 requestAnimationFrame
let isDirty = false;
function markDirty() {
  if (!isDirty) {
    isDirty = true;
    requestAnimationFrame(() => {
      render();
      isDirty = false;
    });
  }
}
```

---

### 触控优化

```typescript
// iPad Safari 特别处理
canvas.addEventListener('touchstart', (e) => {
  e.preventDefault(); // 防止默认行为
  
  if (e.touches.length === 1) {
    // 单指 = 画线或选择
    handleMouseDown(e.touches[0]);
  } else if (e.touches.length === 2) {
    // 双指 = 缩放/平移
    handlePinchStart(e.touches);
  }
});
```

---

## 🎯 一句话总结（给CTO）

**当前原型最大的问题是：**
> "线条不能连接成系统，框选功能缺失，这两个是 isometric 绘图工具的生死线。"

**优先级：**
```
P0（本周）：节点捕捉 + 框选 + 节点拖动
P1（下周）：Fixture + 管径标注 + 文本工具 + 视觉反馈
P2（后续）：Grid + 快捷键 + 导出优化
```

**时间估算：**
- P0 修复：2-3天
- P1 完善：2-3天
- P2 优化：按需

**总计：1周左右可以达到可用的 MVP**

---

## 📎 参考资料

**可以参考的开源绘图库：**
- Konva.js - Canvas 封装库（推荐）
- Fabric.js - 功能更全
- Excalidraw - 开源白板（参考 UX）

**Isometric 绘图示例：**
- [Google] "isometric drawing tool"
- [看看竞品] Easy Isometric

---

## 💬 需要我帮助的地方？

如果需要，我（CDO）可以提供：

1. **详细的交互流程图**
   - 每个工具的完整交互逻辑

2. **UI/UX 设计建议**
   - 颜色、布局、视觉反馈细节

3. **数据结构设计评审**
   - 确保扩展性

4. **用户测试脚本**
   - 找管工测试用的场景

---

**再次感谢 CTO 的快速交付！原型搭建得很好，现在需要的是把核心交互打磨到位。** 💪

---

**版本：** v1.0  
**创建时间：** 2026-02-02  
**下次评审：** P0 修复完成后  
**优先级：** 🔴 Critical

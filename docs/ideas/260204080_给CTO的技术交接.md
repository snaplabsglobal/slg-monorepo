# 给CTO的技术交接说明

> **会议时间：** 2026-02-04 08:10  
> **文档类型：** 战略 → 架构交接  
> **优先级：** 🔴 P0 - 立即对齐  
> **状态：** 待CTO确认

---

## 📋 背景同步（产品方向已确定）

我们已经完成Phase 1产品定型，当前明确的执行顺序是：

### Phase 1：Jobsite Snap – Job Photos（核心）

- Job / Project作为唯一上下文
- Photos是事实层（时间线 + 轻量结构）
- 不涉及画图、Plan、Cost

### Phase 2：SnapPocket（LedgerSnap的Lite / 入口）

- 收据拍照 + OCR
- Project / Overhead分类
- 不涉及正式账本、会计协作

### PlanSnap（几何）已明确后置，不进入当前Roadmap。

---

# Part 1：当前我想和你确认的核心问题

## 在不做大规模重构的前提下

**我们现有数据库schema是否需要做最小修正，来同时支持：**

1. **Job Photos**（高频、时间线、附件型数据）
2. **SnapPocket**（收据、OCR字段、可纠错财务数据）

---

## 是否需要提前统一或抽象出以下概念层（如有）：

### 1️⃣ Job / Project作为跨模块的一级实体

- Photos属于Job
- Receipts属于Job
- 未来Plans属于Job
- 未来Costs属于Job

**问题：**  
现在是否需要一个统一的`Job`表作为所有模块的根实体？

---

### 2️⃣ Attachment / Media（照片 / 收据）的通用模型

**照片和收据有很多共同点：**
- 都是拍照上传
- 都有时间戳
- 都需要OCR（可选）
- 都需要分类

**问题：**  
是否需要一个通用的`Attachment`或`Media`表，用`type`区分Photo / Receipt？

还是分开成：
- `Photo`表
- `Receipt`表

---

### 3️⃣ 可选的Source Type（Photo / Receipt）区分

如果统一成`Attachment`表，是否需要：

```sql
CREATE TABLE attachments (
  id UUID PRIMARY KEY,
  job_id UUID NOT NULL,
  type ENUM('photo', 'receipt') NOT NULL,
  file_url TEXT NOT NULL,
  created_at TIMESTAMP NOT NULL,
  
  -- Photo特有字段
  stage ENUM('before', 'during', 'after'),
  area TEXT,
  trade TEXT,
  
  -- Receipt特有字段
  amount DECIMAL,
  vendor TEXT,
  category ENUM('project', 'overhead'),
  ocr_data JSONB
);
```

还是保持独立？

---

## 哪些字段/设计现在不加，以后一定会痛？

请你从架构与长期演进角度，帮我们判断：

1. 哪些是现在必须设计对的？
2. 哪些可以后续迁移？
3. 哪些是"现在千万别加"的过度设计？

---

## 哪些是现在千万别加，以免污染Phase 1？

我们的原则是：
- Phase 1最重要的是稳定 + 不返工
- 允许未来迁移，但希望避免方向性错误

---

# Part 2：我们的明确约束（请你按这个前提判断）

## 三条原则

1. **不追求一次性"完美schema"**
2. **允许未来迁移，但希望避免方向性错误**
3. **Phase 1最重要的是稳定 + 不返工**

---

# Part 3：数据模型初步建议（供你参考）

## 方案A：统一Attachment表（更抽象）

### 优点：
- 代码复用（上传、查看、删除逻辑）
- 扩展性好（未来加Document / Invoice）
- 跨类型查询方便

### 缺点：
- 字段冗余（很多NULL）
- 查询需要WHERE type
- OCR数据结构不统一（JSONB）

---

## 方案B：独立Photo / Receipt表（更直接）

### 优点：
- 字段清晰，无冗余
- 查询简单
- 类型安全

### 缺点：
- 代码可能重复
- 跨类型统计需要UNION

---

## 我们倾向的方案（但需要你确认）

**初步倾向方案B：独立表**

理由：
1. Photos和Receipts的业务逻辑差异大
2. 避免过早抽象
3. 如果未来需要统一，可以再加一层视图

但需要你从技术角度确认：
- 这样做会不会有明显的技术债？
- 未来如果要统一，迁移成本多大？

---

# Part 4：Job表设计（核心实体）

## 建议的最小Job表

```sql
CREATE TABLE jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  name TEXT NOT NULL,
  address TEXT,
  status ENUM('active', 'archived') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_jobs_user_id ON jobs(user_id);
CREATE INDEX idx_jobs_status ON jobs(status);
```

**问题：**
1. 是否需要更多字段？
2. 是否需要`client_id`（未来）？
3. `address`是否需要拆分（street / city / state）？

---

# Part 5：Photo表设计

## 建议的最小Photo表

```sql
CREATE TABLE photos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_id UUID NOT NULL REFERENCES jobs(id) ON DELETE CASCADE,
  file_url TEXT NOT NULL,
  file_size BIGINT,
  mime_type TEXT,
  
  -- 时间
  taken_at TIMESTAMP,
  uploaded_at TIMESTAMP DEFAULT NOW(),
  
  -- 结构化（可选）
  stage ENUM('before', 'during', 'after') DEFAULT 'during',
  area TEXT,
  trade TEXT,
  
  -- 元数据（可选）
  device_info JSONB,
  location JSONB
);

CREATE INDEX idx_photos_job_id ON photos(job_id);
CREATE INDEX idx_photos_taken_at ON photos(taken_at);
CREATE INDEX idx_photos_stage ON photos(stage);
CREATE INDEX idx_photos_area ON photos(area);
```

**问题：**
1. `area`和`trade`是否应该是外键？
2. 是否需要`deleted_at`（软删除）？
3. 是否需要`thumbnail_url`？

---

# Part 6：Receipt表设计（Phase 2）

## 建议的最小Receipt表

```sql
CREATE TABLE receipts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_id UUID NOT NULL REFERENCES jobs(id) ON DELETE CASCADE,
  file_url TEXT NOT NULL,
  file_size BIGINT,
  
  -- OCR结果
  amount DECIMAL(10, 2),
  vendor TEXT,
  receipt_date DATE,
  
  -- 分类
  category ENUM('project', 'overhead'),
  
  -- 原始OCR数据
  ocr_raw JSONB,
  
  uploaded_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_receipts_job_id ON receipts(job_id);
CREATE INDEX idx_receipts_date ON receipts(receipt_date);
CREATE INDEX idx_receipts_category ON receipts(category);
```

**问题：**
1. OCR字段是否合理？
2. 是否需要`verified`字段（人工确认）？
3. 金额精度是否足够？

---

# Part 7：Area / Trade管理

## 方案A：Job级枚举（推荐Phase 1）

不创建独立表，直接在Photo表用TEXT字段。

**优点：**
- 简单
- 灵活
- 无外键约束

**缺点：**
- 可能有拼写错误
- 难以统一命名

---

## 方案B：独立Area / Trade表

```sql
CREATE TABLE areas (
  id UUID PRIMARY KEY,
  job_id UUID NOT NULL REFERENCES jobs(id),
  name TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(job_id, name)
);

CREATE TABLE trades (
  id UUID PRIMARY KEY,
  job_id UUID NOT NULL REFERENCES jobs(id),
  name TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(job_id, name)
);
```

**优点：**
- 命名统一
- 可复用
- 可做自动补全

**缺点：**
- 增加复杂度
- 需要管理CRUD

---

**我们的建议：**  
Phase 1用方案A（TEXT字段），Phase 2再考虑方案B。

**你的意见？**

---

# Part 8：Trial / Billing状态

## 建议的User / Account表补充

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  
  -- Trial
  trial_start TIMESTAMP,
  trial_end TIMESTAMP,
  
  -- Subscription
  plan ENUM('free', 'core', 'core_plus_plan', 'core_plus_ledger', 'all'),
  subscription_start TIMESTAMP,
  subscription_end TIMESTAMP,
  
  created_at TIMESTAMP DEFAULT NOW()
);
```

**问题：**
1. Trial状态管理是否合理？
2. 是否需要独立的`subscriptions`表？
3. Add-on如何管理？

---

# Part 9：性能考虑

## Photo查询优化

Phase 1用户可能有：
- 10–50个Jobs
- 每个Job 50–500张照片

**关键查询：**
```sql
-- 查看Job内照片（按时间倒序）
SELECT * FROM photos 
WHERE job_id = ? 
ORDER BY taken_at DESC 
LIMIT 50 OFFSET 0;

-- 按Area筛选
SELECT * FROM photos 
WHERE job_id = ? AND area = ? 
ORDER BY taken_at DESC;
```

**问题：**
1. 是否需要分区（partitioning）？
2. 是否需要缓存层？
3. 图片是否需要CDN？

---

# Part 10：存储策略

## 文件存储

**建议：**
- 使用对象存储（S3 / GCS / R2）
- 按`job_id`组织目录结构
- 自动生成缩略图

**结构示例：**
```
/photos/{job_id}/{photo_id}.jpg
/photos/{job_id}/thumbs/{photo_id}_thumb.jpg
```

**问题：**
1. 是否需要多region？
2. 缩略图策略？
3. 删除策略（软删除 vs 物理删除）？

---

# Part 11：迁移策略（如果现有schema需要改）

## 如果需要调整现有schema

**建议步骤：**

1. **评估影响范围**
   - 哪些表需要改？
   - 有多少现有数据？

2. **创建迁移脚本**
   - 增量迁移
   - 可回滚

3. **测试环境验证**
   - 性能测试
   - 数据一致性

4. **生产环境部署**
   - 低峰期
   - 监控

---

# Part 12：CTO需要回答的核心问题

## 请你从架构与长期演进角度，帮我们判断：

### 1. Job / Project这个概念现在是不是立得足够干净？

- 现有Job表是否满足需求？
- 是否需要补充字段？
- 是否需要考虑多租户？

---

### 2. Photos和Receipts在数据层能不能共用一部分？

- 统一Attachment表 vs 独立表？
- 哪种方案更适合我们？
- 迁移成本如何？

---

### 3. 现在不做，会不会在SnapPocket上线时被迫重构？

- 哪些是"现在必须做对"的？
- 哪些是"可以后续迁移"的？
- 风险在哪里？

---

# Part 13：时间窗口（重要提醒）

## 为什么现在是最佳修正窗口

**现在是CTO最愿意"顺手修正"的窗口期。**

一旦Job Photos上线、开始有数据，任何schema变化的成本都会指数级上升。

**你现在找他，时机是100%正确的。**

---

# Part 14：期望的输出

## 希望CTO给出的明确答案：

### 1. Schema调整范围

- **需要调整：** 列出具体的表和字段
- **不需要调整：** 说明理由
- **建议新增：** 列出建议

### 2. 技术风险评估

- **P0风险：** 现在不做，以后很痛
- **P1风险：** 可以后续处理
- **P2风险：** 微不足道

### 3. 实施建议

- **时间：** 需要多久？
- **影响：** 是否影响现有功能？
- **回滚：** 如何保证安全？

---

# Part 15：会议流程建议

## 建议的讨论顺序

### 1. 快速对齐（5分钟）

- 确认产品方向理解一致
- 确认当前讨论范围

### 2. 核心问题讨论（20分钟）

- Job表设计
- Photo / Receipt统一 vs 分离
- Area / Trade管理方式

### 3. 决策与行动（10分钟）

- 明确需要调整什么
- 制定时间表
- 分配责任人

---

# Part 16：CPO的底线原则

## 我们的明确立场

### ✅ 可以接受：

- 适度的schema调整
- 合理的迁移成本
- 为长期架构做准备

### ❌ 不能接受：

- 为了"完美架构"延迟上线
- 过度设计导致复杂度失控
- 不可逆的方向性错误

---

# Part 17：如果CTO说"现在不需要改"

## 那我们需要确认：

1. **现有schema能支持Phase 1 + Phase 2？**
2. **哪些是"临时方案"，哪些是"长期设计"？**
3. **未来如果要改，触发条件是什么？**

---

# Part 18：如果CTO说"需要改"

## 那我们需要确认：

1. **改什么？改多少？**
2. **需要多久？**
3. **对Phase 1上线的影响？**
4. **是否可以分阶段改？**

---

## 💬 CPO给CTO的一句话

> **我们不需要一次性设计"完美架构"，但我们需要避免方向性错误。**
> 
> **请帮我们判断：哪些是现在必须做对的，哪些可以后续演进。**

---

**文档版本：** v1.0  
**发起人：** CPO  
**生效日期：** 2026-02-04  
**期望回复：** 48小时内

---

战略 → 架构对齐 = 高效执行！🚀

# SLG R2 åˆ†çº§å­˜å‚¨æ¶æ„ - å®Œæ•´å®æ–½æ–¹æ¡ˆ

**æ¶æ„è®¾è®¡**: COO (å®æˆ˜é€»è¾‘)  
**æŠ€æœ¯å®ç°**: CTO  
**é¡¹ç›®**: SLG (LedgerSnap + JobSiteSnap)

---

## ğŸ¯ ä¸‰å±‚ Bucket æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           SLG Storage System (R2)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ slg-receipts â”‚  slg-media   â”‚     slg-docs             â”‚
â”‚  (è´¢åŠ¡çœŸç›¸)   â”‚  (å·¥åœ°è¯æ®)   â”‚    (æ³•å¾‹è¯æ®)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ”¶æ®å›¾ç‰‡    â”‚ â€¢ å·¥åœ°ç…§ç‰‡    â”‚ â€¢ å·¥ç¨‹åˆçº¦                â”‚
â”‚ â€¢ ç”µå­è´¦å•    â”‚ â€¢ è¿›åº¦è§†é¢‘    â”‚ â€¢ Drawings (CAD/PDF)     â”‚
â”‚ â€¢ Invoice    â”‚ â€¢ å®Œå·¥ç…§ç‰‡    â”‚ â€¢ è®¸å¯è¯ä¹¦                â”‚
â”‚              â”‚              â”‚ â€¢ å˜æ›´å•                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Private      â”‚ Restricted   â”‚ Legal                    â”‚
â”‚ æé«˜æƒé™      â”‚ ä¸­ç­‰æƒé™      â”‚ æé«˜æƒé™                  â”‚
â”‚ 7å¹´ä¿å­˜(CRA) â”‚ 2å¹´åå†·å­˜å‚¨   â”‚ æ°¸ä¹…ä¿å­˜                  â”‚
â”‚ Gemini OCR  â”‚ å›¾ç‰‡å‹ç¼©      â”‚ ç‰ˆæœ¬æ§åˆ¶ + å…¨æ–‡æœç´¢        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ Bucket 1: slg-receipts (è´¢åŠ¡çœŸç›¸)

### å­˜å‚¨å†…å®¹
- LS è¯†åˆ«çš„æ”¶æ®å›¾ç‰‡
- ç”µå­è´¦å• PDF
- Credit card statements
- Vendor invoices

### æƒé™çº§åˆ«ï¼šæé«˜ (Private)
**COO é€»è¾‘**: è¿™æ˜¯"è´¢åŠ¡çœŸç›¸"ï¼ŒåŒ…å«æ•æ„Ÿä»·æ ¼å’Œæ”¯ä»˜ä¿¡æ¯ã€‚é™¤äº†è€æ¿å’Œä¼šè®¡ï¼Œä»»ä½•äººä¸èƒ½çœ‹ã€‚å¿…é¡»å¯ç”¨ä¸¥æ ¼çš„æƒé™æ§åˆ¶ã€‚

### æ–‡ä»¶ç»“æ„
```
slg-receipts/
â”œâ”€â”€ {org_id}/
â”‚   â”œâ”€â”€ {project_id}/
â”‚   â”‚   â””â”€â”€ receipts/
â”‚   â”‚       â”œâ”€â”€ 2026-01/
â”‚   â”‚       â”‚   â”œâ”€â”€ 1738000000-abc.jpg
â”‚   â”‚       â”‚   â””â”€â”€ ...
â”‚   â”‚       â””â”€â”€ 2026-02/
â”‚   â””â”€â”€ shared/  # è·¨é¡¹ç›®æ”¶æ®
â””â”€â”€ backups/  # æ¯æ—¥å¤‡ä»½
```

### ç¯å¢ƒå˜é‡
```bash
# .env.local
R2_RECEIPTS_BUCKET=slg-receipts
R2_RECEIPTS_ACCESS_KEY_ID=xxx
R2_RECEIPTS_SECRET_ACCESS_KEY=yyy
R2_RECEIPTS_ENDPOINT=https://xxx.r2.cloudflarestorage.com
R2_RECEIPTS_PUBLIC_URL=https://receipts.slg.app
```

---

## ğŸ“¸ Bucket 2: slg-media (å·¥åœ°è¯æ®)

### å­˜å‚¨å†…å®¹
- å·¥åœ°ç…§ç‰‡ (Before/During/After)
- è¿›åº¦è§†é¢‘
- é—®é¢˜è®°å½•ç…§ç‰‡

### æƒé™çº§åˆ«ï¼šä¸­ç­‰ (Restricted)
**COO é€»è¾‘**: æ–‡ä»¶å¤§ä¸”å¤šã€‚æœªæ¥å¯èƒ½éœ€è¦åˆ†äº«ç»™å®¢æˆ·çœ‹ (Client Portal)ã€‚ç‹¬ç«‹å‡ºæ¥æ–¹ä¾¿åš CDN åŠ é€Ÿï¼Œä¸å½±å“è´¢åŠ¡æ•°æ®çš„å®‰å…¨ã€‚

### æ–‡ä»¶ç»“æ„
```
slg-media/
â”œâ”€â”€ {org_id}/
â”‚   â”œâ”€â”€ {project_id}/
â”‚   â”‚   â”œâ”€â”€ progress/
â”‚   â”‚   â”‚   â”œâ”€â”€ 2026-W01/  # æŒ‰å‘¨
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ before/
â”‚   â”‚   â”œâ”€â”€ after/
â”‚   â”‚   â””â”€â”€ issues/
```

### ç‰¹æ®Šå¤„ç†
```typescript
// è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾
autoThumbnail: true
// CDN åŠ é€Ÿ
cdnEnabled: true
// 2å¹´åå†·å­˜å‚¨
archiveAfter: 730 days
```

---

## ğŸ“„ Bucket 3: slg-docs (æ³•å¾‹è¯æ®)

### å­˜å‚¨å†…å®¹
- å·¥ç¨‹åˆçº¦
- Drawings (å›¾çº¸ - æ”¯æŒç‰ˆæœ¬æ§åˆ¶)
- è®¸å¯è¯ä¹¦
- å˜æ›´å•
- éªŒæ”¶æŠ¥å‘Š

### æƒé™çº§åˆ«ï¼šæé«˜ (Legal)
**COO é€»è¾‘**: è¿™æ˜¯"æ³•å¾‹è¯æ®"ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸æ˜¯å¤šé¡µ PDF æˆ–å¤§å›¾ï¼Œéœ€è¦æ”¯æŒç‰ˆæœ¬ç®¡ç† (æ¯”å¦‚ Drawing V1, V2)ã€‚ç‹¬ç«‹å­˜å‚¨æ–¹ä¾¿æ—¥ååš"åˆåŒå®¡è®¡"ã€‚

### æ–‡ä»¶ç»“æ„ï¼ˆé‡ç‚¹ï¼šç‰ˆæœ¬æ§åˆ¶ï¼‰
```
slg-docs/
â”œâ”€â”€ {org_id}/
â”‚   â”œâ”€â”€ {project_id}/
â”‚   â”‚   â”œâ”€â”€ contracts/
â”‚   â”‚   â”œâ”€â”€ drawings/
â”‚   â”‚   â”‚   â”œâ”€â”€ architectural/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ floor-plan-v1.pdf
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ floor-plan-v2.pdf
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ floor-plan-v3.pdf  # â† Latest
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ metadata.json
â”‚   â”‚   â”‚   â”œâ”€â”€ structural/
â”‚   â”‚   â”‚   â””â”€â”€ electrical/
â”‚   â”‚   â”œâ”€â”€ permits/
â”‚   â”‚   â””â”€â”€ change-orders/
```

### ç‰ˆæœ¬æ§åˆ¶å…ƒæ•°æ®
```json
{
  "fileName": "floor-plan",
  "versions": [
    {
      "version": "v1",
      "uploadedAt": "2026-01-15T10:00:00Z",
      "uploadedBy": "user_123",
      "isLatest": false,
      "changeDescription": "Initial design"
    },
    {
      "version": "v3",
      "uploadedAt": "2026-02-01T14:30:00Z",
      "uploadedBy": "user_456",
      "isLatest": true,
      "changeDescription": "Kitchen layout revision"
    }
  ]
}
```

---

## ğŸ” æƒé™çŸ©é˜µ

| è§’è‰² | slg-receipts | slg-media | slg-docs |
|------|-------------|-----------|----------|
| **Owner** | âœ… Full | âœ… Full | âœ… Full |
| **Accountant** | âœ… Full | âŒ None | âœ… Read (Invoices) |
| **PM** | âŒ None | âœ… Full | âœ… Full |
| **Superintendent** | âŒ None | âœ… Upload + Read | âœ… Read (Drawings) |
| **Client** | âŒ None | âœ… Read (Progress) | âŒ None |

**COO éªŒè¯**: å¸¦ç­ç»ç†å¯ä»¥ä¸Šä¼ å·¥åœ°ç…§ç‰‡ï¼Œä½†ç»å¯¹ä¸åº”è¯¥æœ‰æƒé™çœ‹åˆ°æ”¶æ®é‡Œçš„ææ–™è¿›ä»·ã€‚âœ“

---

## ğŸš€ å®æ–½è®¡åˆ’

### Phase 1: MVP - slg-receipts (å½“å‰ - ç«‹å³)

```
ç›®æ ‡: LedgerSnap æ”¶æ®ä¸Šä¼ åŠŸèƒ½

æ­¥éª¤:
1. âœ… Cloudflare åˆ›å»º slg-receipts Bucket
2. âœ… åˆ›å»º API Token
3. âœ… é…ç½®ç¯å¢ƒå˜é‡
4. âœ… å®ç° receipts-client.ts
5. âœ… æ›´æ–° upload API
6. âœ… æµ‹è¯•ä¸Šä¼ 
```

### Phase 2: JSS Beta - slg-media (Week 4-5)

```
ç›®æ ‡: å·¥åœ°ç…§ç‰‡ä¸Šä¼ 

æ­¥éª¤:
1. åˆ›å»º slg-media Bucket
2. é…ç½® CDN åŠ é€Ÿ (media.slg.app)
3. å®ç°ç…§ç‰‡ä¸Šä¼  + è‡ªåŠ¨ç¼©ç•¥å›¾
4. å¸¦ç­ç»ç†æƒé™æµ‹è¯•
```

### Phase 3: JSS Full - slg-docs (Week 6-8)

```
ç›®æ ‡: æ–‡æ¡£ç®¡ç† + å›¾çº¸ç‰ˆæœ¬æ§åˆ¶

æ­¥éª¤:
1. åˆ›å»º slg-docs Bucket (å¯ç”¨ Versioning)
2. å®ç° Drawing ç‰ˆæœ¬æ§åˆ¶
3. PDF å…¨æ–‡æœç´¢
4. åˆçº¦å®¡è®¡åŠŸèƒ½
```

---

## ğŸ’» ä»£ç å®ç°

### åŸºç¡€ R2 å®¢æˆ·ç«¯

```typescript
// lib/r2/base-client.ts

import { S3Client } from '@aws-sdk/client-s3';
import { Upload } from '@aws-sdk/lib-storage';

export function createR2Client(config: {
  bucketName: string;
  endpoint: string;
  credentials: {
    accessKeyId: string;
    secretAccessKey: string;
  };
}) {
  const client = new S3Client({
    region: 'auto',
    endpoint: config.endpoint,
    credentials: config.credentials,
  });

  return {
    async upload(params: {
      key: string;
      body: Buffer;
      contentType?: string;
      metadata?: Record<string, string>;
    }) {
      const upload = new Upload({
        client,
        params: {
          Bucket: config.bucketName,
          Key: params.key,
          Body: params.body,
          ContentType: params.contentType,
          Metadata: params.metadata,
        },
      });

      await upload.done();

      return {
        url: `${config.endpoint}/${config.bucketName}/${params.key}`,
        key: params.key,
      };
    },

    // ... delete, list, etc.
  };
}
```

### slg-receipts ä¸“ç”¨å®¢æˆ·ç«¯

```typescript
// lib/r2/receipts.ts

import { createR2Client } from './base-client';

const receiptsClient = createR2Client({
  bucketName: process.env.R2_RECEIPTS_BUCKET!,
  endpoint: process.env.R2_RECEIPTS_ENDPOINT!,
  credentials: {
    accessKeyId: process.env.R2_RECEIPTS_ACCESS_KEY_ID!,
    secretAccessKey: process.env.R2_RECEIPTS_SECRET_ACCESS_KEY!,
  },
});

export async function uploadReceipt(params: {
  organizationId: string;
  projectId?: string;
  userId: string;
  file: Buffer;
  originalName: string;
  contentType: string;
}) {
  const { organizationId, projectId, userId, file, originalName, contentType } = params;

  // ç”Ÿæˆè·¯å¾„
  const month = new Date().toISOString().substring(0, 7); // 2026-01
  const timestamp = Date.now();
  const random = Math.random().toString(36).substring(2, 8);
  const ext = originalName.split('.').pop();
  const fileName = `${timestamp}-${random}.${ext}`;

  const path = projectId
    ? `${organizationId}/${projectId}/receipts/${month}/${fileName}`
    : `${organizationId}/shared/receipts/${month}/${fileName}`;

  // ä¸Šä¼ 
  const result = await receiptsClient.upload({
    key: path,
    body: file,
    contentType,
    metadata: {
      organizationId,
      projectId: projectId || 'shared',
      userId,
      originalName,
      uploadedAt: new Date().toISOString(),
      bucket: 'receipts',
    },
  });

  return result;
}
```

### slg-docs ç‰ˆæœ¬æ§åˆ¶

```typescript
// lib/r2/docs.ts

export async function uploadDrawing(params: {
  organizationId: string;
  projectId: string;
  category: 'architectural' | 'structural' | 'electrical';
  file: Buffer;
  fileName: string;
  changeDescription?: string;
}) {
  const { organizationId, projectId, category, file, fileName, changeDescription } = params;

  // æ£€æŸ¥ç°æœ‰ç‰ˆæœ¬
  const existingVersions = await listVersions({
    organizationId,
    projectId,
    category,
    fileName,
  });

  const newVersion = `v${existingVersions.length + 1}`;

  // æ ‡è®°æ—§ç‰ˆæœ¬ä¸ºéæœ€æ–°
  if (existingVersions.length > 0) {
    const latestVersion = existingVersions[0];
    await updateMetadata(latestVersion.key, {
      isLatest: 'false',
    });
  }

  // ä¸Šä¼ æ–°ç‰ˆæœ¬
  const key = `${organizationId}/${projectId}/drawings/${category}/${fileName}-${newVersion}.pdf`;

  return await docsClient.upload({
    key,
    body: file,
    contentType: 'application/pdf',
    metadata: {
      version: newVersion,
      isLatest: 'true',
      changeDescription: changeDescription || '',
      uploadedAt: new Date().toISOString(),
    },
  });
}
```

---

## ğŸ¨ ç»Ÿä¸€ UIï¼šæ–‡ä»¶æµè§ˆå™¨

```typescript
// components/project/FileExplorer.tsx

const BUCKETS = [
  {
    id: 'receipts',
    name: 'Financial Records',
    icon: 'ğŸ’°',
    roles: ['Owner', 'Accountant'],
    bucket: 'slg-receipts',
  },
  {
    id: 'media',
    name: 'Site Photos',
    icon: 'ğŸ“¸',
    roles: ['Owner', 'PM', 'Superintendent', 'Client'],
    bucket: 'slg-media',
  },
  {
    id: 'docs',
    name: 'Project Documents',
    icon: 'ğŸ“„',
    roles: ['Owner', 'PM'],
    bucket: 'slg-docs',
  },
];

export function FileExplorer() {
  const [activeTab, setActiveTab] = useState('receipts');
  const userRole = useUserRole();

  const visibleBuckets = BUCKETS.filter(b =>
    b.roles.includes(userRole)
  );

  return (
    <div className="file-explorer">
      <nav className="tabs">
        {visibleBuckets.map(bucket => (
          <button
            key={bucket.id}
            onClick={() => setActiveTab(bucket.id)}
            className={activeTab === bucket.id ? 'active' : ''}
          >
            {bucket.icon} {bucket.name}
          </button>
        ))}
      </nav>

      <main>
        <FileList bucket={activeTab} />
      </main>
    </div>
  );
}
```

**UI æ•ˆæœ**ï¼ˆè™½ç„¶ç‰©ç†ä¸Š 3 ä¸ª Bucketï¼Œä½†çœ‹èµ·æ¥åƒ 1 ä¸ªæ–‡ä»¶å¤¹ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’° Financial â”‚  January 2026                   â”‚
â”‚    Records   â”‚  â”œâ”€ Home Depot - $50.40        â”‚
â”‚              â”‚  â”œâ”€ Shell - $67.20             â”‚
â”‚ ğŸ“¸ Site      â”‚  â””â”€ Cactus Club - $89.60       â”‚
â”‚    Photos    â”‚                                 â”‚
â”‚              â”‚  [Upload] [Export CSV]         â”‚
â”‚ ğŸ“„ Documents â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° æˆæœ¬åˆ†æ

```
slg-receipts:
- å­˜å‚¨: 5GB (10,000 å¼ æ”¶æ®)
- æˆæœ¬: $0.075/æœˆ

slg-media:
- å­˜å‚¨: 50GB (ç…§ç‰‡ + è§†é¢‘)
- æˆæœ¬: $0.75/æœˆ
- CDN: ~$9/æœˆ

slg-docs:
- å­˜å‚¨: 10GB (PDF/CAD)
- æˆæœ¬: $0.15/æœˆ

æ€»è®¡: ~$10/æœˆ

å¯¹æ¯”å• Bucket æ··æ”¾:
- æˆæœ¬å‡ ä¹ç›¸åŒ
- ä½†å®‰å…¨æ€§å’Œç®¡ç†æ€§å¤§å¹…æå‡ âœ“
```

---

## âœ… COO é€»è¾‘éªŒè¯

### 1. æƒé™éš”ç¦» âœ“
```
å¸¦ç­ç»ç†ä¸Šä¼ å·¥åœ°ç…§ç‰‡ â†’ slg-media âœ“
ä½†çœ‹ä¸åˆ°æ”¶æ®è¿›ä»· â†’ slg-receipts æ‹’ç»è®¿é—® âœ“
```

### 2. ç”Ÿå‘½å‘¨æœŸç®¡ç† âœ“
```
æ”¶æ®ä¿å­˜ 7 å¹´ â†’ ç¬¦åˆ CRA è¦æ±‚ âœ“
å·¥åœ°ç…§ç‰‡ 2 å¹´åå†·å­˜å‚¨ â†’ èŠ‚çœæˆæœ¬ âœ“
æ–‡æ¡£æ°¸ä¹…ä¿å­˜ â†’ åˆåŒå®¡è®¡ âœ“
```

### 3. å¤„ç†é€»è¾‘åˆ†ç¦» âœ“
```
receipts â†’ Gemini OCR âœ“
media â†’ è‡ªåŠ¨å‹ç¼©ç¼©ç•¥å›¾ âœ“
docs â†’ å…¨æ–‡æœç´¢ + ç‰ˆæœ¬æ§åˆ¶ âœ“
```

### 4. Drawing ç‰ˆæœ¬æ§åˆ¶ âœ“
```
floor-plan-v1.pdf â†’ å½’æ¡£
floor-plan-v2.pdf â†’ å½’æ¡£
floor-plan-v3.pdf â†’ Latest (UI æ ‡è®°) âœ“
```

---

## ğŸ¯ ç«‹å³è¡ŒåŠ¨

### BOSS åšçš„ï¼š

```
1. Cloudflare Dashboard åˆ›å»º slg-receipts
2. åˆ›å»º API Token
3. ä¿å­˜å‡­è¯ä¿¡æ¯
4. é…ç½®ç¯å¢ƒå˜é‡
```

### CTO åšçš„ï¼š

```
1. åˆ›å»º lib/r2/receipts.ts
2. æ›´æ–° upload API
3. æµ‹è¯•ä¸Šä¼ åŠŸèƒ½
4. éªŒè¯æƒé™éš”ç¦»
```

---

**CTO æŠ¥å‘Šï¼šCOO çš„ä¸‰å±‚ Bucket æ¶æ„éå¸¸ä¸“ä¸šï¼å®Œå…¨ç¬¦åˆè´¢åŠ¡ã€æ³•å¾‹ã€è¿è¥çš„å®æˆ˜éœ€æ±‚ã€‚ç«‹å³å®æ–½ slg-receiptsï¼Œä¸ºæœªæ¥ JSS æ‰“å¥½åŸºç¡€ï¼** ğŸš€

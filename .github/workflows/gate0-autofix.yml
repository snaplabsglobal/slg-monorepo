name: Gate0 AutoFix (PR)

on:
  workflow_run:
    workflows: ["Gate 0 - Full Suite"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  autofix:
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR HEAD
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Setup pnpm (from packageManager)
        uses: pnpm/action-setup@v2
        # version is read from package.json#packageManager

      - name: Setup Node.js (from .nvmrc)
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Enable corepack
        run: corepack enable

      - name: Install
        run: pnpm -w install --frozen-lockfile

      - name: Run gate0:check (capture class)
        id: gate0check
        continue-on-error: true
        run: |
          set -e
          OUT=$(pnpm gate0:check 2>&1 | tee gate0.out.log)
          echo "$OUT"
          CLASS=$(echo "$OUT" | grep "\[GATE0_CLASS\]" | tail -n 1 | awk '{print $2}')
          echo "class=$CLASS" >> $GITHUB_OUTPUT

      - name: Upload Gate0 logs
        uses: actions/upload-artifact@v4
        with:
          name: gate0-telemetry
          path: |
            gate0.out.log
            .gate0-logs/*.log
            .gate0-telemetry/events.jsonl
          retention-days: 30

      - name: Auto-heal (whitelist classes only)
        if: >
          steps.gate0check.outputs.class == 'LOCKFILE_OUT_OF_SYNC' ||
          steps.gate0check.outputs.class == 'TS_NO_EXPORTED_MEMBER'
        run: pnpm gate0:selfheal

      - name: Verify only whitelisted files changed
        if: >
          steps.gate0check.outputs.class == 'LOCKFILE_OUT_OF_SYNC' ||
          steps.gate0check.outputs.class == 'TS_NO_EXPORTED_MEMBER'
        run: |
          set -e
          CHANGED=$(git diff --name-only)
          echo "Changed files: $CHANGED"
          echo "$CHANGED" | while read f; do
            [ -z "$f" ] && continue
            case "$f" in
              pnpm-lock.yaml|package.json|scripts/*) ;;
              apps/jss-web/app/components/*) ;;
              apps/jss-web/app/*/TestHarness*) ;;
              apps/jss-web/app/*/*/TestHarness*) ;;
              *) echo "BLOCKED: $f" && exit 1 ;;
            esac
          done

      - name: Commit & push
        if: >
          steps.gate0check.outputs.class == 'LOCKFILE_OUT_OF_SYNC' ||
          steps.gate0check.outputs.class == 'TS_NO_EXPORTED_MEMBER'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "gate0-autofix-bot"
            git config user.email "gate0-autofix-bot@users.noreply.github.com"
            git add -A
            git commit -m "chore(gate0): autofix ${{ steps.gate0check.outputs.class }}"
            git push
          fi

      - name: Stop if not whitelisted
        if: >
          steps.gate0check.outputs.class != 'OK' &&
          steps.gate0check.outputs.class != 'LOCKFILE_OUT_OF_SYNC' &&
          steps.gate0check.outputs.class != 'TS_NO_EXPORTED_MEMBER'
        run: |
          echo "Class not whitelisted: ${{ steps.gate0check.outputs.class }}"
          exit 1
